<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TronLink ç™»å…¥ - Agora Market (Adapter CDN)</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 500px;
      width: 100%;
      padding: 40px;
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 24px;
    }

    .subtitle {
      color: #666;
      font-size: 14px;
      margin-bottom: 30px;
    }

    .info-box {
      background: #f5f5f5;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .info-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .info-item:last-child {
      margin-bottom: 0;
    }

    .info-label {
      color: #666;
      font-weight: 500;
    }

    .info-value {
      color: #333;
      font-weight: 600;
    }

    .button {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 15px;
    }

    .button-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .button-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .status-box {
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .status-box.success {
      background: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #4caf50;
    }

    .status-box.error {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #f44336;
    }

    .status-box.info {
      background: #e3f2fd;
      color: #1976d2;
      border: 1px solid #2196f3;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React å’Œ ReactDOM (CDN) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- Babel Standalone (ç”¨äº JSX è½¬æ¢) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useMemo, createContext, useContext } = React;

    // ============================================
    // è½»é‡çº§ Wallet Adapter (CDN ç‰ˆæœ¬)
    // ============================================

    // Wallet Context
    const WalletContext = createContext(null);

    // è·å– TronWeb å®ä¾‹ï¼ˆæ”¯æŒæ–°æ—§ç‰ˆæœ¬ï¼‰
    function getTronWeb() {
      return window.tronWeb || window.tronLink?.tronWeb || null;
    }

    // æ£€æŸ¥æ˜¯å¦åœ¨ TronLink App å†…å»ºæµè§ˆå™¨
    function isTronLinkBrowser() {
      const tronWeb = getTronWeb();
      return tronWeb && tronWeb.ready && tronWeb.defaultAddress?.base58;
    }

    // æ£€æŸ¥ TronLink æ˜¯å¦å·²å®‰è£…
    function isTronLinkInstalled() {
      return !!(window.tronLink || window.tronWeb);
    }

    // Wallet Provider ç»„ä»¶
    function WalletProvider({ children, onError }) {
      const [wallet, setWallet] = useState(null);
      const [address, setAddress] = useState(null);
      const [connected, setConnected] = useState(false);
      const [connecting, setConnecting] = useState(false);
      const [error, setError] = useState(null);

      // æ£€æµ‹ TronLink
      useEffect(() => {
        const checkTronLink = () => {
          if (isTronLinkInstalled()) {
            setWallet('TronLink');
          }
        };

        checkTronLink();
        const interval = setInterval(checkTronLink, 100);
        setTimeout(() => clearInterval(interval), 5000);
      }, []);

      // è‡ªåŠ¨æ£€æµ‹è¿æ¥çŠ¶æ€
      useEffect(() => {
        if (!wallet) return;

        const checkConnection = () => {
          const tronWeb = getTronWeb();
          if (tronWeb && tronWeb.ready) {
            const addr = tronWeb.defaultAddress?.base58;
            if (addr && addr !== address) {
              setAddress(addr);
              setConnected(true);
              setError(null);
            }
          }
        };

        checkConnection();
        const interval = setInterval(checkConnection, 500);
        return () => clearInterval(interval);
      }, [wallet, address]);

      // é¡µé¢å¯è§æ€§æ£€æµ‹ï¼ˆä» TronLink App è¿”å›æ—¶ï¼‰
      useEffect(() => {
        const handleVisibilityChange = () => {
          if (!document.hidden && isTronLinkBrowser() && !connected) {
            setTimeout(() => {
              const tronWeb = getTronWeb();
              if (tronWeb && tronWeb.ready) {
                const addr = tronWeb.defaultAddress?.base58;
                if (addr) {
                  setAddress(addr);
                  setConnected(true);
                }
              }
            }, 500);
          }
        };

        document.addEventListener('visibilitychange', handleVisibilityChange);
        return () => document.removeEventListener('visibilitychange', handleVisibilityChange);
      }, [connected]);

      const connect = async () => {
        try {
          setConnecting(true);
          setError(null);

          if (!isTronLinkInstalled()) {
            throw new Error('æœªæ£€æµ‹åˆ° TronLinkï¼Œè¯·å…ˆå®‰è£… TronLink æ‰©å±•æˆ–ä½¿ç”¨ TronLink App');
          }

          // å¦‚æœå·²ç»åœ¨ TronLink æµè§ˆå™¨ä¸­
          if (isTronLinkBrowser()) {
            const tronWeb = getTronWeb();
            const addr = tronWeb.defaultAddress?.base58;
            if (addr) {
              setAddress(addr);
              setConnected(true);
              return;
            }
          }

          // ä½¿ç”¨æ–°ç‰ˆæœ¬ API
          if (window.tronLink) {
            const result = await window.tronLink.request({ 
              method: 'tron_requestAccounts' 
            });

            if (result.code === 200) {
              // ç­‰å¾… tronWeb æ³¨å…¥
              let tronWeb = getTronWeb();
              for (let i = 0; i < 30; i++) {
                if (tronWeb && tronWeb.ready) break;
                await new Promise(resolve => setTimeout(resolve, 100));
                tronWeb = getTronWeb();
              }

              if (tronWeb && tronWeb.ready) {
                const addr = tronWeb.defaultAddress?.base58;
                if (addr) {
                  setAddress(addr);
                  setConnected(true);
                } else {
                  throw new Error('æ— æ³•è·å–åœ°å€ï¼Œè¯·ç¡®ä¿å·²è§£é”é’±åŒ…');
                }
              } else {
                throw new Error('TronLink æœªå°±ç»ª');
              }
            } else if (result.code === 4001) {
              throw new Error('ç”¨æˆ·å·²æ‹’ç»æˆæƒ');
            } else {
              throw new Error(`è¿æ¥å¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}`);
            }
          } 
          // ä½¿ç”¨æ—§ç‰ˆæœ¬ API
          else if (window.tronWeb) {
            if (window.tronWeb.ready) {
              const addr = window.tronWeb.defaultAddress?.base58;
              if (addr) {
                setAddress(addr);
                setConnected(true);
              } else {
                throw new Error('è¯·å…ˆè§£é”é’±åŒ…');
              }
            } else {
              throw new Error('TronLink æœªå°±ç»ª');
            }
          }
        } catch (err) {
          const errorMsg = err.message || 'è¿æ¥å¤±è´¥';
          setError(errorMsg);
          if (onError) onError(err);
        } finally {
          setConnecting(false);
        }
      };

      const disconnect = () => {
        setAddress(null);
        setConnected(false);
        setError(null);
      };

      const signMessage = async (message) => {
        if (!connected || !address) {
          throw new Error('è¯·å…ˆè¿æ¥é’±åŒ…');
        }

        const tronWeb = getTronWeb();
        if (!tronWeb || !tronWeb.ready) {
          throw new Error('TronLink æœªå°±ç»ª');
        }

        try {
          // ä½¿ç”¨ TronWeb ç­¾åæ¶ˆæ¯
          const signedMessage = await tronWeb.trx.signMessage(message);
          return signedMessage;
        } catch (err) {
          throw new Error(`ç­¾åå¤±è´¥: ${err.message}`);
        }
      };

      const signTransaction = async (transaction) => {
        if (!connected || !address) {
          throw new Error('è¯·å…ˆè¿æ¥é’±åŒ…');
        }

        const tronWeb = getTronWeb();
        if (!tronWeb || !tronWeb.ready) {
          throw new Error('TronLink æœªå°±ç»ª');
        }

        try {
          const signedTx = await tronWeb.trx.sign(transaction);
          return signedTx;
        } catch (err) {
          throw new Error(`ç­¾åäº¤æ˜“å¤±è´¥: ${err.message}`);
        }
      };

      const value = {
        wallet,
        address,
        connected,
        connecting,
        error,
        connect,
        disconnect,
        signMessage,
        signTransaction,
      };

      return (
        <WalletContext.Provider value={value}>
          {children}
        </WalletContext.Provider>
      );
    }

    // useWallet Hook
    function useWallet() {
      const context = useContext(WalletContext);
      if (!context) {
        throw new Error('useWallet must be used within WalletProvider');
      }
      return context;
    }

    // ============================================
    // åº”ç”¨ç»„ä»¶
    // ============================================

    function WalletConnect() {
      const { 
        wallet, 
        address, 
        connected, 
        connecting, 
        error, 
        connect, 
        disconnect,
        signMessage 
      } = useWallet();

      const [signature, setSignature] = useState(null);
      const [signing, setSigning] = useState(false);

      // ä¸ Flutter é€šä¿¡
      useEffect(() => {
        if (connected && address) {
          // å‘é€äº‹ä»¶åˆ° Flutter
          if (window.flutter_inappwebview) {
            window.flutter_inappwebview.callHandler('walletEvent', {
              type: 'connected',
              address: address
            });
          }
          // æˆ–è€…ä½¿ç”¨ postMessage
          if (window.parent !== window) {
            window.parent.postMessage({
              type: 'wallet_connected',
              address: address
            }, '*');
          }
        }
      }, [connected, address]);

      const handleSignMessage = async () => {
        try {
          setSigning(true);
          setSignature(null);
          const sig = await signMessage('Hello from Agora Market!');
          setSignature(sig);
        } catch (err) {
          alert('ç­¾åå¤±è´¥: ' + err.message);
        } finally {
          setSigning(false);
        }
      };

      return (
        <div className="container">
          <h1>ğŸ”— TronLink è¿æ¥</h1>
          <p className="subtitle">ä½¿ç”¨è½»é‡çº§ Adapter (CDN ç‰ˆæœ¬)</p>

          <div className="info-box">
            <div className="info-item">
              <span className="info-label">é’±åŒ…:</span>
              <span className="info-value">{wallet || 'æ£€æµ‹ä¸­...'}</span>
            </div>
            <div className="info-item">
              <span className="info-label">çŠ¶æ€:</span>
              <span className="info-value">
                {connecting ? 'è¿æ¥ä¸­...' : connected ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}
              </span>
            </div>
            {address && (
              <div className="info-item">
                <span className="info-label">åœ°å€:</span>
                <span className="info-value">
                  {address.substring(0, 6)}...{address.substring(address.length - 4)}
                </span>
              </div>
            )}
          </div>

          {error && (
            <div className="status-box error">{error}</div>
          )}

          {connected && address && (
            <div className="status-box success">
              å·²è¿æ¥: {address}
            </div>
          )}

          {!wallet && (
            <div className="status-box info">
              æ­£åœ¨æ£€æµ‹é’±åŒ…...
            </div>
          )}

          {wallet && (
            <>
              {!connected ? (
                <button 
                  className="button button-primary" 
                  onClick={connect}
                  disabled={connecting}
                >
                  {connecting ? 'è¿æ¥ä¸­...' : 'è¿æ¥é’±åŒ…'}
                </button>
              ) : (
                <>
                  <button 
                    className="button" 
                    onClick={disconnect}
                  >
                    æ–­å¼€è¿æ¥
                  </button>
                  <button 
                    className="button button-primary" 
                    onClick={handleSignMessage}
                    disabled={signing}
                  >
                    {signing ? 'ç­¾åä¸­...' : 'ç­¾åæ¶ˆæ¯æµ‹è¯•'}
                  </button>
                  {signature && (
                    <div className="status-box success">
                      ç­¾åæˆåŠŸ: {signature.substring(0, 20)}...
                    </div>
                  )}
                </>
              )}
            </>
          )}
        </div>
      );
    }

    function App() {
      const handleError = (error) => {
        console.error('Wallet error:', error);
      };

      return (
        <WalletProvider onError={handleError}>
          <WalletConnect />
        </WalletProvider>
      );
    }

    // æ¸²æŸ“åº”ç”¨
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>

