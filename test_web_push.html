<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Push è¨‚é–±æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .info {
            color: #17a2b8;
            font-weight: bold;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .status.supported {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status.not-supported {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”” Web Push è¨‚é–±æ¸¬è©¦</h1>
        
        <div id="browserSupport" class="status">
            <h3>ç€è¦½å™¨æ”¯æ´æª¢æŸ¥</h3>
            <div id="supportStatus">æª¢æŸ¥ä¸­...</div>
        </div>

        <div id="permissionStatus" class="status">
            <h3>æ¬Šé™ç‹€æ…‹</h3>
            <div id="permissionInfo">æª¢æŸ¥ä¸­...</div>
        </div>

        <div id="subscriptionStatus" class="status">
            <h3>è¨‚é–±ç‹€æ…‹</h3>
            <div id="subscriptionInfo">æª¢æŸ¥ä¸­...</div>
        </div>

        <div class="actions">
            <h3>æ“ä½œ</h3>
            <button id="requestPermissionBtn" class="button" disabled>è«‹æ±‚é€šçŸ¥æ¬Šé™</button>
            <button id="subscribeBtn" class="button" disabled>è¨‚é–±æ¨é€é€šçŸ¥</button>
            <button id="unsubscribeBtn" class="button" disabled>å–æ¶ˆè¨‚é–±</button>
            <button id="testNotificationBtn" class="button" disabled>æ¸¬è©¦é€šçŸ¥</button>
            <button id="quickTestBtn" class="button">å¿«é€Ÿæ¸¬è©¦</button>
            <button id="checkStatusBtn" class="button">æª¢æŸ¥ç‹€æ…‹</button>
        </div>

        <div class="log-section">
            <h3>æ“ä½œæ—¥èªŒ</h3>
            <div id="log" class="log"></div>
            <button id="clearLogBtn" class="button">æ¸…é™¤æ—¥èªŒ</button>
        </div>
    </div>

    <!-- è¼‰å…¥çµ±ä¸€æ¨é€æ©‹æ¥å™¨ -->
    <script src="unified_push_bridge.js"></script>
    
    <script>
        // æ—¥èªŒåŠŸèƒ½
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        // æ¸…é™¤æ—¥èªŒ
        document.getElementById('clearLogBtn').onclick = function() {
            document.getElementById('log').innerHTML = '';
        };

        // æª¢æŸ¥ç€è¦½å™¨æ”¯æ´
        function checkBrowserSupport() {
            log('ğŸ” æª¢æŸ¥ç€è¦½å™¨æ”¯æ´...');
            
            if (!window.UnifiedPushManager) {
                log('âŒ UnifiedPushManager æœªè¼‰å…¥', 'error');
                document.getElementById('supportStatus').innerHTML = '<span class="error">âŒ çµ±ä¸€æ¨é€æ©‹æ¥å™¨æœªè¼‰å…¥</span>';
                document.getElementById('browserSupport').className = 'status not-supported';
                return false;
            }

            const isSupported = window.UnifiedPushManager.isSupported();
            if (isSupported) {
                log('âœ… ç€è¦½å™¨æ”¯æ´ Web Push', 'success');
                document.getElementById('supportStatus').innerHTML = '<span class="success">âœ… ç€è¦½å™¨æ”¯æ´ Web Push</span>';
                document.getElementById('browserSupport').className = 'status supported';
                return true;
            } else {
                log('âŒ ç€è¦½å™¨ä¸æ”¯æ´ Web Push', 'error');
                document.getElementById('supportStatus').innerHTML = '<span class="error">âŒ ç€è¦½å™¨ä¸æ”¯æ´ Web Push</span>';
                document.getElementById('browserSupport').className = 'status not-supported';
                return false;
            }
        }

        // æª¢æŸ¥æ¬Šé™ç‹€æ…‹
        async function checkPermissionStatus() {
            log('ğŸ” æª¢æŸ¥æ¬Šé™ç‹€æ…‹...');
            
            if (!window.UnifiedPushManager) {
                document.getElementById('permissionInfo').innerHTML = '<span class="error">âŒ æ©‹æ¥å™¨æœªè¼‰å…¥</span>';
                return;
            }

            const status = window.UnifiedPushManager.getPermissionStatus();
            log(`ğŸ“‹ ç•¶å‰æ¬Šé™ç‹€æ…‹: ${status}`);
            
            let statusText = '';
            let buttonState = false;
            
            switch (status) {
                case 'granted':
                    statusText = '<span class="success">âœ… å·²æˆæ¬Š</span>';
                    buttonState = true;
                    break;
                case 'denied':
                    statusText = '<span class="error">âŒ å·²æ‹’çµ•</span>';
                    buttonState = false;
                    break;
                case 'default':
                    statusText = '<span class="info">â³ æœªè«‹æ±‚</span>';
                    buttonState = true;
                    break;
            }
            
            document.getElementById('permissionInfo').innerHTML = statusText;
            document.getElementById('requestPermissionBtn').disabled = !buttonState;
        }

        // æª¢æŸ¥è¨‚é–±ç‹€æ…‹
        async function checkSubscriptionStatus() {
            log('ğŸ” æª¢æŸ¥è¨‚é–±ç‹€æ…‹...');
            
            if (!window.UnifiedPushManager) {
                document.getElementById('subscriptionInfo').innerHTML = '<span class="error">âŒ æ©‹æ¥å™¨æœªè¼‰å…¥</span>';
                return;
            }

            try {
                const result = await window.UnifiedPushManager.checkSubscriptionStatus();
                if (result.success) {
                    if (result.isSubscribed) {
                        log('âœ… å·²è¨‚é–±æ¨é€é€šçŸ¥', 'success');
                        document.getElementById('subscriptionInfo').innerHTML = '<span class="success">âœ… å·²è¨‚é–±</span>';
                        document.getElementById('subscribeBtn').disabled = true;
                        document.getElementById('unsubscribeBtn').disabled = false;
                        document.getElementById('testNotificationBtn').disabled = false;
                    } else {
                        log('â„¹ï¸ æœªè¨‚é–±æ¨é€é€šçŸ¥');
                        document.getElementById('subscriptionInfo').innerHTML = '<span class="info">â³ æœªè¨‚é–±</span>';
                        document.getElementById('subscribeBtn').disabled = false;
                        document.getElementById('unsubscribeBtn').disabled = true;
                        document.getElementById('testNotificationBtn').disabled = true;
                    }
                } else {
                    log(`âŒ æª¢æŸ¥è¨‚é–±ç‹€æ…‹å¤±æ•—: ${result.error}`, 'error');
                    document.getElementById('subscriptionInfo').innerHTML = `<span class="error">âŒ æª¢æŸ¥å¤±æ•—: ${result.error}</span>`;
                }
            } catch (error) {
                log(`âŒ æª¢æŸ¥è¨‚é–±ç‹€æ…‹ç•°å¸¸: ${error.message}`, 'error');
                document.getElementById('subscriptionInfo').innerHTML = `<span class="error">âŒ æª¢æŸ¥ç•°å¸¸: ${error.message}</span>`;
            }
        }

        // è«‹æ±‚æ¬Šé™
        document.getElementById('requestPermissionBtn').onclick = async function() {
            log('ğŸ”” è«‹æ±‚é€šçŸ¥æ¬Šé™...');
            
            try {
                const result = await window.UnifiedPushManager.requestPermission();
                log(`ğŸ“‹ æ¬Šé™è«‹æ±‚çµæœ: ${result}`);
                
                if (result === 'granted') {
                    log('âœ… é€šçŸ¥æ¬Šé™å·²æˆæ¬Š', 'success');
                } else if (result === 'denied') {
                    log('âŒ é€šçŸ¥æ¬Šé™è¢«æ‹’çµ•', 'error');
                } else {
                    log('â„¹ï¸ é€šçŸ¥æ¬Šé™è«‹æ±‚è¢«å–æ¶ˆ');
                }
                
                await checkPermissionStatus();
                await checkSubscriptionStatus();
            } catch (error) {
                log(`âŒ è«‹æ±‚æ¬Šé™å¤±æ•—: ${error.message}`, 'error');
            }
        };

        // è¨‚é–±æ¨é€
        document.getElementById('subscribeBtn').onclick = async function() {
            log('ğŸš€ é–‹å§‹è¨‚é–±æ¨é€é€šçŸ¥...');
            
            try {
                const result = await window.UnifiedPushManager.completePushSubscription();
                
                if (result.success) {
                    log('âœ… æ¨é€è¨‚é–±æˆåŠŸ', 'success');
                    if (result.isNew) {
                        log('ğŸ†• å‰µå»ºäº†æ–°è¨‚é–±');
                    } else {
                        log('ğŸ”„ ä½¿ç”¨ç¾æœ‰è¨‚é–±');
                    }
                } else {
                    log(`âŒ æ¨é€è¨‚é–±å¤±æ•—: ${result.error}`, 'error');
                }
                
                await checkSubscriptionStatus();
            } catch (error) {
                log(`âŒ è¨‚é–±æ¨é€ç•°å¸¸: ${error.message}`, 'error');
            }
        };

        // å–æ¶ˆè¨‚é–±
        document.getElementById('unsubscribeBtn').onclick = async function() {
            log('ğŸ”” å–æ¶ˆæ¨é€è¨‚é–±...');
            
            try {
                const result = await window.UnifiedPushManager.unsubscribeFromPush();
                
                if (result.success) {
                    log('âœ… æ¨é€è¨‚é–±å·²å–æ¶ˆ', 'success');
                } else {
                    log(`âŒ å–æ¶ˆè¨‚é–±å¤±æ•—: ${result.error}`, 'error');
                }
                
                await checkSubscriptionStatus();
            } catch (error) {
                log(`âŒ å–æ¶ˆè¨‚é–±ç•°å¸¸: ${error.message}`, 'error');
            }
        };

        // æ¸¬è©¦é€šçŸ¥
        document.getElementById('testNotificationBtn').onclick = function() {
            log('ğŸ”” ç™¼é€æ¸¬è©¦é€šçŸ¥...');
            
            const result = window.UnifiedPushManager.showLocalNotification(
                'æ¸¬è©¦é€šçŸ¥',
                'é€™æ˜¯ä¸€å€‹æ¸¬è©¦æ¨é€é€šçŸ¥',
                '/icons/Icon-192.png'
            );
            
            if (result) {
                log('âœ… æ¸¬è©¦é€šçŸ¥å·²ç™¼é€', 'success');
            } else {
                log('âŒ æ¸¬è©¦é€šçŸ¥ç™¼é€å¤±æ•—', 'error');
            }
        };

        // å¿«é€Ÿæ¸¬è©¦
        document.getElementById('quickTestBtn').onclick = async function() {
            log('ğŸ§ª é–‹å§‹å¿«é€Ÿæ¸¬è©¦...');
            
            try {
                const result = await window.UnifiedPushManager.quickTest();
                
                if (result.success) {
                    log('âœ… å¿«é€Ÿæ¸¬è©¦æˆåŠŸ', 'success');
                    log('ğŸ“‹ è¨‚é–±ä¿¡æ¯: ' + JSON.stringify(result.subscription, null, 2));
                } else {
                    log(`âŒ å¿«é€Ÿæ¸¬è©¦å¤±æ•—: ${result.error}`, 'error');
                }
                
                await checkSubscriptionStatus();
            } catch (error) {
                log(`âŒ å¿«é€Ÿæ¸¬è©¦ç•°å¸¸: ${error.message}`, 'error');
            }
        };

        // æª¢æŸ¥ç‹€æ…‹
        document.getElementById('checkStatusBtn').onclick = async function() {
            log('ğŸ”„ é‡æ–°æª¢æŸ¥æ‰€æœ‰ç‹€æ…‹...');
            await checkBrowserSupport();
            await checkPermissionStatus();
            await checkSubscriptionStatus();
        };

        // åˆå§‹åŒ–
        window.addEventListener('load', async function() {
            log('ğŸš€ é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–...');
            
            // ç­‰å¾…æ©‹æ¥å™¨è¼‰å…¥
            setTimeout(async function() {
                await checkBrowserSupport();
                await checkPermissionStatus();
                await checkSubscriptionStatus();
                
                log('âœ… åˆå§‹åŒ–å®Œæˆ');
            }, 1000);
        });
    </script>
</body>
</html>
