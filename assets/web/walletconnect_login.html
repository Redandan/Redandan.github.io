<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>連接錢包 - Agora Market</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 500px;
      width: 100%;
      padding: 40px;
      text-align: center;
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .status {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }

    .status.info {
      background: #e3f2fd;
      color: #1976d2;
      display: block;
    }

    .status.success {
      background: #e8f5e9;
      color: #388e3c;
      display: block;
    }

    .status.error {
      background: #ffebee;
      color: #d32f2f;
      display: block;
    }

    .status.warning {
      background: #fff3e0;
      color: #f57c00;
      display: block;
    }

    #qrcode {
      margin: 30px auto;
      padding: 20px;
      background: #f5f5f5;
      border-radius: 8px;
      display: none;
    }

    #qrcode canvas {
      max-width: 100%;
      height: auto;
    }

    .deep-link-btn {
      display: none;
      width: 100%;
      padding: 15px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 20px;
      transition: background 0.3s;
    }

    .deep-link-btn:hover {
      background: #5568d3;
    }

    .deep-link-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .wallet-info {
      margin-top: 20px;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 8px;
      display: none;
    }

    .wallet-address {
      font-family: monospace;
      font-size: 14px;
      color: #333;
      word-break: break-all;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
      vertical-align: middle;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error-details {
      margin-top: 10px;
      font-size: 12px;
      color: #999;
      text-align: left;
    }
  </style>
  <!-- QRCode.js for generating QR codes (local) -->
  <script src="qrcode.min.js"></script>
  <!-- WalletConnect Sign Client v2 (local) -->
  <script src="walletconnect-sign-client.js"></script>
</head>
<body>
  <div class="container">
    <h1>連接錢包</h1>
    <p class="subtitle">使用 WalletConnect 連接您的錢包以登入</p>

    <div id="status" class="status info">
      <span class="loading"></span>
      <span id="statusText">正在初始化...</span>
    </div>

    <div id="qrcode"></div>

    <button id="deepLinkBtn" class="deep-link-btn" onclick="openDeepLink()">
      在錢包中打開
    </button>

    <div id="walletInfo" class="wallet-info">
      <div>已連接錢包：</div>
      <div class="wallet-address" id="walletAddress"></div>
    </div>
  </div>

  <script>
    // 配置
    const CONFIG = {
      projectId: '7412eb629501759c091220ccc09ded23',
      apiBaseUrl: 'https://agoramarketapi.purrtechllc.com/api',
      supportedChains: ['eip155:1', 'eip155:137', 'eip155:56'], // Ethereum, Polygon, BSC
    };

    // 全局变量
    let signClient = null;
    let session = null;
    let currentUri = null;
    let nonceData = null;
    let SignClient = null; // WalletConnect SignClient

    // 等待脚本加载完成并获取 SignClient
    function waitForSignClient() {
      return new Promise((resolve, reject) => {
        // 检查是否已经加载
        const checkSignClient = () => {
          try {
            // UMD 构建将模块导出到 window['@walletconnect/sign-client']
            const wcModule = window['@walletconnect/sign-client'];
            if (wcModule) {
              // 根据 UMD 构建，SignClient 在 re.SignClient 和 re.default
              SignClient = wcModule.SignClient || wcModule.default;
              
              if (SignClient && typeof SignClient.init === 'function') {
                console.log('✅ SignClient 已找到');
                return SignClient;
              } else {
                console.warn('⚠️ SignClient 对象存在但没有 init 方法:', SignClient);
              }
            } else {
              console.log('⏳ 等待 WalletConnect 模块加载...');
            }
            return null;
          } catch (e) {
            console.error('检查 SignClient 时出错:', e);
            return null;
          }
        };

        // 立即检查一次
        const client = checkSignClient();
        if (client) {
          resolve(client);
          return;
        }

        // 如果还没加载，等待一下
        let attempts = 0;
        const maxAttempts = 100; // 等待最多 10 秒
        const checkInterval = setInterval(() => {
          attempts++;
          const client = checkSignClient();
          if (client) {
            clearInterval(checkInterval);
            resolve(client);
          } else if (attempts >= maxAttempts) {
            clearInterval(checkInterval);
            console.error('❌ SignClient 加载超时');
            console.error('可用的 window 对象:', Object.keys(window).filter(k => k.includes('wallet') || k.includes('connect') || k.includes('@')));
            if (window['@walletconnect/sign-client']) {
              console.error('模块内容:', Object.keys(window['@walletconnect/sign-client']));
            }
            reject(new Error('WalletConnect SignClient 加载超时。请检查 walletconnect-sign-client.js 是否正确加载。'));
          }
        }, 100);
      });
    }

    // 初始化
    async function init() {
      try {
        updateStatus('info', '正在初始化 WalletConnect...');
        
        // 等待 SignClient 加载
        await waitForSignClient();
        
        if (!SignClient) {
          throw new Error('SignClient 未找到，请检查 walletconnect-sign-client.js 是否正确加载');
        }
        
        // 初始化 Sign Client
        signClient = await SignClient.init({
          projectId: CONFIG.projectId,
          metadata: {
            name: 'Agora Market',
            description: 'Agora Market DApp',
            url: window.location.origin,
            icons: [window.location.origin + '/favicon.png']
          }
        });

        updateStatus('info', 'WalletConnect 初始化成功，請連接錢包');
        
        // 开始连接流程
        await connect();
      } catch (error) {
        console.error('初始化失败:', error);
        updateStatus('error', '初始化失败: ' + error.message);
        sendEventToFlutter('error', { error: error.message });
      }
    }

    // 连接钱包
    async function connect() {
      try {
        updateStatus('info', '正在生成連接請求...');

        const { uri, approval } = await signClient.connect({
          requiredNamespaces: {
            eip155: {
              methods: ['personal_sign', 'eth_signTypedData'],
              chains: CONFIG.supportedChains,
              events: ['chainChanged', 'accountsChanged']
            }
          }
        });

        if (uri) {
          currentUri = uri;
          // 显示 QR Code
          await showQRCode(uri);
          // 显示 Deep Link 按钮
          showDeepLinkButton(uri);
          // 发送事件到 Flutter
          sendEventToFlutter('uri_generated', { uri: uri });
          
          updateStatus('info', '請掃描 QR Code 或點擊按鈕在錢包中打開');
        }

        // 等待用户批准连接
        updateStatus('info', '等待錢包連接...');
        session = await approval();

        // 连接成功
        const walletAddress = getWalletAddress();
        if (walletAddress) {
          updateStatus('success', '錢包連接成功！');
          showWalletInfo(walletAddress);
          
          sendEventToFlutter('connected', { 
            walletAddress: walletAddress,
            session: session
          });

          // 继续登录流程
          await performLogin(walletAddress);
        }
      } catch (error) {
        console.error('連接失敗:', error);
        updateStatus('error', '連接失敗: ' + error.message);
        sendEventToFlutter('error', { error: error.message });
      }
    }

    // 获取钱包地址
    function getWalletAddress() {
      if (!session || !session.namespaces || !session.namespaces.eip155) {
        return null;
      }
      const accounts = session.namespaces.eip155.accounts;
      if (accounts && accounts.length > 0) {
        return accounts[0].split(':')[2];
      }
      return null;
    }

    // 显示 QR Code
    async function showQRCode(uri) {
      const qrcodeDiv = document.getElementById('qrcode');
      qrcodeDiv.style.display = 'block';
      
      try {
        // 清空之前的内容
        qrcodeDiv.innerHTML = '';
        
        // 使用 QRCode.js 库生成 QR Code
        // 注意：本地版本使用构造函数方式
        const qrcode = new QRCode(qrcodeDiv, {
          text: uri,
          width: 300,
          height: 300,
          colorDark: '#000000',
          colorLight: '#FFFFFF',
          correctLevel: QRCode.CorrectLevel.H
        });
      } catch (error) {
        console.error('生成 QR Code 失败:', error);
        qrcodeDiv.innerHTML = '<p>無法生成 QR Code: ' + error.message + '</p>';
      }
    }

    // 显示 Deep Link 按钮
    function showDeepLinkButton(uri) {
      const btn = document.getElementById('deepLinkBtn');
      btn.style.display = 'block';
      btn.setAttribute('data-uri', uri);
    }

    // 打开 Deep Link
    function openDeepLink() {
      if (currentUri) {
        const deepLink = currentUri.startsWith('wc:') ? currentUri : `wc:${currentUri.split('wc:')[1] || currentUri}`;
        window.location.href = deepLink;
        
        const btn = document.getElementById('deepLinkBtn');
        btn.disabled = true;
        btn.textContent = '正在打開錢包...';
      }
    }

    // 显示钱包信息
    function showWalletInfo(address) {
      const walletInfo = document.getElementById('walletInfo');
      const walletAddress = document.getElementById('walletAddress');
      walletInfo.style.display = 'block';
      walletAddress.textContent = address;
    }

    // 执行登录流程
    async function performLogin(walletAddress) {
      try {
        updateStatus('info', '正在獲取驗證信息...');

        // 1. 获取 nonce（根据新文档，使用 POST 方法）
        const nonceResponse = await fetch(`${CONFIG.apiBaseUrl}/auth/wallet-connect/nonce`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            walletAddress: walletAddress
          })
        });

        if (!nonceResponse.ok) {
          throw new Error('獲取 nonce 失敗: ' + nonceResponse.statusText);
        }

        nonceData = await nonceResponse.json();
        
        if (!nonceData.success) {
          throw new Error(nonceData.message || '獲取 nonce 失敗');
        }

        updateStatus('info', '請在錢包中簽名消息...');
        sendEventToFlutter('nonce_received', { nonce: nonceData.nonce });

        // 2. 签名消息
        const chainId = 'eip155:1'; // 使用 Ethereum Mainnet
        const account = session.namespaces.eip155.accounts[0];

        const signature = await signClient.request({
          topic: session.topic,
          chainId: chainId,
          request: {
            method: 'personal_sign',
            params: {
              message: nonceData.message,
              account: account
            }
          }
        });

        updateStatus('info', '簽名成功，正在驗證...');
        sendEventToFlutter('signature_received', {
          signature: signature,
          walletAddress: walletAddress
        });

        // 3. 验证签名并登录（根据新文档，使用 /auth/wallet-connect/login）
        const loginResponse = await fetch(`${CONFIG.apiBaseUrl}/auth/wallet-connect/login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            walletAddress: walletAddress,
            signature: signature,
            nonce: nonceData.nonce,
            timestamp: nonceData.timestamp
          })
        });

        if (!loginResponse.ok) {
          const errorData = await loginResponse.json();
          throw new Error(errorData.message || '登錄失敗: ' + loginResponse.statusText);
        }

        const loginData = await loginResponse.json();
        
        if (!loginData.success) {
          throw new Error(loginData.message || '登錄失敗');
        }

        // 登录成功
        updateStatus('success', '登入成功！');
        sendEventToFlutter('verified', {
          token: loginData.token,
          refreshToken: loginData.refreshToken,
          user: loginData.user
        });

      } catch (error) {
        console.error('登錄失敗:', error);
        updateStatus('error', '登錄失敗: ' + error.message);
        sendEventToFlutter('error', { error: error.message });
      }
    }


    // 更新状态显示
    function updateStatus(type, message) {
      const statusDiv = document.getElementById('status');
      const statusText = document.getElementById('statusText');
      
      // 移除所有状态类
      statusDiv.className = 'status';
      
      // 添加新的状态类
      statusDiv.classList.add(type);
      statusText.textContent = message;
    }

    // 发送事件到 Flutter
    function sendEventToFlutter(event, data) {
      try {
        // 尝试使用 flutter_inappwebview.callHandler
        if (window.flutter_inappwebview && window.flutter_inappwebview.callHandler) {
          window.flutter_inappwebview.callHandler('walletConnectEvent', {
            event: event,
            data: data
          });
        } else if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.walletConnectEvent) {
          // iOS WebKit
          window.webkit.messageHandlers.walletConnectEvent.postMessage({
            event: event,
            data: data
          });
        } else if (window.parent && window.parent.postMessage) {
          // 备用方案：使用 postMessage
          window.parent.postMessage({
            event: event,
            data: data
          }, '*');
        } else {
          console.log('Flutter handler not available, event:', event, data);
        }
      } catch (error) {
        console.error('发送事件到 Flutter 失败:', error);
      }
    }

    // 监听会话更新
    function setupSessionListeners() {
      if (!signClient) return;

      signClient.on('session_update', ({ topic, params }) => {
        console.log('Session updated:', params);
        if (session && session.topic === topic) {
          session = { ...session, ...params };
          const walletAddress = getWalletAddress();
          if (walletAddress) {
            sendEventToFlutter('session_updated', {
              walletAddress: walletAddress,
              session: session
            });
          }
        }
      });

      signClient.on('session_delete', ({ topic }) => {
        console.log('Session deleted:', topic);
        if (session && session.topic === topic) {
          session = null;
          sendEventToFlutter('session_disconnected', {});
          updateStatus('warning', '錢包連接已斷開');
        }
      });
    }

    // 页面加载完成后初始化
    window.addEventListener('DOMContentLoaded', async () => {
      await init();
      setupSessionListeners();
    });

    // 错误处理
    window.addEventListener('error', (event) => {
      console.error('全局错误:', event.error);
      updateStatus('error', '發生錯誤: ' + (event.error?.message || '未知錯誤'));
      sendEventToFlutter('error', { error: event.error?.message || '未知錯誤' });
    });

    // 未处理的 Promise 拒绝
    window.addEventListener('unhandledrejection', (event) => {
      console.error('未处理的 Promise 拒绝:', event.reason);
      updateStatus('error', '發生錯誤: ' + (event.reason?.message || '未知錯誤'));
      sendEventToFlutter('error', { error: event.reason?.message || '未知錯誤' });
    });
  </script>
</body>
</html>

