<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>連接錢包 - Agora Market</title>
  <link rel="stylesheet" href="walletconnect_login.css">
</head>
<body>
  <div class="container">
    <!-- 状态提示 -->
    <div id="status" class="status info" style="display: none;">
      <span class="loading"></span>
      <span id="statusText">正在初始化...</span>
    </div>

    <!-- 页面 1: 钱包选择器主页面 -->
    <div id="pageSelector" class="page active">
      <div class="page-header">
        <h1 class="page-title">Connect Your Wallet</h1>
        <p class="page-subtitle">連接你的錢包以繼續使用 Agora 社群商城</p>
        <p class="page-description">我們將用你的錢包地址建立安全登入。你不需要提供任何密碼。</p>
      </div>

      <!-- 已安裝的錢包 -->
      <div id="installedWalletsSection" style="display: none;">
        <div class="section-title">已安裝的錢包（推薦）</div>
        <div id="installedWalletsList" class="wallet-list"></div>
      </div>

      <!-- 手機錢包登入 -->
      <div id="mobileWalletsSection" style="display: none;">
        <div class="section-title">手機錢包登入</div>
        <div id="mobileWalletsList" class="wallet-list"></div>
      </div>


    </div>


    <!-- 页面 3: Deep Link 登录 -->
    <div id="pageDeepLink" class="page">
      <div class="page-header">
        <div class="deeplink-icon" id="deeplinkIcon"><img src="assets/icons/TronLink_icon.jpg" alt="TronLink" /></div>
        <h1 class="page-title" id="deeplinkTitle">正在打開 TronLink…</h1>
        <p class="page-subtitle" id="deeplinkSubtitle">如果沒有自動跳轉，請手動點擊下方按鈕。</p>
      </div>

      <div class="deeplink-container">
        <button class="deeplink-button" id="deeplinkButton" onclick="openDeepLinkApp()">
          打開 TronLink App
        </button>

        <div class="deeplink-download" id="deeplinkDownload" style="display: none;">
          沒有安裝 TronLink？ <a href="#" id="deeplinkDownloadLink" target="_blank">前往下載</a>
        </div>
      </div>

      <button class="back-button" onclick="showSelectorPage()">
        ← 返回錢包選擇器
      </button>
    </div>

    <!-- 钱包信息显示 -->
    <div id="walletInfo" class="wallet-info-display">
      <div>已連接錢包：</div>
      <div class="wallet-address" id="walletAddress"></div>
    </div>
  </div>

  <script>
    // 配置
    const CONFIG = {
      apiBaseUrl: 'https://agoramarketapi.purrtechllc.com/api',
    };

    // 日志级别控制
    const DEBUG = false;
    
    function debugLog(...args) {
      if (DEBUG) console.log(...args);
    }
    
    function debugError(...args) {
      console.error(...args);
    }
    
    function debugWarn(...args) {
      if (DEBUG) console.warn(...args);
    }

    // 全局变量
    let isTronLink = false;
    let tronWeb = null;
    let currentDeepLinkWallet = null;
    
    // PWA 环境检测
    function isPWAMode() {
      try {
        // 检测是否在 standalone 模式（PWA）
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
        const isFullscreen = window.matchMedia('(display-mode: fullscreen)').matches;
        const isMinimalUI = window.matchMedia('(display-mode: minimal-ui)').matches;
        // iOS Safari 特殊处理
        const isIOSStandalone = window.navigator.standalone === true;
        return isStandalone || isFullscreen || isMinimalUI || isIOSStandalone;
      } catch (e) {
        return false;
      }
    }
    
    // 检测是否在移动设备
    function isMobileDevice() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }
    
    // 授权状态管理（LocalStorage）
    const AuthStorage = {
      key: 'wallet_connect_auth',
      save: function(walletAddress, walletType, chain) {
        try {
          const data = {
            walletAddress,
            walletType,
            chain,
            timestamp: Date.now(),
            expiresAt: Date.now() + (7 * 24 * 60 * 60 * 1000) // 7天过期
          };
          localStorage.setItem(this.key, JSON.stringify(data));
        } catch (e) {
          debugWarn('保存授权状态失败:', e);
        }
      },
      load: function() {
        try {
          const data = localStorage.getItem(this.key);
          if (!data) return null;
          const auth = JSON.parse(data);
          if (auth.expiresAt && auth.expiresAt < Date.now()) {
            this.clear();
            return null;
          }
          return auth;
        } catch (e) {
          debugWarn('加载授权状态失败:', e);
          return null;
        }
      },
      clear: function() {
        try {
          localStorage.removeItem(this.key);
        } catch (e) {
          debugWarn('清除授权状态失败:', e);
        }
      }
    };

    // 钱包配置
    const WALLET_CONFIG = {
      installed: [
        { id: 'tronlink', name: 'TronLink', icon: 'assets/icons/TronLink_icon.jpg', type: 'tron', installUrl: 'https://www.tronlink.org/' },
      ],
      mobile: [
        { id: 'tronlink-app', name: 'TronLink App', icon: 'assets/icons/TronLink_icon.jpg', deepLink: 'tronlink://', type: 'tron', installUrl: 'https://www.tronlink.org/' },
      ]
    };

    // 页面切换
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });
      document.getElementById(pageId).classList.add('active');
    }

    function showSelectorPage() {
      showPage('pageSelector');
      hideStatus();
    }

    function showDeepLinkPage(wallet) {
      currentDeepLinkWallet = wallet;
      const page = document.getElementById('pageDeepLink');
      const deeplinkIconEl = document.getElementById('deeplinkIcon');
      
      // 检测 icon 是图片路径还是 emoji
      const isImagePath = wallet.icon && (wallet.icon.includes('.') || wallet.icon.startsWith('assets/') || wallet.icon.startsWith('/'));
      if (isImagePath) {
        deeplinkIconEl.innerHTML = `<img src="${wallet.icon}" alt="${wallet.name}" />`;
      } else {
        deeplinkIconEl.textContent = wallet.icon;
      }
      
      document.getElementById('deeplinkTitle').textContent = `正在打開 ${wallet.name}…`;
      document.getElementById('deeplinkButton').textContent = `打開 ${wallet.name} App`;
      
      // PWA 模式下的特殊提示
      const subtitleEl = document.getElementById('deeplinkSubtitle');
      if (isPWAMode() && (wallet.id === 'tronlink-app' || wallet.id === 'tronlink')) {
        subtitleEl.textContent = '如果沒有自動跳轉，請手動點擊下方按鈕打開 TronLink App。在 PWA 模式下，建議使用 TronLink 瀏覽器擴展以獲得最佳體驗。';
      } else {
        subtitleEl.textContent = '如果沒有自動跳轉，請手動點擊下方按鈕。';
      }
      
      if (wallet.installUrl) {
        document.getElementById('deeplinkDownload').style.display = 'block';
        document.getElementById('deeplinkDownloadLink').href = wallet.installUrl;
      } else {
        document.getElementById('deeplinkDownload').style.display = 'none';
      }
      showPage('pageDeepLink');
    }

    // 状态管理
    function updateStatus(type, message) {
      const statusDiv = document.getElementById('status');
      const statusText = document.getElementById('statusText');
      statusDiv.className = 'status ' + type;
      statusText.textContent = message;
      statusDiv.style.display = 'block';
    }

    function hideStatus() {
      document.getElementById('status').style.display = 'none';
    }

    // 检测已安装的钱包
    async function getInstalledWallets() {
      const installed = {};
      
      // 对于 TronLink，检测浏览器扩展
      const checkTronLink = async () => {
        // 立即检查 window.tronLink 对象（浏览器扩展会注入这个对象）
        if (window.tronLink) {
          debugLog('检测到 window.tronLink 对象');
          return true;
        }
        
        // 检查 window.tronWeb（新版本 TronLink）
        if (window.tronWeb) {
          debugLog('检测到 window.tronWeb');
          return true;
        }
        
        // 在 PWA/移动设备模式下，等待最多 2 秒让 TronLink 注入
        if (isPWAMode() || isMobileDevice()) {
          for (let i = 0; i < 20; i++) {
            if (window.tronLink || window.tronWeb) {
              debugLog('等待后检测到 TronLink (第 ' + (i + 1) + ' 次)');
              return true;
            }
            await new Promise((resolve) => setTimeout(resolve, 100));
          }
        }
        
        return false;
      };
      
      for (const wallet of WALLET_CONFIG.installed) {
        if (wallet.id === 'tronlink') {
          // TronLink 需要异步检测
          if (await checkTronLink()) {
            installed[wallet.id] = true;
            debugLog('TronLink 浏览器扩展已安装');
          }
        }
      }
      return installed;
    }

    // 渲染钱包列表
    function renderWalletButton(wallet, isInstalled = false) {
      const button = document.createElement('button');
      button.className = 'wallet-button';
      button.onclick = () => handleWalletClick(wallet, isInstalled);
      
      // 检测 icon 是图片路径还是 emoji
      const isImagePath = wallet.icon && (wallet.icon.includes('.') || wallet.icon.startsWith('assets/') || wallet.icon.startsWith('/'));
      const iconHtml = isImagePath 
        ? `<img src="${wallet.icon}" alt="${wallet.name}" />`
        : wallet.icon;
      
      button.innerHTML = `
        <div class="wallet-icon">${iconHtml}</div>
        <div class="wallet-info">
          <div class="wallet-name">
            ${wallet.name}
            ${isInstalled ? '<span class="wallet-badge">已安裝</span>' : ''}
          </div>
          ${wallet.type ? `<div class="wallet-type">${getWalletTypeText(wallet.type)}</div>` : ''}
        </div>
      `;
      
      return button;
    }

    function getWalletTypeText(type) {
      const types = {
        'extension': '瀏覽器擴充功能',
        'tron': 'Tron 錢包',
        'mobile': '手機錢包',
        'cold': '冷錢包'
      };
      return types[type] || '';
    }

    // 初始化钱包选择器
    async function initWalletSelector() {
      const installed = await getInstalledWallets();
      const installedList = WALLET_CONFIG.installed.filter(w => installed[w.id]);
      const isPWA = isPWAMode();
      const isMobile = isMobileDevice();
      
      // 渲染已安装的钱包
      if (installedList.length > 0) {
        const installedSection = document.getElementById('installedWalletsSection');
        const installedListEl = document.getElementById('installedWalletsList');
        installedListEl.innerHTML = '';
        installedList.forEach(wallet => {
          installedListEl.appendChild(renderWalletButton(wallet, true));
        });
        installedSection.style.display = 'block';
      }

      // 渲染手机钱包（PWA 模式下优先显示）
      const mobileSection = document.getElementById('mobileWalletsSection');
      const mobileListEl = document.getElementById('mobileWalletsList');
      mobileListEl.innerHTML = '';
      
      // 在 PWA 或移动设备上，优先显示 TronLink
      const mobileWallets = [...WALLET_CONFIG.mobile];
      if (isPWA || isMobile) {
        // 将 TronLink 移到最前面
        const tronLinkIndex = mobileWallets.findIndex(w => w.id === 'tronlink-app');
        if (tronLinkIndex > 0) {
          const tronLink = mobileWallets.splice(tronLinkIndex, 1)[0];
          mobileWallets.unshift(tronLink);
        }
      }
      
      mobileWallets.forEach(wallet => {
        mobileListEl.appendChild(renderWalletButton(wallet));
      });
      mobileSection.style.display = 'block';

    }

    // 检查是否在 TronLink App 内建浏览器
    function isTronLinkBrowser() {
      return Boolean(
        window.tronWeb &&
        window.tronWeb.ready &&
        window.tronWeb.defaultAddress &&
        window.tronWeb.defaultAddress.base58
      );
    }

    // 打开 TronLink App（使用真正的 deep link - SunSwap/JustMoney/SkySwap 方式）
    function openTronLinkApp() {
      const currentUrl = encodeURIComponent(window.location.href);
      const deeplink = `tronlink://open_url?url=${currentUrl}`;
      
      debugLog('Opening TronLink DeepLink:', deeplink);
      console.log('Opening TronLink DeepLink:', deeplink);
      
      // 直接打开 TronLink App（这是 SunSwap、JustMoney、SkySwap 等 TRON DApp 全部在用的方式）
      window.location.href = deeplink;
      
      // 如果 1500ms 没成功跳转，显示提示
      setTimeout(() => {
        const subtitleEl = document.getElementById('deeplinkSubtitle');
        if (subtitleEl) {
          subtitleEl.textContent = '似乎無法自動跳轉，請手動點擊下方按鈕，或確認是否已安裝 TronLink App。';
        }
      }, 1500);
    }

    // 处理钱包点击（整合完整流程）
    async function handleWalletClick(wallet, isInstalled) {
      try {
        debugLog('处理钱包点击:', wallet.id, 'isInstalled:', isInstalled);
        console.log('Clicked wallet:', wallet);
        
        // TronLink 处理逻辑
        if (wallet.id === 'tronlink-app' || wallet.id === 'tronlink') {
          // Case 1: 在手机，但不是 TronLink Browser → 必须 DeepLink
          if (isMobileDevice() && !isTronLinkBrowser()) {
            debugLog('手机设备且不在 TronLink Browser，使用 DeepLink');
            updateStatus('info', '正在打開 TronLink App...');
            showDeepLinkPage(wallet);
            
            // 延迟 500ms 后自动跳转（给用户看到提示）
            setTimeout(() => {
              openTronLinkApp();
            }, 500);
            return;
          }
          
          // Case 2: 已经检测到浏览器扩展（桌面浏览器）
          const installedWallets = await getInstalledWallets();
          const hasExtension = installedWallets['tronlink'];
          
          if (hasExtension) {
            debugLog('检测到 TronLink 浏览器扩展，直接连接');
            updateStatus('info', '檢測到 TronLink 瀏覽器擴展，正在連接...');
            await connectTronLink();
            return;
          }
          
          // Case 3: 已经在 TronLink Browser → 可直接 connect
          if (isTronLinkBrowser()) {
            debugLog('已在 TronLink Browser，直接连接');
            const address = await connectTronLinkMobile();
            if (address) {
              onWalletConnected(address, 'tronlink');
            }
            return;
          }
          
          // Case 4: PWA 模式，尝试 DeepLink
          if (isPWAMode()) {
            debugLog('PWA 模式，尝试 DeepLink');
            updateStatus('info', '正在打開 TronLink App...');
            showDeepLinkPage(wallet);
            setTimeout(() => {
              openTronLinkApp();
            }, 500);
            return;
          }
          
          // Case 5: 桌面浏览器，提示安装扩展
          updateStatus('error', '未檢測到 TronLink 瀏覽器擴展。請安裝 TronLink 瀏覽器擴展後重試。');
          const installUrl = wallet.installUrl || 'https://www.tronlink.org/';
          if (confirm('未檢測到 TronLink 擴展。是否前往下載頁面？')) {
            window.open(installUrl, '_blank');
          }
          return;
        }
        
        // 已安装的钱包 - 直接连接
        if (isInstalled) {
          if (wallet.type === 'tron') {
            await connectTronLink();
          }
          return;
        }
      } catch (error) {
        debugError('處理錢包點擊失敗:', error);
        updateStatus('error', '連接失敗: ' + error.message);
      }
    }
    
    // TronLink connect 程式碼（手機瀏覽器限定 - 簡化版）
    async function connectTronLinkMobile() {
      // 等待 TronLink Browser 注入（手機通常需要 100~500ms）
      for (let i = 0; i < 20; i++) {
        if (window.tronWeb && window.tronWeb.ready) break;
        await new Promise(res => setTimeout(res, 100));
      }
      
      if (!window.tronWeb || !window.tronWeb.defaultAddress || !window.tronWeb.defaultAddress.base58) {
        alert('尚未偵測到 TronLink，請使用 TronLink 內建瀏覽器打開本頁面。');
        return null;
      }
      
      const address = window.tronWeb.defaultAddress.base58;
      debugLog('Connected TronLink Address:', address);
      console.log('Connected TronLink Address:', address);
      return address;
    }
    
    // 成功後更新 UI
    function onWalletConnected(address, walletType) {
      const walletAddressEl = document.getElementById('walletAddress');
      const walletInfoEl = document.getElementById('walletInfo');
      
      if (walletAddressEl) {
        walletAddressEl.textContent = address;
      }
      if (walletInfoEl) {
        walletInfoEl.style.display = 'block';
      }
      
      hideStatus();
      
      // 保存授权状态
      if (isPWAMode()) {
        AuthStorage.save(address, walletType, 'TRON');
      }
      
      // 继续登录流程
      performLogin(address).catch(error => {
        debugError('登录失败:', error);
        updateStatus('error', '登錄失敗: ' + error.message);
      });
    }

    // 打开 Deep Link（按钮点击时调用）
    async function openDeepLinkApp() {
      if (!currentDeepLinkWallet) {
        updateStatus('error', '缺少連接信息');
        return;
      }
      
      // 使用真正的 deep link 打开 TronLink App
      openTronLinkApp();
    }


    function showWalletInfo(address) {
      const walletInfo = document.getElementById('walletInfo');
      const walletAddress = document.getElementById('walletAddress');
      walletInfo.style.display = 'block';
      walletAddress.textContent = address;
    }

    // 连接 TronLink（完整版，支持浏览器扩展和 TronLink Browser）
    async function connectTronLink() {
      try {
        // 如果已经在 TronLink Browser，使用简化版本
        if (isTronLinkBrowser()) {
          debugLog('已在 TronLink Browser，使用简化连接');
          const address = await connectTronLinkMobile();
          if (address) {
            onWalletConnected(address, 'tronlink');
            return;
          }
        }
        
        // 检查是否有保存的授权状态（仅在 PWA 模式下）
        if (isPWAMode()) {
          const savedAuth = AuthStorage.load();
          if (savedAuth && savedAuth.walletType === 'tronlink' && savedAuth.walletAddress) {
            debugLog('发现保存的授权状态，尝试自动重连...');
            updateStatus('info', '正在使用已保存的授權...');
            
            // 验证钱包是否仍然可用
            if (window.tronWeb || (window.tronLink && window.tronLink.tronWeb)) {
              try {
                // 尝试使用保存的地址直接登录（如果钱包仍然连接）
                await performLogin(savedAuth.walletAddress);
                return;
              } catch (e) {
                debugWarn('使用保存的授权失败，重新连接:', e);
                AuthStorage.clear();
              }
            }
          }
        }
        
        updateStatus('info', '正在連接 TronLink...');
        debugLog('開始連接 TronLink，當前狀態:', {
          hasTronWeb: !!window.tronWeb,
          hasTronLink: !!window.tronLink,
          hasTronLinkTronWeb: !!(window.tronLink && window.tronLink.tronWeb),
          isPWAMode: isPWAMode(),
          isTronLinkBrowser: isTronLinkBrowser()
        });
        
        // 方法1: 尝试直接通过 window.tronLink.request 连接（PWA 模式优先）
        if (window.tronLink && typeof window.tronLink.request === 'function') {
          try {
            debugLog('嘗試方法1: 通過 window.tronLink.request 連接...');
            const result = await window.tronLink.request({ method: 'tron_requestAccounts' });
            debugLog('window.tronLink.request 結果:', result);
            
            // 等待 tronWeb 注入（最多等待 3 秒）
            for (let i = 0; i < 30; i++) {
              if (window.tronWeb) {
                tronWeb = window.tronWeb;
                debugLog('通過 request 後檢測到 window.tronWeb');
                break;
              } else if (window.tronLink && window.tronLink.tronWeb) {
                tronWeb = window.tronLink.tronWeb;
                debugLog('通過 request 後檢測到 window.tronLink.tronWeb');
                break;
              }
              await new Promise((resolve) => setTimeout(resolve, 100));
            }
          } catch (e) {
            debugWarn('方法1 失敗:', e);
          }
        }
        
        // 方法2: 检测并等待 TronLink 注入（如果方法1未成功）
        if (!tronWeb) {
          debugLog('方法1 未成功，嘗試方法2: 等待 TronLink 注入...');
          const maxWaitTime = isPWAMode() ? 100 : 50; // PWA 模式下等待更久
          
          for (let i = 0; i < maxWaitTime; i++) {
            // 检查 window.tronWeb（新版本）
            if (window.tronWeb) {
              tronWeb = window.tronWeb;
              debugLog('方法2 檢測到 window.tronWeb (第 ' + (i + 1) + ' 次)');
              break;
            } 
            // 检查 window.tronLink.tronWeb（旧版本）
            else if (window.tronLink && window.tronLink.tronWeb) {
              tronWeb = window.tronLink.tronWeb;
              debugLog('方法2 檢測到 window.tronLink.tronWeb (第 ' + (i + 1) + ' 次)');
              break;
            }
            
            // 每 100ms 检查一次
            await new Promise((resolve) => setTimeout(resolve, 100));
          }
        }
        
        // 如果还是检测不到，在 PWA 模式下尝试最后一次
        if (!tronWeb && isPWAMode()) {
          debugLog('方法2 未成功，PWA 模式下嘗試最後一次...');
          // 尝试访问 window.tronLink 来触发注入
          try {
            if (window.tronLink) {
              // 尝试访问各种可能的属性来触发注入
              const _ = window.tronLink.tronWeb || window.tronLink.request || window.tronLink.isTronLink;
              await new Promise((resolve) => setTimeout(resolve, 500));
              
              if (window.tronWeb) {
                tronWeb = window.tronWeb;
                debugLog('最後一次嘗試成功: window.tronWeb');
              } else if (window.tronLink && window.tronLink.tronWeb) {
                tronWeb = window.tronLink.tronWeb;
                debugLog('最後一次嘗試成功: window.tronLink.tronWeb');
              }
            }
          } catch (e) {
            debugWarn('最後一次嘗試失敗:', e);
          }
        }
        
        if (!tronWeb) {
          debugError('所有方法都失敗，未檢測到 TronLink');
          if (isPWAMode() || isMobileDevice()) {
            throw new Error('未檢測到 TronLink。請確保已安裝並解鎖 TronLink 瀏覽器擴展，或使用 TronLink 手機 App。');
          }
          throw new Error('未檢測到 TronLink。請安裝 TronLink 瀏覽器擴展。');
        }

        // 等待 TronWeb 就绪
        if (!tronWeb.ready) {
          await new Promise((resolve, reject) => {
            const checkReady = setInterval(() => {
              if (tronWeb && tronWeb.ready) {
                clearInterval(checkReady);
                resolve();
              }
            }, 100);
            
            // 10 秒超时
            setTimeout(() => {
              clearInterval(checkReady);
              reject(new Error('TronLink 初始化超時'));
            }, 10000);
          });
        }

        isTronLink = true;

        // 请求账户连接
        let account = tronWeb.defaultAddress?.base58;
        
        if (!account) {
          try {
            if (tronWeb.request) {
              await tronWeb.request({
                method: 'tron_requestAccounts'
              });
            } else {
              // 兼容旧版本 TronLink
              await new Promise((resolve) => setTimeout(resolve, 500));
            }
            
            account = tronWeb.defaultAddress?.base58;
          } catch (e) {
            debugWarn('TronLink request 失败:', e);
            // 如果 request 失败，尝试直接获取
            account = tronWeb.defaultAddress?.base58;
          }
          
          if (!account) {
            throw new Error('用戶拒絕連接或未選擇賬戶');
          }
        }

        const walletAddress = account;
        updateStatus('success', 'TronLink 連接成功！');
        showWalletInfo(walletAddress);
        
        // 保存授权状态（仅在 PWA 模式下）
        if (isPWAMode()) {
          AuthStorage.save(walletAddress, 'tronlink', 'TRC20');
        }
        
        sendEventToFlutter('connected', { 
          walletAddress: walletAddress,
          isTronLink: true,
          chain: 'TRC20'
        });

        await performLogin(walletAddress);
      } catch (error) {
        debugError('連接 TronLink 失敗:', error);
        if (error.code === 4001 || 
            error.message?.includes('rejected') || 
            error.message?.includes('denied') ||
            error.message?.includes('拒絕')) {
          updateStatus('info', '已取消連接');
          return;
        }
        updateStatus('error', '連接失敗: ' + error.message);
        sendEventToFlutter('error', { error: error.message });
      }
    }


    // 登录流程
    async function performLogin(walletAddress) {
      try {
        updateStatus('info', '步驟 1/4: 獲取驗證信息');
        
        const nonceData = await getNonce(walletAddress);
        updateStatus('info', '步驟 2/4: 簽名消息');
        const signature = await signMessage(nonceData, walletAddress);
        updateStatus('info', '步驟 3/4: 驗證登錄');
        const loginData = await verifyAndLogin(walletAddress, signature, nonceData);
        await handleLoginSuccess(loginData);
      } catch (error) {
        handleLoginError(error);
      }
    }

    async function getNonce(walletAddress) {
      const nonceResponse = await fetch(`${CONFIG.apiBaseUrl}/auth/wallet-connect/nonce`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          walletAddress: walletAddress
        })
      });

      if (!nonceResponse.ok) {
        throw new Error('獲取 nonce 失敗: ' + nonceResponse.statusText);
      }

      const data = await nonceResponse.json();
      
      if (data.message && (!data.nonce || data.nonce === '')) {
        if (data.message.includes('Nonce:')) {
          const nonceMatch = data.message.match(/Nonce:\s*([^\n]+)/);
          if (nonceMatch && nonceMatch[1]) {
            data.nonce = nonceMatch[1].trim();
          }
        }
      }
      
      if (data.message && !data.timestamp) {
        if (data.message.includes('Timestamp:')) {
          const timestampMatch = data.message.match(/Timestamp:\s*([^\n]+)/);
          if (timestampMatch && timestampMatch[1]) {
            const timestamp = parseInt(timestampMatch[1].trim());
            if (!isNaN(timestamp)) {
              data.timestamp = timestamp;
            }
          }
        }
      }
      
      if (!data.message || data.message === '') {
        throw new Error('獲取 nonce 失敗：缺少 message 字段');
      }
      
      if (!data.nonce || data.nonce === '') {
        throw new Error('獲取 nonce 失敗：缺少 nonce 字段');
      }
      
      if (!data.timestamp) {
        data.timestamp = Math.floor(Date.now() / 1000);
      }

      sendEventToFlutter('nonce_received', { nonce: data.nonce });
      return data;
    }

    async function signMessage(nonceData, walletAddress) {
      updateStatus('info', '請在錢包中簽名消息...');

      if (isTronLink && tronWeb) {
        return await signWithTronLink(nonceData);
      } else {
        throw new Error('未找到可用的簽名方法。請使用 TronLink 連接。');
      }
    }

    // TronLink 签名
    async function signWithTronLink(nonceData) {
      try {
        if (!tronWeb || !tronWeb.ready) {
          if (isPWAMode()) {
            throw new Error('TronLink 未就緒。請確保 TronLink 擴展已正確安裝並已解鎖。');
          }
          throw new Error('TronLink 未就緒');
        }

        const account = tronWeb.defaultAddress?.base58;
        if (!account) {
          throw new Error('未找到 TronLink 賬戶');
        }

        let signature;
        
        // 优先使用 signMessageV2
        if (tronWeb.trx && typeof tronWeb.trx.signMessageV2 === 'function') {
          const timeoutPromise = new Promise((_, reject) => {
            setTimeout(() => {
              reject(new Error('簽名請求超時（60秒）'));
            }, 60000);
          });
          
          const signPromise = tronWeb.trx.signMessageV2(nonceData.message);
          const result = await Promise.race([signPromise, timeoutPromise]);
          
          signature = result.signature || result;
          
          // 处理签名结果
          if (typeof signature === 'object' && signature !== null) {
            signature = signature.signature || signature.result || JSON.stringify(signature);
          }
          
          if (typeof signature !== 'string') {
            signature = String(signature);
          }
          
          // 确保签名格式正确（添加 0x 前缀如果需要）
          if (signature && !signature.startsWith('0x') && /^[0-9a-fA-F]+$/.test(signature)) {
            signature = '0x' + signature;
          }
        } 
        // 使用 request 方法
        else if (tronWeb.request && typeof tronWeb.request === 'function') {
          const result = await tronWeb.request({
            method: 'tron_signMessage',
            params: {
              message: nonceData.message,
              address: account
            }
          });
          
          signature = result.signature || result;
          
          if (typeof signature === 'object' && signature !== null) {
            signature = signature.signature || signature.result || JSON.stringify(signature);
          }
          
          if (typeof signature !== 'string') {
            signature = String(signature);
          }
          
          // 确保签名格式正确
          if (signature && !signature.startsWith('0x') && /^[0-9a-fA-F]+$/.test(signature)) {
            signature = '0x' + signature;
          }
        } 
        // 如果都不支持，抛出错误
        else {
          throw new Error('TronLink 簽名方法不可用。請確保使用最新版本的 TronLink。');
        }
        
        if (!signature || signature.length === 0) {
          throw new Error('簽名結果為空');
        }
        
        return signature;
      } catch (signError) {
        if (signError.code === 4001 || 
            signError.message?.includes('rejected') || 
            signError.message?.includes('denied') || 
            signError.message?.includes('User rejected') ||
            signError.message?.includes('User cancel') ||
            signError.message?.includes('cancelled')) {
          updateStatus('info', '簽名已取消');
          sendEventToFlutter('error', { error: '用戶取消簽名' });
          throw new Error('USER_CANCELLED');
        }
        debugError('❌ TronLink 签名失败:', signError);
        throw signError;
      }
    }


    async function verifyAndLogin(walletAddress, signature, nonceData) {
      updateStatus('info', '簽名成功，正在驗證...');
      
      sendEventToFlutter('signature_received', {
        signature: signature,
        walletAddress: walletAddress
      });
      
      const requestBody = {
        walletAddress: walletAddress,
        signature: signature,
        nonce: nonceData.nonce,
        timestamp: nonceData.timestamp
      };
      
      if (isTronLink) {
        requestBody.chain = 'TRC20';
        requestBody.chainType = 'tron';
      }
      
      const loginResponse = await fetch(`${CONFIG.apiBaseUrl}/auth/wallet-connect/login`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestBody)
      });

      if (!loginResponse.ok) {
        const errorData = await loginResponse.json().catch(() => ({ message: loginResponse.statusText }));
        debugError('❌ 登录失败:', errorData);
        throw new Error(errorData.message || '登錄失敗: ' + loginResponse.statusText);
      }

      const loginData = await loginResponse.json();
      
      if (!loginData.token || !loginData.refreshToken) {
        debugError('❌ 登录响应中缺少 token');
        throw new Error(loginData.message || '登錄響應中缺少 token');
      }

      return loginData;
    }

    async function handleLoginSuccess(loginData) {
      updateStatus('success', '登入成功！');
      
      sendEventToFlutter('verified', {
        token: loginData.token,
        refreshToken: loginData.refreshToken,
        user: loginData.user
      });
    }

    function handleLoginError(error) {
      if (error.message === 'USER_CANCELLED') {
        return;
      }
      
      debugError('❌ 登录失败:', error);
      
      const userFriendlyMessages = {
        'timeout': '操作超时，请重试',
        'network': '网络错误，请检查连接',
        'User rejected': '您已取消操作'
      };
      
      const message = userFriendlyMessages[error.message] || error.message || '发生未知错误';
      updateStatus('error', '登錄失敗: ' + message);
      sendEventToFlutter('error', { error: message });
    }

    function sendEventToFlutter(event, data) {
      try {
        const isInIframe = window.self !== window.top;
        
        if (isInIframe && window.parent && window.parent.postMessage) {
          window.parent.postMessage({
            event: event,
            data: data
          }, window.location.origin);
        } else if (window.flutter_inappwebview && window.flutter_inappwebview.callHandler) {
          window.flutter_inappwebview.callHandler('walletConnectEvent', {
            event: event,
            data: data
          });
        } else if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.walletConnectEvent) {
          window.webkit.messageHandlers.walletConnectEvent.postMessage({
            event: event,
            data: data
          });
        }
      } catch (error) {
        debugError('❌ 发送事件到 Flutter 失败:', error);
      }
    }

    // 初始化
    async function init() {
      try {
        updateStatus('info', '正在檢測可用錢包...');
        
        // 在 PWA 模式下，检查是否有保存的授权状态
        if (isPWAMode()) {
          const savedAuth = AuthStorage.load();
          if (savedAuth) {
            debugLog('PWA 模式下发现保存的授权:', savedAuth);
            // 不自动重连，让用户选择，但可以提示
            updateStatus('info', '檢測到已保存的授權，請選擇連接方式...');
          }
        }
        
        // 初始化钱包选择器
        await initWalletSelector();
        
        hideStatus();
      } catch (error) {
        debugError('初始化失败:', error);
        updateStatus('error', '初始化失败: ' + error.message);
        sendEventToFlutter('error', { error: error.message });
      }
    }

    // 监听 TronLink 注入事件
    function setupTronLinkListener() {
      // 定期检查 TronLink 注入（作为备用方案）
      if (isPWAMode()) {
        const checkInterval = setInterval(() => {
          if (window.tronWeb && !tronWeb) {
            debugLog('定期檢查發現 TronLink (window.tronWeb)');
            tronWeb = window.tronWeb;
          } else if (window.tronLink && window.tronLink.tronWeb && !tronWeb) {
            debugLog('定期檢查發現 TronLink (window.tronLink.tronWeb)');
            tronWeb = window.tronLink.tronWeb;
          }
        }, 500);
        
        // 30 秒后清除
        setTimeout(() => clearInterval(checkInterval), 30000);
      }
    }
    
    // 页面加载完成后初始化
    window.addEventListener('DOMContentLoaded', async () => {
      setupTronLinkListener();
      await init();
    });

    // 错误处理
    window.addEventListener('error', (event) => {
      debugError('全局错误:', event.error);
      updateStatus('error', '發生錯誤: ' + (event.error?.message || '未知錯誤'));
      sendEventToFlutter('error', { error: event.error?.message || '未知錯誤' });
    });

    window.addEventListener('unhandledrejection', (event) => {
      debugError('未处理的 Promise 拒绝:', event.reason);
      updateStatus('error', '發生錯誤: ' + (event.reason?.message || '未知錯誤'));
      sendEventToFlutter('error', { error: event.reason?.message || '未知錯誤' });
    });
  </script>
</body>
</html>
