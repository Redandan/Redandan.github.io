<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Game</title>
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; overflow: hidden; background: #010010; }

    /* ── Loading screen ──────────────────────────────────────────────────── */
    #loading-screen {
      position: fixed; inset: 0; display: flex; flex-direction: column;
      align-items: center; justify-content: center; background: #010010; z-index: 100;
    }
    #loading-title {
      color: #c0ccff; font-family: Arial, sans-serif; font-size: 20px;
      font-weight: bold; letter-spacing: 3px; margin-bottom: 32px;
    }
    #loading-bar-track {
      width: 240px; height: 6px; background: rgba(192,204,255,0.15);
      border-radius: 3px; overflow: hidden;
    }
    #loading-bar {
      height: 100%; width: 0%; background: #5560c8;
      border-radius: 3px; transition: width 0.3s ease;
    }
    #loading-status {
      color: rgba(192,204,255,0.5); font-family: Arial, sans-serif;
      font-size: 12px; letter-spacing: 1px; margin-top: 12px;
    }

    /* ── Game root ───────────────────────────────────────────────────────── */
    #game-root {
      position: fixed; inset: 0; display: flex; flex-direction: column;
      background: linear-gradient(180deg, #0d0535 0%, #130848 14%, #0e062e 30%,
                                          #0a0428 52%, #080320 72%, #050218 100%);
      font-family: Arial, sans-serif; color: #fff;
    }

    /* ── HUD ─────────────────────────────────────────────────────────────── */
    #hud {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 16px; flex-shrink: 0;
    }
    #btn-back {
      width: 52px; height: 52px; border: none; border-radius: 50%;
      background: rgba(192,204,255,0.12); color: #c0ccff; font-size: 20px;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
    }
    #btn-back:active { background: rgba(192,204,255,0.25); }
    #balance-label { color: rgba(192,204,255,0.6); font-size: 12px; letter-spacing: 1px; }
    #balance { color: #fff; font-size: 22px; font-weight: bold; letter-spacing: 1px; }
    #win-amount { color: #ffd700; font-size: 18px; font-weight: bold; min-height: 28px; }

    /* ── Game canvas area ────────────────────────────────────────────────── */
    #game-canvas {
      flex: 1; display: flex; align-items: center; justify-content: center;
      color: rgba(192,204,255,0.4); font-size: 14px; letter-spacing: 2px;
    }

    /* ── Controls ────────────────────────────────────────────────────────── */
    #controls {
      display: flex; align-items: center; justify-content: center;
      gap: 12px; padding: 16px; flex-shrink: 0;
    }
    #controls button {
      border: none; border-radius: 8px; cursor: pointer;
      font-size: 14px; font-weight: bold; letter-spacing: 1px;
    }
    #btn-bet-down, #btn-bet-up {
      width: 40px; height: 40px; background: rgba(192,204,255,0.12); color: #c0ccff;
    }
    #bet-display {
      min-width: 80px; text-align: center; color: #c0ccff;
      font-size: 16px; font-weight: bold;
    }
    #btn-spin {
      width: 120px; height: 52px; background: #5560c8; color: #fff; font-size: 16px;
      border-radius: 12px;
    }
    #btn-spin:disabled { opacity: 0.5; cursor: not-allowed; }
    #btn-spin:active:not(:disabled) { background: #4450b8; }
  </style>
</head>
<body>

  <!-- ── Loading screen (Game Runtime shows this while fetching assets) ── -->
  <div id="loading-screen">
    <div id="loading-title">載入中…</div>
    <div id="loading-bar-track"><div id="loading-bar"></div></div>
    <div id="loading-status">初始化遊戲引擎</div>
  </div>

  <!-- ── Game root (hidden until runtime signals ready) ─────────────────── -->
  <div id="game-root" hidden>
    <!-- HUD: back button + balance + win display -->
    <div id="hud">
      <button id="btn-back" aria-label="返回">←</button>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:2px">
        <div id="balance-label">餘額</div>
        <div id="balance">¥0</div>
      </div>
      <div id="win-amount"></div>
    </div>

    <!-- Game canvas: game.js renders content here -->
    <div id="game-canvas">遊戲畫面</div>

    <!-- Bottom controls: bet selector + spin button -->
    <div id="controls">
      <button id="btn-bet-down">－</button>
      <div id="bet-display">¥100</div>
      <button id="btn-bet-up">＋</button>
      <button id="btn-spin">旋轉</button>
    </div>
  </div>

  <!-- ── Shared Flutter ↔ WebView bridge (must load before runtime script) ── -->
  <script src="../_runtime/flutter_bridge.js"></script>

  <script>
  /* ══════════════════════════════════════════════════════════════════════════
   * Game Runtime  (JS Engine layer — shared across all games using this template)
   *
   * Responsibilities:
   *   1. Read window._gameConfig injected by the Flutter Shell (Dart)
   *   2. Fetch manifest.json and merge with Flutter config
   *   3. Load assets listed in manifest with a progress bar
   *   4. Manage the Flutter ↔ WebView communication bridge
   *   5. Manage game lifecycle (init → ready → running → destroy)
   *   6. Expose window._gameEngine for the Game Implementation (game.js)
   *   7. Expose window.cancelAutoSpin for Flutter evaluateJavascript
   * ════════════════════════════════════════════════════════════════════════ */
  (function () {
    'use strict';

    // ── 1. Flutter-injected config (set by Dart before page load) ──────────
    // window._gameConfig is written by Dart via evaluateJavascript /
    // initialUserScripts before the page script runs on native builds.
    // On web it may be injected by the parent window via postMessage or left
    // as undefined; default to an empty object so all later merges are safe.
    const flutterConfig = (typeof window._gameConfig === 'object' && window._gameConfig !== null)
      ? window._gameConfig
      : {};

    // ── 2. Loading UI helpers ───────────────────────────────────────────────
    const loadingScreen = document.getElementById('loading-screen');
    const loadingBar    = document.getElementById('loading-bar');
    const loadingStatus = document.getElementById('loading-status');
    const gameRoot      = document.getElementById('game-root');
    const loadingTitle  = document.getElementById('loading-title');

    function setProgress(fraction, statusText) {
      if (loadingBar)    loadingBar.style.width  = Math.round(fraction * 100) + '%';
      if (loadingStatus) loadingStatus.textContent = statusText || '';
    }

    function showGame(title) {
      if (loadingTitle) loadingTitle.textContent = title || 'Game';
      loadingScreen.hidden = true;
      gameRoot.hidden      = false;
    }

    // ── 3. Flutter Bridge ───────────────────────────────────────────────────
    // Shared bridge loaded from ../_runtime/flutter_bridge.js.
    // Platform routing: callHandler('goBack') [iOS] / flutter://goback [Android]
    //                   postMessage [Flutter Web iframe] / history.back() [mobile browser]
    const bridge = window._flutterBridge;

    // ── 4. Auto-spin state (managed by runtime so Flutter can cancel it) ────
    let _autoSpin = false;

    // ── 5. Build the engine object exposed to game.js ──────────────────────
    const engine = {
      /** Merged game config: manifest.config overridden by flutterConfig. */
      config: {},

      /** Parsed manifest.json (available after init). */
      manifest: null,

      /** Flutter ↔ WebView communication bridge. */
      bridge,

      /** Enable or disable auto-spin mode. */
      setAutoSpin(enabled) { _autoSpin = !!enabled; },

      /** Returns true when auto-spin is currently active. */
      isAutoSpin() { return _autoSpin; },

      /**
       * Cancels auto-spin if it is active.
       * Returns true if auto-spin was running (and is now cancelled),
       * false if it was already off.
       * Also exposed as window.cancelAutoSpin so Flutter can call it via
       * evaluateJavascript without knowing about the engine object.
       */
      cancelAutoSpin() {
        if (!_autoSpin) return false;
        _autoSpin = false;
        return true;
      },
    };

    // Expose cancelAutoSpin at window level for Flutter evaluateJavascript:
    //   _webViewController?.evaluateJavascript(
    //     source: 'window.cancelAutoSpin ? window.cancelAutoSpin() : false')
    window.cancelAutoSpin = () => engine.cancelAutoSpin();

    // Make engine available to game.js.
    window._gameEngine = engine;

    // ── 6. Asset loader ─────────────────────────────────────────────────────
    async function loadAssets(urls, cdnBase) {
      if (!urls || urls.length === 0) return;
      let done = 0;
      const resolveUrl = (u) =>
        (cdnBase && !u.startsWith('http') && !u.startsWith('/'))
          ? cdnBase.replace(/\/$/, '') + '/' + u
          : u;
      await Promise.all(
        urls.map((url) =>
          fetch(resolveUrl(url)).then((res) => {
            if (!res.ok) console.warn('[GameRuntime] asset load HTTP error', res.status, url);
            done++;
            setProgress(0.1 + (done / urls.length) * 0.8, `載入資源 ${done}/${urls.length}`);
          }).catch((err) => {
            // Non-fatal: count failed asset as done so progress still advances.
            console.warn('[GameRuntime] asset load failed (skipped):', url, err);
            done++;
            setProgress(0.1 + (done / urls.length) * 0.8, `資源 ${done}/${urls.length} (略過)`);
          })
        )
      );
    }

    // ── 7. Init ─────────────────────────────────────────────────────────────
    async function init() {
      try {
        setProgress(0, '讀取遊戲設定');

        // Fetch manifest.json from the same directory as index.html.
        const resp = await fetch('manifest.json');
        if (!resp.ok) throw new Error('manifest.json fetch failed: ' + resp.status);
        const manifest = await resp.json();
        engine.manifest = manifest;

        // Merge config: manifest defaults < flutter-injected overrides.
        engine.config = Object.assign({}, manifest.config || {}, flutterConfig);

        // Update loading title to the game's actual title.
        if (loadingTitle) loadingTitle.textContent = manifest.title || '載入中…';

        setProgress(0.1, '載入遊戲資源');

        // Resolve CDN base URL from Flutter config (highest priority) then manifest.
        const cdnBase = flutterConfig.cdnBaseUrl || manifest.cdnBaseUrl || null;

        // Load assets listed in manifest.
        await loadAssets(manifest.assets || [], cdnBase);

        setProgress(0.9, '初始化遊戲');
        setProgress(1.0, '就緒');

        // Show the game UI (hides loading screen — do this after progress is 100%).
        showGame(manifest.title);

        // Dynamically load the game implementation (game.js or custom entryPoint).
        const entryPoint = manifest.entryPoint || 'game.js';
        await new Promise((resolve, reject) => {
          const s = document.createElement('script');
          s.src = entryPoint;
          s.onload  = resolve;
          s.onerror = () => reject(new Error('Failed to load ' + entryPoint));
          document.head.appendChild(s);
        });
      } catch (err) {
        // Show error in loading status so developers can debug.
        if (loadingStatus) loadingStatus.textContent = '錯誤: ' + err.message;
        console.error('[GameRuntime] init failed:', err);
      }
    }

    init();
  }());
  </script>
</body>
</html>
