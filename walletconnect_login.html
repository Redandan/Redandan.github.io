<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é€£æ¥éŒ¢åŒ… - Agora Market</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      transition: background-color 0.3s ease;
    }

    @media (prefers-color-scheme: dark) {
      body {
        background: #1a1a1a;
      }
    }

    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 3px 12px rgba(0, 0, 0, 0.08);
      max-width: 500px;
      width: 100%;
      padding: 0;
      overflow: hidden;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }

    @media (prefers-color-scheme: dark) {
      .container {
        background: #2a2a2a;
        box-shadow: 0 3px 12px rgba(0, 0, 0, 0.3);
      }
    }

    /* é¡µé¢å®¹å™¨ */
    .page {
      display: none;
      padding: 32px;
    }

    .page.active {
      display: block;
    }

    /* æ ‡é¢˜åŒºåŸŸ */
    .page-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .page-title {
      font-size: 24px;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 8px;
      transition: color 0.3s ease;
    }

    @media (prefers-color-scheme: dark) {
      .page-title {
        color: #ffffff;
      }
    }

    .page-subtitle {
      font-size: 14px;
      color: #666;
      line-height: 1.5;
      margin-bottom: 8px;
      transition: color 0.3s ease;
    }

    @media (prefers-color-scheme: dark) {
      .page-subtitle {
        color: #b0b0b0;
      }
    }

    .page-description {
      font-size: 14px;
      color: #999;
      line-height: 1.5;
      transition: color 0.3s ease;
    }

    @media (prefers-color-scheme: dark) {
      .page-description {
        color: #888;
      }
    }

    /* åŒºå—æ ‡é¢˜ */
    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 12px;
      margin-top: 24px;
      transition: color 0.3s ease;
    }

    @media (prefers-color-scheme: dark) {
      .section-title {
        color: #ffffff;
      }
    }

    .section-title:first-child {
      margin-top: 0;
    }

    /* é’±åŒ…æŒ‰é’®åˆ—è¡¨ */
    .wallet-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 24px;
    }

    .wallet-button {
      display: flex;
      align-items: center;
      padding: 16px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
      position: relative;
    }

    @media (prefers-color-scheme: dark) {
      .wallet-button {
        background: #333;
        border-color: #444;
      }
    }

    .wallet-button:hover {
      border-color: #3b99fc;
      background: #f5f9ff;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(59, 153, 252, 0.1);
    }

    @media (prefers-color-scheme: dark) {
      .wallet-button:hover {
        background: #3a3a3a;
        border-color: #3b99fc;
        box-shadow: 0 2px 8px rgba(59, 153, 252, 0.2);
      }
    }

    .wallet-button:active {
      transform: translateY(0);
    }

    .wallet-icon {
      width: 28px;
      height: 28px;
      font-size: 28px;
      margin-right: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .wallet-icon img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .wallet-info {
      flex: 1;
    }

    .wallet-name {
      font-size: 17px;
      font-weight: 500;
      color: #1a1a1a;
      margin-bottom: 2px;
      transition: color 0.3s ease;
    }

    @media (prefers-color-scheme: dark) {
      .wallet-name {
        color: #ffffff;
      }
    }

    .wallet-badge {
      display: inline-block;
      font-size: 12px;
      color: #4caf50;
      background: #e8f5e9;
      padding: 2px 8px;
      border-radius: 4px;
      margin-left: 8px;
    }

    .wallet-type {
      font-size: 14px;
      color: #999;
      transition: color 0.3s ease;
    }

    @media (prefers-color-scheme: dark) {
      .wallet-type {
        color: #888;
      }
    }

    /* ä¸»è¦CTAæŒ‰é’® */
    .primary-button {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #3b99fc 0%, #2e7ce8 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 17px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 24px;
    }

    .primary-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 153, 252, 0.3);
    }

    .primary-button:active {
      transform: translateY(0);
    }

    .primary-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* QR Code é¡µé¢ */
    .qr-container {
      text-align: center;
      margin: 32px 0;
    }

    .qr-box {
      width: 260px;
      height: 260px;
      margin: 0 auto;
      padding: 20px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }

    @media (prefers-color-scheme: dark) {
      .qr-box {
        background: #333;
        border-color: #444;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }
    }

    #qrcode {
      width: 100%;
      height: 100%;
    }

    .qr-expiry {
      font-size: 12px;
      color: #999;
      margin-top: 12px;
      transition: color 0.3s ease;
    }

    @media (prefers-color-scheme: dark) {
      .qr-expiry {
        color: #888;
      }
    }

    .qr-refresh {
      margin-top: 16px;
      background: none;
      border: 1px solid #e0e0e0;
      color: #666;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }

    @media (prefers-color-scheme: dark) {
      .qr-refresh {
        border-color: #444;
        color: #b0b0b0;
      }
    }

    .qr-refresh:hover {
      border-color: #3b99fc;
      color: #3b99fc;
    }

    .qr-steps {
      text-align: left;
      margin-top: 32px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 12px;
    }

    .qr-steps-title {
      font-size: 14px;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 12px;
    }

    .qr-steps-list {
      list-style: none;
      padding: 0;
    }

    .qr-steps-list li {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
      padding-left: 24px;
      position: relative;
    }

    .qr-steps-list li:before {
      content: counter(step);
      counter-increment: step;
      position: absolute;
      left: 0;
      width: 20px;
      height: 20px;
      background: #3b99fc;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
    }

    .qr-steps-list {
      counter-reset: step;
    }

    .wallet-icons {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 16px;
      flex-wrap: wrap;
    }

    .wallet-icon-small {
      width: 32px;
      height: 32px;
      font-size: 32px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .wallet-icon-small img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    /* Deep Link é¡µé¢ */
    .deeplink-container {
      text-align: center;
      margin: 32px 0;
    }

    .deeplink-icon {
      width: 64px;
      height: 64px;
      font-size: 64px;
      margin: 0 auto 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .deeplink-icon img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .deeplink-button {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #3b99fc 0%, #2e7ce8 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 17px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 24px;
    }

    .deeplink-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 153, 252, 0.3);
    }

    .deeplink-download {
      margin-top: 24px;
      font-size: 14px;
      color: #666;
      transition: color 0.3s ease;
    }

    @media (prefers-color-scheme: dark) {
      .deeplink-download {
        color: #b0b0b0;
      }
    }

    .deeplink-download a {
      color: #3b99fc;
      text-decoration: none;
    }

    .deeplink-download a:hover {
      text-decoration: underline;
    }

    /* è¿”å›æŒ‰é’® */
    .back-button {
      background: none;
      border: none;
      color: #3b99fc;
      font-size: 14px;
      cursor: pointer;
      padding: 8px 0;
      display: flex;
      align-items: center;
      gap: 4px;
      margin-top: 24px;
      transition: color 0.3s ease;
    }

    @media (prefers-color-scheme: dark) {
      .back-button {
        color: #64b5f6;
      }
    }

    .back-button:hover {
      text-decoration: underline;
    }

    /* çŠ¶æ€æç¤º */
    .status {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .status.info {
      background: #e3f2fd;
      color: #1976d2;
      display: block;
    }

    @media (prefers-color-scheme: dark) {
      .status.info {
        background: #1e3a5f;
        color: #64b5f6;
      }
    }

    .status.success {
      background: #e8f5e9;
      color: #388e3c;
      display: block;
    }

    @media (prefers-color-scheme: dark) {
      .status.success {
        background: #1b5e20;
        color: #81c784;
      }
    }

    .status.error {
      background: #ffebee;
      color: #d32f2f;
      display: block;
    }

    @media (prefers-color-scheme: dark) {
      .status.error {
        background: #5f1a1a;
        color: #e57373;
      }
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #3b99fc;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* é’±åŒ…ä¿¡æ¯æ˜¾ç¤º */
    .wallet-info-display {
      margin-top: 20px;
      padding: 16px;
      background: #f9f9f9;
      border-radius: 8px;
      display: none;
      transition: background-color 0.3s ease;
    }

    @media (prefers-color-scheme: dark) {
      .wallet-info-display {
        background: #333;
      }
    }

    .wallet-address {
      font-family: monospace;
      font-size: 14px;
      color: #333;
      word-break: break-all;
      transition: color 0.3s ease;
    }

    @media (prefers-color-scheme: dark) {
      .wallet-address {
        color: #ffffff;
      }
    }

    /* Fallback åŒºåŸŸ */
    .fallback-section {
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid #e0e0e0;
      transition: border-color 0.3s ease;
    }

    @media (prefers-color-scheme: dark) {
      .fallback-section {
        border-top-color: #444;
      }
    }

    .fallback-text {
      font-size: 14px;
      color: #999;
      margin-bottom: 16px;
      text-align: center;
      transition: color 0.3s ease;
    }

    @media (prefers-color-scheme: dark) {
      .fallback-text {
        color: #888;
      }
    }
  </style>
  <!-- QRCode.js for generating QR codes (local) -->
  <script src="qrcode.min.js"></script>
  <!-- WalletConnect Sign Client v2 (æœ¬åœ°æ–‡ä»¶) -->
  <script src="walletconnect-sign-client.js"></script>
</head>
<body>
  <div class="container">
    <!-- çŠ¶æ€æç¤º -->
    <div id="status" class="status info" style="display: none;">
      <span class="loading"></span>
      <span id="statusText">æ­£åœ¨åˆå§‹åŒ–...</span>
    </div>

    <!-- é¡µé¢ 1: é’±åŒ…é€‰æ‹©å™¨ä¸»é¡µé¢ -->
    <div id="pageSelector" class="page active">
      <div class="page-header">
        <h1 class="page-title">Connect Your Wallet</h1>
        <p class="page-subtitle">é€£æ¥ä½ çš„éŒ¢åŒ…ä»¥ç¹¼çºŒä½¿ç”¨ Agora ç¤¾ç¾¤å•†åŸ</p>
        <p class="page-description">æˆ‘å€‘å°‡ç”¨ä½ çš„éŒ¢åŒ…åœ°å€å»ºç«‹å®‰å…¨ç™»å…¥ã€‚ä½ ä¸éœ€è¦æä¾›ä»»ä½•å¯†ç¢¼ã€‚</p>
      </div>

      <!-- å·²å®‰è£çš„éŒ¢åŒ… -->
      <div id="installedWalletsSection" style="display: none;">
        <div class="section-title">å·²å®‰è£çš„éŒ¢åŒ…ï¼ˆæ¨è–¦ï¼‰</div>
        <div id="installedWalletsList" class="wallet-list"></div>
      </div>

      <!-- æ‰‹æ©ŸéŒ¢åŒ…ç™»å…¥ -->
      <div id="mobileWalletsSection" style="display: none;">
        <div class="section-title">æ‰‹æ©ŸéŒ¢åŒ…ç™»å…¥</div>
        <div id="mobileWalletsList" class="wallet-list"></div>
      </div>

      <!-- å†·éŒ¢åŒ… / QR éŒ¢åŒ…ç™»å…¥ -->
      <div id="coldWalletsSection" style="display: none;">
        <div class="section-title">å†·éŒ¢åŒ… / æƒæç™»å…¥</div>
        <div id="coldWalletsList" class="wallet-list"></div>
      </div>

      <!-- Fallback: WalletConnect -->
      <div class="fallback-section">
        <p class="fallback-text">è‹¥ä»¥ä¸Šæ–¹å¼çš†ç„¡æ³•ä½¿ç”¨ï¼Œä½ ä»å¯ä½¿ç”¨ WalletConnect æƒæç™»å…¥ï¼š</p>
        <button class="primary-button" onclick="showQRPage()">
          <span>ä½¿ç”¨ WalletConnect æƒæç™»å…¥</span>
        </button>
      </div>
    </div>

    <!-- é¡µé¢ 2: QR æ‰«æç™»å½• -->
    <div id="pageQR" class="page">
      <div class="page-header">
        <h1 class="page-title">ä½¿ç”¨éŒ¢åŒ…æƒæä»¥ç™»å…¥</h1>
        <p class="page-subtitle">Scan with WalletConnect</p>
        <p class="page-description">æ”¯æ´æ‰€æœ‰ EVM èˆ‡ TRON éŒ¢åŒ…ï¼ˆTronLink / OKX / Bitget / Trust / SafePalï¼‰</p>
      </div>

      <div class="qr-container">
        <div class="qr-box" id="qrcodeContainer">
          <div id="qrcode"></div>
        </div>
        <div class="qr-expiry" id="qrExpiry">æ­¤ QR å°‡åœ¨ 2 åˆ†é˜å¾ŒéæœŸ</div>
        <button class="qr-refresh" onclick="refreshQRCode()">ğŸ”„ é‡æ–°æ•´ç† QR</button>
      </div>

      <div class="qr-steps">
        <div class="qr-steps-title">ä½¿ç”¨æ­¥é©Ÿï¼š</div>
        <ol class="qr-steps-list">
          <li>æ‰“é–‹ä½ çš„éŒ¢åŒ… App</li>
          <li>æ‰¾åˆ°ã€Œæƒæ QRã€åŠŸèƒ½</li>
          <li>æƒæä»¥å»ºç«‹é€£ç·š</li>
        </ol>
      </div>

      <div class="wallet-icons">
        <span class="wallet-icon-small"><img src="assets/icons/metamask_icon.jpg" alt="MetaMask" /></span>
        <span class="wallet-icon-small"><img src="assets/icons/TronLink_icon.jpg" alt="TronLink" /></span>
        <span class="wallet-icon-small">ğŸŸ¢</span>
        <span class="wallet-icon-small">ğŸ’¼</span>
        <span class="wallet-icon-small">ğŸ›¡ï¸</span>
        <span class="wallet-icon-small">ğŸ¯</span>
      </div>

      <button class="back-button" onclick="showSelectorPage()">
        â† è¿”å›éŒ¢åŒ…é¸æ“‡å™¨
      </button>
    </div>

    <!-- é¡µé¢ 3: Deep Link ç™»å½• -->
    <div id="pageDeepLink" class="page">
      <div class="page-header">
        <div class="deeplink-icon" id="deeplinkIcon"><img src="assets/icons/TronLink_icon.jpg" alt="TronLink" /></div>
        <h1 class="page-title" id="deeplinkTitle">æ­£åœ¨æ‰“é–‹ TronLinkâ€¦</h1>
        <p class="page-subtitle" id="deeplinkSubtitle">å¦‚æœæ²’æœ‰è‡ªå‹•è·³è½‰ï¼Œè«‹æ‰‹å‹•é»æ“Šä¸‹æ–¹æŒ‰éˆ•ã€‚</p>
      </div>

      <div class="deeplink-container">
        <button class="deeplink-button" id="deeplinkButton" onclick="openDeepLinkApp()">
          æ‰“é–‹ TronLink App
        </button>

        <div class="deeplink-download" id="deeplinkDownload" style="display: none;">
          æ²’æœ‰å®‰è£ TronLinkï¼Ÿ <a href="#" id="deeplinkDownloadLink" target="_blank">å‰å¾€ä¸‹è¼‰</a>
        </div>
      </div>

      <button class="back-button" onclick="showSelectorPage()">
        â† è¿”å›éŒ¢åŒ…é¸æ“‡å™¨
      </button>
    </div>

    <!-- é’±åŒ…ä¿¡æ¯æ˜¾ç¤º -->
    <div id="walletInfo" class="wallet-info-display">
      <div>å·²é€£æ¥éŒ¢åŒ…ï¼š</div>
      <div class="wallet-address" id="walletAddress"></div>
    </div>
  </div>

  <script>
    // é…ç½®
    const CONFIG = {
      projectId: '7412eb629501759c091220ccc09ded23',
      apiBaseUrl: 'https://agoramarketapi.purrtechllc.com/api',
      supportedChains: ['eip155:1', 'eip155:56'],
    };

    // æ—¥å¿—çº§åˆ«æ§åˆ¶
    const DEBUG = false;
    
    function debugLog(...args) {
      if (DEBUG) console.log(...args);
    }
    
    function debugError(...args) {
      console.error(...args);
    }
    
    function debugWarn(...args) {
      if (DEBUG) console.warn(...args);
    }

    // å…¨å±€å˜é‡
    let signClient = null;
    let session = null;
    let currentUri = null;
    let SignClient = null;
    let isBrowserExtension = false;
    let ethereumProvider = null;
    let isTronLink = false;
    let tronWeb = null;
    let currentDeepLinkWallet = null;
    let qrRefreshTimer = null;
    
    // PWA ç¯å¢ƒæ£€æµ‹
    function isPWAMode() {
      try {
        // æ£€æµ‹æ˜¯å¦åœ¨ standalone æ¨¡å¼ï¼ˆPWAï¼‰
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
        const isFullscreen = window.matchMedia('(display-mode: fullscreen)').matches;
        const isMinimalUI = window.matchMedia('(display-mode: minimal-ui)').matches;
        // iOS Safari ç‰¹æ®Šå¤„ç†
        const isIOSStandalone = window.navigator.standalone === true;
        return isStandalone || isFullscreen || isMinimalUI || isIOSStandalone;
      } catch (e) {
        return false;
      }
    }
    
    // æ£€æµ‹æ˜¯å¦åœ¨ç§»åŠ¨è®¾å¤‡
    function isMobileDevice() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }
    
    // æ£€æµ‹ TronLink App æ˜¯å¦å·²å®‰è£…ï¼ˆé€šè¿‡å°è¯•æ‰“å¼€ Universal Linkï¼‰
    async function checkTronLinkAppInstalled() {
      return new Promise((resolve) => {
        const timeout = setTimeout(() => resolve(false), 1000);
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = 'tronlink://';
        document.body.appendChild(iframe);
        
        // å°†äº‹ä»¶å¤„ç†å‡½æ•°æå–åˆ°å¤–éƒ¨ä½œç”¨åŸŸï¼Œä»¥ä¾¿åœ¨ setTimeout ä¸­ä¹Ÿèƒ½è®¿é—®
        let onBlur = null;
        let cleanupDone = false;
        
        const cleanup = () => {
          if (cleanupDone) return;
          cleanupDone = true;
          clearTimeout(timeout);
          if (iframe.parentNode) {
            document.body.removeChild(iframe);
          }
          if (onBlur) {
            window.removeEventListener('blur', onBlur);
          }
        };
        
        onBlur = () => {
          cleanup();
          resolve(true);
        };
        
        window.addEventListener('blur', onBlur);
        
        setTimeout(() => {
          cleanup();
          resolve(false);
        }, 2000);
      });
    }
    
    // æˆæƒçŠ¶æ€ç®¡ç†ï¼ˆLocalStorageï¼‰
    const AuthStorage = {
      key: 'wallet_connect_auth',
      save: function(walletAddress, walletType, chain) {
        try {
          const data = {
            walletAddress,
            walletType,
            chain,
            timestamp: Date.now(),
            expiresAt: Date.now() + (7 * 24 * 60 * 60 * 1000) // 7å¤©è¿‡æœŸ
          };
          localStorage.setItem(this.key, JSON.stringify(data));
        } catch (e) {
          debugWarn('ä¿å­˜æˆæƒçŠ¶æ€å¤±è´¥:', e);
        }
      },
      load: function() {
        try {
          const data = localStorage.getItem(this.key);
          if (!data) return null;
          const auth = JSON.parse(data);
          if (auth.expiresAt && auth.expiresAt < Date.now()) {
            this.clear();
            return null;
          }
          return auth;
        } catch (e) {
          debugWarn('åŠ è½½æˆæƒçŠ¶æ€å¤±è´¥:', e);
          return null;
        }
      },
      clear: function() {
        try {
          localStorage.removeItem(this.key);
        } catch (e) {
          debugWarn('æ¸…é™¤æˆæƒçŠ¶æ€å¤±è´¥:', e);
        }
      }
    };

    // é’±åŒ…é…ç½®
    const WALLET_CONFIG = {
      installed: [
        { id: 'metamask', name: 'MetaMask', icon: 'assets/icons/metamask_icon.jpg', type: 'extension', installUrl: 'https://metamask.io/download/' },
        { id: 'coinbase', name: 'Coinbase Wallet', icon: 'ğŸ”·', type: 'extension', installUrl: 'https://www.coinbase.com/wallet' },
        { id: 'okx', name: 'OKX Wallet', icon: 'ğŸŸ¢', type: 'extension', installUrl: 'https://www.okx.com/web3' },
        { id: 'tronlink', name: 'TronLink', icon: 'assets/icons/TronLink_icon.jpg', type: 'tron', installUrl: 'https://www.tronlink.org/' },
        { id: 'trust', name: 'Trust Wallet', icon: 'ğŸ›¡ï¸', type: 'extension', installUrl: 'https://trustwallet.com/browser-extension' },
        { id: 'bitget', name: 'Bitget Wallet', icon: 'ğŸ’¼', type: 'extension', installUrl: 'https://web3.bitget.com/' },
      ],
      mobile: [
        { id: 'metamask-mobile', name: 'MetaMask Mobile', icon: 'assets/icons/metamask_icon.jpg', deepLink: 'metamask://wc?uri=' },
        { id: 'tronlink-app', name: 'TronLink App', icon: 'assets/icons/TronLink_icon.jpg', deepLink: 'tronlink://', type: 'tron', installUrl: 'https://www.tronlink.org/' },
        { id: 'okx-app', name: 'OKX App', icon: 'ğŸŸ¢', deepLink: 'okx://wc?uri=' },
        { id: 'bitget-app', name: 'Bitget', icon: 'ğŸ’¼', deepLink: 'bitget://wc?uri=' },
        { id: 'trust-app', name: 'Trust Wallet', icon: 'ğŸ›¡ï¸', deepLink: 'trust://wc?uri=' },
      ],
      cold: [
        { id: 'keystone', name: 'Keystone â€“ æƒæç™»å…¥', icon: 'ğŸ”', action: 'scan' },
        { id: 'safepal', name: 'SafePal â€“ æƒæç™»å…¥', icon: 'ğŸ¯', action: 'scan' },
        { id: 'onekey', name: 'OneKey â€“ æƒæç™»å…¥', icon: 'ğŸ”‘', action: 'scan' },
      ]
    };

    // é¡µé¢åˆ‡æ¢
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });
      document.getElementById(pageId).classList.add('active');
    }

    function showSelectorPage() {
      showPage('pageSelector');
      hideStatus();
    }

    function showQRPage() {
      showPage('pageQR');
      connectWalletConnect();
    }

    function showDeepLinkPage(wallet) {
      currentDeepLinkWallet = wallet;
      const page = document.getElementById('pageDeepLink');
      const deeplinkIconEl = document.getElementById('deeplinkIcon');
      
      // æ£€æµ‹ icon æ˜¯å›¾ç‰‡è·¯å¾„è¿˜æ˜¯ emoji
      const isImagePath = wallet.icon && (wallet.icon.includes('.') || wallet.icon.startsWith('assets/') || wallet.icon.startsWith('/'));
      if (isImagePath) {
        deeplinkIconEl.innerHTML = `<img src="${wallet.icon}" alt="${wallet.name}" />`;
      } else {
        deeplinkIconEl.textContent = wallet.icon;
      }
      
      document.getElementById('deeplinkTitle').textContent = `æ­£åœ¨æ‰“é–‹ ${wallet.name}â€¦`;
      document.getElementById('deeplinkButton').textContent = `æ‰“é–‹ ${wallet.name} App`;
      
      // PWA æ¨¡å¼ä¸‹çš„ç‰¹æ®Šæç¤º
      const subtitleEl = document.getElementById('deeplinkSubtitle');
      if (isPWAMode() && (wallet.id === 'tronlink-app' || wallet.id === 'tronlink')) {
        subtitleEl.textContent = 'å¦‚æœæ²’æœ‰è‡ªå‹•è·³è½‰ï¼Œè«‹æ‰‹å‹•é»æ“Šä¸‹æ–¹æŒ‰éˆ•æ‰“é–‹ TronLink Appã€‚åœ¨ PWA æ¨¡å¼ä¸‹ï¼Œå»ºè­°ä½¿ç”¨ TronLink ç€è¦½å™¨æ“´å±•ä»¥ç²å¾—æœ€ä½³é«”é©—ã€‚';
      } else {
        subtitleEl.textContent = 'å¦‚æœæ²’æœ‰è‡ªå‹•è·³è½‰ï¼Œè«‹æ‰‹å‹•é»æ“Šä¸‹æ–¹æŒ‰éˆ•ã€‚';
      }
      
      if (wallet.installUrl) {
        document.getElementById('deeplinkDownload').style.display = 'block';
        document.getElementById('deeplinkDownloadLink').href = wallet.installUrl;
      } else {
        document.getElementById('deeplinkDownload').style.display = 'none';
      }
      showPage('pageDeepLink');
    }

    // çŠ¶æ€ç®¡ç†
    function updateStatus(type, message) {
      const statusDiv = document.getElementById('status');
      const statusText = document.getElementById('statusText');
      statusDiv.className = 'status ' + type;
      statusText.textContent = message;
      statusDiv.style.display = 'block';
    }

    function hideStatus() {
      document.getElementById('status').style.display = 'none';
    }

    // æ£€æµ‹å·²å®‰è£…çš„é’±åŒ…ï¼ˆä¼˜åŒ–ç‰ˆï¼Œæ”¯æŒ PWA æ¨¡å¼ä¸‹çš„å¼‚æ­¥æ£€æµ‹ï¼‰
    async function getInstalledWallets() {
      const installed = {};
      
      // å¯¹äº TronLinkï¼Œåœ¨ PWA æ¨¡å¼ä¸‹éœ€è¦ç­‰å¾…æ›´é•¿æ—¶é—´
      const checkTronLink = async () => {
        // åœ¨ PWA æ¨¡å¼ä¸‹ï¼Œç­‰å¾…æœ€å¤š 2 ç§’è®© TronLink æ³¨å…¥
        if (isPWAMode() || isMobileDevice()) {
          for (let i = 0; i < 20; i++) {
            if (window.tronWeb || (window.tronLink && window.tronLink.tronWeb)) {
              return true;
            }
            await new Promise((resolve) => setTimeout(resolve, 100));
          }
        }
        return window.tronWeb || (window.tronLink && window.tronLink.tronWeb);
      };
      
      for (const wallet of WALLET_CONFIG.installed) {
        if (wallet.id === 'metamask' && window.ethereum?.isMetaMask) {
          installed[wallet.id] = true;
        } else if (wallet.id === 'coinbase' && window.ethereum?.isCoinbaseWallet) {
          installed[wallet.id] = true;
        } else if (wallet.id === 'okx' && window.okxwallet) {
          installed[wallet.id] = true;
        } else if (wallet.id === 'tronlink') {
          // TronLink éœ€è¦å¼‚æ­¥æ£€æµ‹
          if (await checkTronLink()) {
            installed[wallet.id] = true;
          }
        } else if (wallet.id === 'trust' && window.ethereum?.isTrust) {
          installed[wallet.id] = true;
        } else if (wallet.id === 'bitget' && window.bitkeep) {
          installed[wallet.id] = true;
        }
      }
      return installed;
    }

    // æ¸²æŸ“é’±åŒ…åˆ—è¡¨
    function renderWalletButton(wallet, isInstalled = false) {
      const button = document.createElement('button');
      button.className = 'wallet-button';
      button.onclick = () => handleWalletClick(wallet, isInstalled);
      
      // æ£€æµ‹ icon æ˜¯å›¾ç‰‡è·¯å¾„è¿˜æ˜¯ emoji
      const isImagePath = wallet.icon && (wallet.icon.includes('.') || wallet.icon.startsWith('assets/') || wallet.icon.startsWith('/'));
      const iconHtml = isImagePath 
        ? `<img src="${wallet.icon}" alt="${wallet.name}" />`
        : wallet.icon;
      
      button.innerHTML = `
        <div class="wallet-icon">${iconHtml}</div>
        <div class="wallet-info">
          <div class="wallet-name">
            ${wallet.name}
            ${isInstalled ? '<span class="wallet-badge">å·²å®‰è£</span>' : ''}
          </div>
          ${wallet.type ? `<div class="wallet-type">${getWalletTypeText(wallet.type)}</div>` : ''}
        </div>
      `;
      
      return button;
    }

    function getWalletTypeText(type) {
      const types = {
        'extension': 'ç€è¦½å™¨æ“´å……åŠŸèƒ½',
        'tron': 'Tron éŒ¢åŒ…',
        'mobile': 'æ‰‹æ©ŸéŒ¢åŒ…',
        'cold': 'å†·éŒ¢åŒ…'
      };
      return types[type] || '';
    }

    // åˆå§‹åŒ–é’±åŒ…é€‰æ‹©å™¨ï¼ˆä¼˜åŒ–ç‰ˆï¼ŒPWA æ¨¡å¼ä¸‹ä¼˜å…ˆæ˜¾ç¤ºç›¸å…³é€‰é¡¹ï¼‰
    async function initWalletSelector() {
      const installed = await getInstalledWallets();
      const installedList = WALLET_CONFIG.installed.filter(w => installed[w.id]);
      const isPWA = isPWAMode();
      const isMobile = isMobileDevice();
      
      // æ¸²æŸ“å·²å®‰è£…çš„é’±åŒ…
      if (installedList.length > 0) {
        const installedSection = document.getElementById('installedWalletsSection');
        const installedListEl = document.getElementById('installedWalletsList');
        installedListEl.innerHTML = '';
        installedList.forEach(wallet => {
          installedListEl.appendChild(renderWalletButton(wallet, true));
        });
        installedSection.style.display = 'block';
      }

      // æ¸²æŸ“æ‰‹æœºé’±åŒ…ï¼ˆPWA æ¨¡å¼ä¸‹ä¼˜å…ˆæ˜¾ç¤ºï¼‰
      const mobileSection = document.getElementById('mobileWalletsSection');
      const mobileListEl = document.getElementById('mobileWalletsList');
      mobileListEl.innerHTML = '';
      
      // åœ¨ PWA æˆ–ç§»åŠ¨è®¾å¤‡ä¸Šï¼Œä¼˜å…ˆæ˜¾ç¤º TronLink
      const mobileWallets = [...WALLET_CONFIG.mobile];
      if (isPWA || isMobile) {
        // å°† TronLink ç§»åˆ°æœ€å‰é¢
        const tronLinkIndex = mobileWallets.findIndex(w => w.id === 'tronlink-app');
        if (tronLinkIndex > 0) {
          const tronLink = mobileWallets.splice(tronLinkIndex, 1)[0];
          mobileWallets.unshift(tronLink);
        }
      }
      
      mobileWallets.forEach(wallet => {
        mobileListEl.appendChild(renderWalletButton(wallet));
      });
      mobileSection.style.display = 'block';

      // æ¸²æŸ“å†·é’±åŒ…ï¼ˆPWA æ¨¡å¼ä¸‹ä¼˜å…ˆæ˜¾ç¤º TronLink æ‰«æï¼‰
      const coldSection = document.getElementById('coldWalletsSection');
      const coldListEl = document.getElementById('coldWalletsList');
      coldListEl.innerHTML = '';
      
      const coldWallets = [...WALLET_CONFIG.cold];
      
      coldWallets.forEach(wallet => {
        coldListEl.appendChild(renderWalletButton(wallet));
      });
      coldSection.style.display = 'block';
    }

    // å¤„ç†é’±åŒ…ç‚¹å‡»ï¼ˆä¼˜åŒ–ç‰ˆï¼Œæ”¯æŒ PWA æ™ºèƒ½æ£€æµ‹ï¼‰
    async function handleWalletClick(wallet, isInstalled) {
      try {
        // å·²å®‰è£…çš„é’±åŒ… - ç›´æ¥è¿æ¥
        if (isInstalled) {
          if (wallet.type === 'tron') {
            await connectTronLink();
          } else if (wallet.type === 'extension') {
            ethereumProvider = window.ethereum;
            isBrowserExtension = true;
            await connectBrowserExtension();
          }
          return;
        }
        
        // å¯¹äºæ‰‹æœºé’±åŒ…å’Œå†·é’±åŒ…ï¼Œå…ˆé‡æ–°æ£€æµ‹æ˜¯å¦å·²å®‰è£…å¯¹åº”çš„é’±åŒ…
        updateStatus('info', 'æ­£åœ¨æª¢æ¸¬å¯ç”¨éŒ¢åŒ…...');
        const installedWallets = await getInstalledWallets();
        
        // æ£€æŸ¥æ˜¯å¦æœ‰å¯¹åº”çš„å·²å®‰è£…é’±åŒ…
        let detectedWallet = null;
        if (wallet.id === 'tronlink-app' || wallet.id === 'tronlink') {
          // TronLink ç‰¹æ®Šå¤„ç†ï¼šåœ¨ PWA æ¨¡å¼ä¸‹ï¼Œå¦‚æœé€‰æ‹© tronlink-appï¼Œç›´æ¥å°è¯•å”¤èµ· App
          if (wallet.id === 'tronlink-app' && (isPWAMode() || isMobileDevice())) {
            // åœ¨ PWA/ç§»åŠ¨è®¾å¤‡ä¸Šï¼Œé€‰æ‹© tronlink-app æ—¶ç›´æ¥å°è¯•å”¤èµ· App
            updateStatus('info', 'æ­£åœ¨æ‰“é–‹ TronLink App...');
            showDeepLinkPage(wallet);
            
            try {
              // ç›´æ¥æ‰“å¼€ TronLink Appï¼ˆä¸ä½¿ç”¨ WalletConnectï¼‰
              window.location.href = 'tronlink://';
              // è®¾ç½®è¶…æ—¶ï¼Œå¦‚æœ3ç§’åè¿˜åœ¨å½“å‰é¡µé¢ï¼Œæç¤ºç”¨æˆ·
              setTimeout(() => {
                if (document.hasFocus()) {
                  updateStatus('error', 'ç„¡æ³•æ‰“é–‹ TronLink Appã€‚è«‹ç¢ºä¿å·²å®‰è£ TronLink æ‰‹æ©Ÿ Appã€‚');
                  const downloadEl = document.getElementById('deeplinkDownload');
                  if (downloadEl) {
                    downloadEl.style.display = 'block';
                  }
                  if (wallet.installUrl) {
                    const downloadLink = document.getElementById('deeplinkDownloadLink');
                    if (downloadLink) {
                      downloadLink.href = wallet.installUrl;
                    }
                  }
                }
              }, 3000);
            } catch (e) {
              debugError('æ‰“é–‹ TronLink App å¤±æ•—:', e);
              updateStatus('error', 'ç„¡æ³•æ‰“é–‹ TronLink Appã€‚è«‹ç¢ºä¿å·²å®‰è£ TronLink æ‰‹æ©Ÿ Appã€‚');
              const downloadEl = document.getElementById('deeplinkDownload');
              if (downloadEl) {
                downloadEl.style.display = 'block';
              }
            }
            return;
          }
          
          // å…¶ä»–æƒ…å†µï¼šæ£€æŸ¥æ˜¯å¦æœ‰æ‰©å±•
          if (installedWallets['tronlink']) {
            detectedWallet = WALLET_CONFIG.installed.find(w => w.id === 'tronlink');
          } else {
            // å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°æ‰©å±•ï¼Œåœ¨ PWA/ç§»åŠ¨è®¾å¤‡ä¸Šå¯ä»¥å°è¯•æ‰“å¼€ App
            if (isPWAMode() || isMobileDevice()) {
              // åœ¨ PWA/ç§»åŠ¨è®¾å¤‡ä¸Šï¼Œå°è¯•æ‰“å¼€ TronLink App
              updateStatus('info', 'æœªæª¢æ¸¬åˆ° TronLink æ“´å±•ï¼Œæ­£åœ¨å˜—è©¦æ‰“é–‹ TronLink App...');
              showDeepLinkPage(wallet);
              
              try {
                window.location.href = 'tronlink://';
                // è®¾ç½®è¶…æ—¶æ£€æµ‹
                setTimeout(() => {
                  if (document.hasFocus()) {
                    updateStatus('error', 'ç„¡æ³•æ‰“é–‹ TronLink Appã€‚è«‹å®‰è£ TronLink ç€è¦½å™¨æ“´å±•æˆ–ç¢ºä¿å·²å®‰è£ TronLink æ‰‹æ©Ÿ Appã€‚');
                    const downloadEl = document.getElementById('deeplinkDownload');
                    if (downloadEl) {
                      downloadEl.style.display = 'block';
                    }
                    if (wallet.installUrl) {
                      const downloadLink = document.getElementById('deeplinkDownloadLink');
                      if (downloadLink) {
                        downloadLink.href = wallet.installUrl;
                      }
                    }
                  }
                }, 3000);
              } catch (e) {
                debugError('æ‰“é–‹ TronLink App å¤±æ•—:', e);
                updateStatus('error', 'ç„¡æ³•æ‰“é–‹ TronLink Appã€‚è«‹å®‰è£ TronLink ç€è¦½å™¨æ“´å±•ã€‚');
                const downloadEl = document.getElementById('deeplinkDownload');
                if (downloadEl) {
                  downloadEl.style.display = 'block';
                }
              }
            } else {
              // éç§»åŠ¨è®¾å¤‡ï¼Œæç¤ºå®‰è£…æ‰©å±•
              updateStatus('error', 'æœªæª¢æ¸¬åˆ° TronLink æ“´å±•ã€‚è«‹å®‰è£ TronLink ç€è¦½å™¨æ“´å±•å¾Œé‡è©¦ã€‚');
              const installUrl = wallet.installUrl || 'https://www.tronlink.org/';
              if (confirm('æœªæª¢æ¸¬åˆ° TronLink æ“´å±•ã€‚æ˜¯å¦å‰å¾€ä¸‹è¼‰é é¢ï¼Ÿ')) {
                window.open(installUrl, '_blank');
              }
            }
            return;
          }
        } else if (wallet.id === 'metamask-mobile') {
          // MetaMask Mobile
          if (installedWallets['metamask']) {
            detectedWallet = WALLET_CONFIG.installed.find(w => w.id === 'metamask');
          }
        } else if (wallet.id === 'okx-app') {
          // OKX App
          if (installedWallets['okx']) {
            detectedWallet = WALLET_CONFIG.installed.find(w => w.id === 'okx');
          }
        } else if (wallet.id === 'trust-app') {
          // Trust Wallet App
          if (installedWallets['trust']) {
            detectedWallet = WALLET_CONFIG.installed.find(w => w.id === 'trust');
          }
        } else if (wallet.id === 'bitget-app') {
          // Bitget App
          if (installedWallets['bitget']) {
            detectedWallet = WALLET_CONFIG.installed.find(w => w.id === 'bitget');
          }
        }
        
        // å¦‚æœæ£€æµ‹åˆ°å·²å®‰è£…çš„é’±åŒ…ï¼Œä¼˜å…ˆä½¿ç”¨å·²å®‰è£…çš„é’±åŒ…
        if (detectedWallet) {
          debugLog('æª¢æ¸¬åˆ°å·²å®‰è£çš„éŒ¢åŒ…ï¼Œä½¿ç”¨å·²å®‰è£ç‰ˆæœ¬:', detectedWallet.name);
          updateStatus('info', `æª¢æ¸¬åˆ°å·²å®‰è£çš„ ${detectedWallet.name}ï¼Œæ­£åœ¨é€£æ¥...`);
          
          if (detectedWallet.type === 'tron') {
            await connectTronLink();
          } else if (detectedWallet.type === 'extension') {
            ethereumProvider = window.ethereum;
            isBrowserExtension = true;
            await connectBrowserExtension();
          }
          return;
        }
        
        // æ‰‹æœºé’±åŒ… - Deep Linkï¼ˆåªæœ‰åœ¨æ£€æµ‹ä¸åˆ°å·²å®‰è£…é’±åŒ…æ—¶æ‰ä½¿ç”¨ï¼‰
        if (wallet.deepLink) {
          // TronLink ç‰¹æ®Šå¤„ç†ï¼šä¸ä½¿ç”¨ WalletConnectï¼Œç›´æ¥æ‰“å¼€ App æˆ–æç¤ºå®‰è£…æ‰©å±•
          if (wallet.id === 'tronlink-app' || wallet.id === 'tronlink') {
            // åœ¨ PWA/ç§»åŠ¨è®¾å¤‡ä¸Šï¼Œå°è¯•ç›´æ¥æ‰“å¼€ TronLink App
            if (isPWAMode() || isMobileDevice()) {
              updateStatus('info', 'æ­£åœ¨æ‰“é–‹ TronLink App...');
              // æ˜¾ç¤º Deep Link é¡µé¢
              showDeepLinkPage(wallet);
              
              try {
                // ç›´æ¥æ‰“å¼€ TronLink Appï¼ˆä¸ä½¿ç”¨ WalletConnectï¼‰
                window.location.href = 'tronlink://';
                // è®¾ç½®è¶…æ—¶ï¼Œå¦‚æœ3ç§’åè¿˜åœ¨å½“å‰é¡µé¢ï¼Œæç¤ºç”¨æˆ·
                setTimeout(() => {
                  if (document.hasFocus()) {
                    updateStatus('error', 'ç„¡æ³•æ‰“é–‹ TronLink Appã€‚è«‹ç¢ºä¿å·²å®‰è£ TronLink æ‰‹æ©Ÿ Appï¼Œæˆ–ä½¿ç”¨ TronLink ç€è¦½å™¨æ“´å±•ã€‚');
                    const downloadEl = document.getElementById('deeplinkDownload');
                    if (downloadEl) {
                      downloadEl.style.display = 'block';
                    }
                    if (wallet.installUrl) {
                      const downloadLink = document.getElementById('deeplinkDownloadLink');
                      if (downloadLink) {
                        downloadLink.href = wallet.installUrl;
                      }
                    }
                  }
                }, 3000);
              } catch (e) {
                debugError('æ‰“é–‹ TronLink App å¤±æ•—:', e);
                updateStatus('error', 'ç„¡æ³•æ‰“é–‹ TronLink Appã€‚è«‹ä½¿ç”¨ TronLink ç€è¦½å™¨æ“´å±•ã€‚');
                const downloadEl = document.getElementById('deeplinkDownload');
                if (downloadEl) {
                  downloadEl.style.display = 'block';
                }
              }
            } else {
              // éç§»åŠ¨è®¾å¤‡ï¼Œæç¤ºä½¿ç”¨æ‰©å±•
              updateStatus('error', 'è«‹ä½¿ç”¨ TronLink ç€è¦½å™¨æ“´å±•é€²è¡Œé€£æ¥ã€‚');
              if (wallet.installUrl) {
                if (confirm('æœªæª¢æ¸¬åˆ° TronLink æ“´å±•ã€‚æ˜¯å¦å‰å¾€ä¸‹è¼‰é é¢ï¼Ÿ')) {
                  window.open(wallet.installUrl, '_blank');
                }
              }
            }
            return;
          } else {
            // å…¶ä»–é’±åŒ…ä½¿ç”¨ WalletConnect æ ‡å‡†æµç¨‹
            showDeepLinkPage(wallet);
            await connectWalletConnect();
          }
        }
        // å†·é’±åŒ… - æ˜¾ç¤º QR Codeï¼ˆåªæœ‰åœ¨æ£€æµ‹ä¸åˆ°å·²å®‰è£…é’±åŒ…æ—¶æ‰ä½¿ç”¨ï¼‰
        else if (wallet.action === 'scan') {
          showQRPage();
        }
      } catch (error) {
        debugError('è™•ç†éŒ¢åŒ…é»æ“Šå¤±æ•—:', error);
        updateStatus('error', 'é€£æ¥å¤±æ•—: ' + error.message);
      }
    }

    // æ‰“å¼€ Deep Linkï¼ˆä¼˜åŒ–ç‰ˆï¼ŒTronLink ä¸ä½¿ç”¨ WalletConnectï¼‰
    async function openDeepLinkApp() {
      if (!currentDeepLinkWallet) {
        updateStatus('error', 'ç¼ºå°‘é€£æ¥ä¿¡æ¯');
        return;
      }
      
      const wallet = currentDeepLinkWallet;
      
      // TronLink ä¸ä½¿ç”¨ WalletConnectï¼Œç›´æ¥æ‰“å¼€ App
      if (wallet.id === 'tronlink-app' || wallet.id === 'tronlink') {
        // ç›´æ¥æ‰“å¼€ TronLink Appï¼ˆä¸ä½¿ç”¨ WalletConnect URIï¼‰
        const deepLink = 'tronlink://';
        window.location.href = deepLink;
        
        // è®¾ç½®è¶…æ—¶æ£€æµ‹
        setTimeout(() => {
          if (document.hasFocus()) {
            updateStatus('error', 'ç„¡æ³•æ‰“é–‹ TronLink Appã€‚è«‹ç¢ºä¿å·²å®‰è£ TronLink æ‰‹æ©Ÿ Appï¼Œæˆ–ä½¿ç”¨ TronLink ç€è¦½å™¨æ“´å±•ã€‚');
            const downloadEl = document.getElementById('deeplinkDownload');
            if (downloadEl) {
              downloadEl.style.display = 'block';
            }
          }
        }, 3000);
        return;
      }
      
      // å…¶ä»–é’±åŒ…ä½¿ç”¨ WalletConnect Deep Link
      if (!currentUri) {
        updateStatus('error', 'ç¼ºå°‘é€£æ¥ä¿¡æ¯');
        return;
      }
      
      const deepLink = wallet.deepLink + encodeURIComponent(currentUri);
      window.location.href = deepLink;
      
      // è®¾ç½®è¶…æ—¶ï¼Œå¦‚æœ5ç§’åè¿˜æ²¡è·³è½¬ï¼Œæ˜¾ç¤ºä¸‹è½½é“¾æ¥
      setTimeout(() => {
        const downloadEl = document.getElementById('deeplinkDownload');
        if (downloadEl) {
          downloadEl.style.display = 'block';
        }
      }, 5000);
      
      // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼Œæ£€æµ‹æ˜¯å¦æˆåŠŸè·³è½¬
      let visibilityTimeout;
      const handleVisibilityChange = () => {
        if (document.hidden) {
          // é¡µé¢éšè—ï¼Œå¯èƒ½å·²è·³è½¬åˆ° App
          clearTimeout(visibilityTimeout);
          visibilityTimeout = setTimeout(() => {
            if (!document.hidden) {
              // é¡µé¢é‡æ–°å¯è§ï¼Œå¯èƒ½è·³è½¬å¤±è´¥
              const downloadEl = document.getElementById('deeplinkDownload');
              if (downloadEl) {
                downloadEl.style.display = 'block';
              }
            }
          }, 3000);
        }
      };
      
      document.addEventListener('visibilitychange', handleVisibilityChange);
      
      // æ¸…ç†ç›‘å¬å™¨
      setTimeout(() => {
        document.removeEventListener('visibilitychange', handleVisibilityChange);
      }, 10000);
    }

    // åˆ·æ–° QR Code
    async function refreshQRCode() {
      if (signClient && currentUri) {
        // æ–­å¼€å½“å‰è¿æ¥
        try {
          const sessions = signClient.session.getAll();
          sessions.forEach(s => {
            if (s.topic) {
              signClient.disconnect({ topic: s.topic, reason: { code: 6000, message: 'User refreshed QR' } });
            }
          });
        } catch (e) {
          debugWarn('æ–­å¼€è¿æ¥å¤±è´¥:', e);
        }
        
        // é‡æ–°ç”Ÿæˆ QR Code
        await connectWalletConnect();
      }
    }

    // WalletConnect ç›¸å…³å‡½æ•°ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼‰
    async function waitForSignClient() {
      return new Promise((resolve, reject) => {
        const checkSignClient = () => {
          try {
            const wcModule = window['@walletconnect/sign-client'];
            if (wcModule) {
              SignClient = wcModule.SignClient || wcModule.default || wcModule;
              if (SignClient && typeof SignClient.init === 'function') {
                return SignClient;
              }
            }
            return null;
          } catch (e) {
            debugError('æ£€æŸ¥ SignClient æ—¶å‡ºé”™:', e);
            return null;
          }
        };

        const client = checkSignClient();
        if (client) {
          resolve(client);
          return;
        }

        let attempts = 0;
        const maxAttempts = 100;
        const checkInterval = setInterval(() => {
          attempts++;
          const client = checkSignClient();
          if (client) {
            clearInterval(checkInterval);
            resolve(client);
          } else if (attempts >= maxAttempts) {
            clearInterval(checkInterval);
            reject(new Error('WalletConnect SignClient åŠ è½½è¶…æ—¶'));
          }
        }, 100);
      });
    }

    async function initWalletConnect() {
      try {
        await waitForSignClient();
        
        if (!SignClient) {
          throw new Error('SignClient æœªæ‰¾åˆ°');
        }
        
        signClient = await SignClient.init({
          projectId: CONFIG.projectId,
          metadata: {
            name: 'Agora Market',
            description: 'Agora Market DApp',
            url: window.location.origin,
            icons: [window.location.origin + '/favicon.png']
          }
        });

        setupSessionListeners();
      } catch (error) {
        debugError('WalletConnect åˆå§‹åŒ–å¤±è´¥:', error);
        throw error;
      }
    }

    function setupSessionListeners() {
      if (!signClient) return;

      signClient.on('session_update', ({ topic, params }) => {
        if (session && session.topic === topic) {
          session = { ...session, ...params };
          const walletAddress = getWalletAddress();
          if (walletAddress) {
            sendEventToFlutter('session_updated', {
              walletAddress: walletAddress,
              session: session
            });
          }
        }
      });

      signClient.on('session_delete', ({ topic }) => {
        if (session && session.topic === topic) {
          session = null;
          sendEventToFlutter('session_disconnected', {});
        }
      });
    }

    async function connectWalletConnect() {
      try {
        if (!signClient) {
          updateStatus('info', 'æ­£åœ¨åˆå§‹åŒ– WalletConnect...');
          await initWalletConnect();
          
          if (!signClient) {
            throw new Error('WalletConnect åˆå§‹åŒ–å¤±æ•—');
          }
        }

        updateStatus('info', 'æ­£åœ¨ç”Ÿæˆé€£æ¥è«‹æ±‚...');

        const { uri, approval } = await signClient.connect({
          optionalNamespaces: {
            eip155: {
              methods: ['personal_sign', 'eth_signTypedData'],
              chains: CONFIG.supportedChains,
              events: ['chainChanged', 'accountsChanged']
            }
          }
        });

        if (uri) {
          currentUri = uri;
          await showQRCode(uri);
          sendEventToFlutter('uri_generated', { uri: uri });
          
          // è®¾ç½® QR è¿‡æœŸå€’è®¡æ—¶
          startQRExpiryTimer();
        } else {
          throw new Error('æœªèƒ½ç”Ÿæˆé€£æ¥ URI');
        }

        // ç­‰å¾…ç”¨æˆ·æ‰¹å‡†è¿æ¥
        updateStatus('info', 'ç­‰å¾…éŒ¢åŒ…é€£æ¥...');
        session = await approval();

        const walletAddress = getWalletAddress();
        if (walletAddress) {
          updateStatus('success', 'éŒ¢åŒ…é€£æ¥æˆåŠŸï¼');
          showWalletInfo(walletAddress);
          
          // ä¿å­˜æˆæƒçŠ¶æ€ï¼ˆä»…åœ¨ PWA æ¨¡å¼ä¸‹ï¼‰
          if (isPWAMode()) {
            AuthStorage.save(walletAddress, 'walletconnect', 'EVM');
          }
          
          sendEventToFlutter('connected', { 
            walletAddress: walletAddress,
            session: session,
            isBrowserExtension: false
          });

          await performLogin(walletAddress);
        }
      } catch (error) {
        debugError('é€£æ¥ WalletConnect å¤±æ•—:', error);
        if (error.message && (error.message.includes('User rejected') || error.message.includes('rejected'))) {
          updateStatus('info', 'å·²å–æ¶ˆé€£æ¥');
          showSelectorPage();
          return;
        }
        updateStatus('error', 'é€£æ¥å¤±æ•—: ' + error.message);
        sendEventToFlutter('error', { error: error.message });
      }
    }

    async function showQRCode(uri) {
      const qrcodeDiv = document.getElementById('qrcode');
      qrcodeDiv.innerHTML = '';
      
      try {
        const qrcode = new QRCode(qrcodeDiv, {
          text: uri,
          width: 220,
          height: 220,
          colorDark: '#000000',
          colorLight: '#FFFFFF',
          correctLevel: QRCode.CorrectLevel.H
        });
      } catch (error) {
        debugError('ç”Ÿæˆ QR Code å¤±è´¥:', error);
        qrcodeDiv.innerHTML = '<p>ç„¡æ³•ç”Ÿæˆ QR Code</p>';
      }
    }

    function startQRExpiryTimer() {
      if (qrRefreshTimer) {
        clearInterval(qrRefreshTimer);
      }
      
      let seconds = 120;
      const expiryEl = document.getElementById('qrExpiry');
      
      qrRefreshTimer = setInterval(() => {
        seconds--;
        if (seconds > 0) {
          expiryEl.textContent = `æ­¤ QR å°‡åœ¨ ${Math.floor(seconds / 60)} åˆ† ${seconds % 60} ç§’å¾ŒéæœŸ`;
        } else {
          expiryEl.textContent = 'QR Code å·²éæœŸï¼Œè«‹é»æ“Šé‡æ–°æ•´ç†';
          clearInterval(qrRefreshTimer);
        }
      }, 1000);
    }

    function getWalletAddress() {
      if (!session || !session.namespaces || !session.namespaces.eip155) {
        return null;
      }
      const accounts = session.namespaces.eip155.accounts;
      if (accounts && accounts.length > 0) {
        return accounts[0].split(':')[2];
      }
      return null;
    }

    function showWalletInfo(address) {
      const walletInfo = document.getElementById('walletInfo');
      const walletAddress = document.getElementById('walletAddress');
      walletInfo.style.display = 'block';
      walletAddress.textContent = address;
    }

    // è¿æ¥ TronLinkï¼ˆå‚è€ƒ SunSwap å®ç°æ–¹å¼ï¼‰
    async function connectTronLink() {
      try {
        // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„æˆæƒçŠ¶æ€ï¼ˆä»…åœ¨ PWA æ¨¡å¼ä¸‹ï¼‰
        if (isPWAMode()) {
          const savedAuth = AuthStorage.load();
          if (savedAuth && savedAuth.walletType === 'tronlink' && savedAuth.walletAddress) {
            debugLog('å‘ç°ä¿å­˜çš„æˆæƒçŠ¶æ€ï¼Œå°è¯•è‡ªåŠ¨é‡è¿...');
            updateStatus('info', 'æ­£åœ¨ä½¿ç”¨å·²ä¿å­˜çš„æˆæ¬Š...');
            
            // éªŒè¯é’±åŒ…æ˜¯å¦ä»ç„¶å¯ç”¨
            if (window.tronWeb || (window.tronLink && window.tronLink.tronWeb)) {
              try {
                // å°è¯•ä½¿ç”¨ä¿å­˜çš„åœ°å€ç›´æ¥ç™»å½•ï¼ˆå¦‚æœé’±åŒ…ä»ç„¶è¿æ¥ï¼‰
                await performLogin(savedAuth.walletAddress);
                return;
              } catch (e) {
                debugWarn('ä½¿ç”¨ä¿å­˜çš„æˆæƒå¤±è´¥ï¼Œé‡æ–°è¿æ¥:', e);
                AuthStorage.clear();
              }
            }
          }
        }
        
        // æ£€æµ‹ TronLinkï¼ˆå‚è€ƒ SunSwap æ–¹å¼ï¼ŒPWA æ¨¡å¼ä¸‹éœ€è¦æ›´é•¿çš„ç­‰å¾…æ—¶é—´ï¼‰
        updateStatus('info', 'æ­£åœ¨é€£æ¥ TronLink...');
        
        // åœ¨ PWA æ¨¡å¼ä¸‹ï¼Œç­‰å¾…æ›´é•¿æ—¶é—´è®© TronLink æ³¨å…¥ï¼ˆæœ€å¤šç­‰å¾… 5 ç§’ï¼‰
        const maxWaitTime = isPWAMode() ? 50 : 30;
        let tronWebDetected = false;
        
        for (let i = 0; i < maxWaitTime; i++) {
          // æ£€æŸ¥ window.tronWebï¼ˆæ–°ç‰ˆæœ¬ï¼‰
          if (window.tronWeb) {
            tronWeb = window.tronWeb;
            tronWebDetected = true;
            debugLog('æª¢æ¸¬åˆ° window.tronWeb');
            break;
          } 
          // æ£€æŸ¥ window.tronLink.tronWebï¼ˆæ—§ç‰ˆæœ¬ï¼‰
          else if (window.tronLink && window.tronLink.tronWeb) {
            tronWeb = window.tronLink.tronWeb;
            tronWebDetected = true;
            debugLog('æª¢æ¸¬åˆ° window.tronLink.tronWeb');
            break;
          }
          
          // åœ¨ PWA æ¨¡å¼ä¸‹ï¼Œæ¯ 100ms æ£€æŸ¥ä¸€æ¬¡
          await new Promise((resolve) => setTimeout(resolve, 100));
        }
        
        if (!tronWebDetected || !tronWeb) {
          // åœ¨ PWA æ¨¡å¼ä¸‹ï¼Œå¦‚æœæ£€æµ‹ä¸åˆ°æ‰©å±•ï¼Œå°è¯•è§¦å‘ TronLink æ³¨å…¥
          if (isPWAMode()) {
            debugLog('PWA æ¨¡å¼ä¸‹æœªæª¢æ¸¬åˆ° TronLinkï¼Œå˜—è©¦è§¸ç™¼æ³¨å…¥...');
            // å°è¯•é€šè¿‡è®¿é—® tronWeb å±æ€§æ¥è§¦å‘æ³¨å…¥
            try {
              if (window.tronLink && typeof window.tronLink.request === 'function') {
                // å°è¯•è°ƒç”¨ request æ–¹æ³•ï¼Œå¯èƒ½ä¼šè§¦å‘ TronLink æ³¨å…¥
                await window.tronLink.request({ method: 'tron_requestAccounts' }).catch(() => {});
                // å†æ¬¡æ£€æŸ¥
                if (window.tronWeb) {
                  tronWeb = window.tronWeb;
                  tronWebDetected = true;
                } else if (window.tronLink && window.tronLink.tronWeb) {
                  tronWeb = window.tronLink.tronWeb;
                  tronWebDetected = true;
                }
              }
            } catch (e) {
              debugWarn('è§¸ç™¼ TronLink æ³¨å…¥å¤±æ•—:', e);
            }
          }
          
          if (!tronWebDetected || !tronWeb) {
            if (isPWAMode() || isMobileDevice()) {
              throw new Error('æœªæª¢æ¸¬åˆ° TronLinkã€‚è«‹ç¢ºä¿å·²å®‰è£ä¸¦è§£é– TronLink ç€è¦½å™¨æ“´å±•ï¼Œæˆ–ä½¿ç”¨ TronLink æ‰‹æ©Ÿ Appã€‚');
            }
            throw new Error('æœªæª¢æ¸¬åˆ° TronLinkã€‚è«‹å®‰è£ TronLink ç€è¦½å™¨æ“´å±•ã€‚');
          }
        }

        // ç­‰å¾… TronWeb å°±ç»ªï¼ˆå‚è€ƒ SunSwap æ–¹å¼ï¼‰
        if (!tronWeb.ready) {
          await new Promise((resolve, reject) => {
            const checkReady = setInterval(() => {
              if (tronWeb && tronWeb.ready) {
                clearInterval(checkReady);
                resolve();
              }
            }, 100);
            
            // 10 ç§’è¶…æ—¶
            setTimeout(() => {
              clearInterval(checkReady);
              reject(new Error('TronLink åˆå§‹åŒ–è¶…æ™‚'));
            }, 10000);
          });
        }

        isTronLink = true;

        // è¯·æ±‚è´¦æˆ·è¿æ¥ï¼ˆå‚è€ƒ SunSwap æ–¹å¼ï¼‰
        let account = tronWeb.defaultAddress?.base58;
        
        if (!account) {
          try {
            // ä½¿ç”¨ request æ–¹æ³•è¯·æ±‚è´¦æˆ·ï¼ˆç±»ä¼¼ SunSwapï¼‰
            if (tronWeb.request) {
              await tronWeb.request({
                method: 'tron_requestAccounts'
              });
            } else {
              // å…¼å®¹æ—§ç‰ˆæœ¬ TronLink
              await new Promise((resolve) => setTimeout(resolve, 500));
            }
            
            account = tronWeb.defaultAddress?.base58;
          } catch (e) {
            debugWarn('TronLink request å¤±è´¥:', e);
            // å¦‚æœ request å¤±è´¥ï¼Œå°è¯•ç›´æ¥è·å–
            account = tronWeb.defaultAddress?.base58;
          }
          
          if (!account) {
            throw new Error('ç”¨æˆ¶æ‹’çµ•é€£æ¥æˆ–æœªé¸æ“‡è³¬æˆ¶');
          }
        }

        const walletAddress = account;
        updateStatus('success', 'TronLink é€£æ¥æˆåŠŸï¼');
        showWalletInfo(walletAddress);
        
        // ä¿å­˜æˆæƒçŠ¶æ€ï¼ˆä»…åœ¨ PWA æ¨¡å¼ä¸‹ï¼‰
        if (isPWAMode()) {
          AuthStorage.save(walletAddress, 'tronlink', 'TRC20');
        }
        
        sendEventToFlutter('connected', { 
          walletAddress: walletAddress,
          isTronLink: true,
          chain: 'TRC20'
        });

        await performLogin(walletAddress);
      } catch (error) {
        debugError('é€£æ¥ TronLink å¤±æ•—:', error);
        if (error.code === 4001 || 
            error.message?.includes('rejected') || 
            error.message?.includes('denied') ||
            error.message?.includes('æ‹’çµ•')) {
          updateStatus('info', 'å·²å–æ¶ˆé€£æ¥');
          return;
        }
        updateStatus('error', 'é€£æ¥å¤±æ•—: ' + error.message);
        sendEventToFlutter('error', { error: error.message });
      }
    }

    // è¿æ¥æµè§ˆå™¨æ‰©å±•
    async function connectBrowserExtension() {
      try {
        if (!ethereumProvider) {
          throw new Error('æœªæª¢æ¸¬åˆ°ç€è¦½å™¨æ“´å……åŠŸèƒ½');
        }

        updateStatus('info', 'æ­£åœ¨é€£æ¥ç€è¦½å™¨æ“´å……åŠŸèƒ½...');
        isBrowserExtension = true;

        const accounts = await ethereumProvider.request({
          method: 'eth_requestAccounts'
        });

        if (!accounts || accounts.length === 0) {
          throw new Error('ç”¨æˆ¶æ‹’çµ•é€£æ¥');
        }

        const walletAddress = accounts[0];
        updateStatus('success', 'éŒ¢åŒ…é€£æ¥æˆåŠŸï¼');
        showWalletInfo(walletAddress);
        
        sendEventToFlutter('connected', { 
          walletAddress: walletAddress,
          isBrowserExtension: true
        });

        await performLogin(walletAddress);
      } catch (error) {
        debugError('é€£æ¥ç€è¦½å™¨æ“´å……åŠŸèƒ½å¤±æ•—:', error);
        if (error.code === 4001 || error.message.includes('rejected') || error.message.includes('denied')) {
          updateStatus('info', 'å·²å–æ¶ˆé€£æ¥');
          return;
        }
        updateStatus('error', 'é€£æ¥å¤±æ•—: ' + error.message);
        sendEventToFlutter('error', { error: error.message });
      }
    }

    // ç™»å½•æµç¨‹ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼‰
    async function performLogin(walletAddress) {
      try {
        updateStatus('info', 'æ­¥é©Ÿ 1/4: ç²å–é©—è­‰ä¿¡æ¯');
        
        const nonceData = await getNonce(walletAddress);
        updateStatus('info', 'æ­¥é©Ÿ 2/4: ç°½åæ¶ˆæ¯');
        const signature = await signMessage(nonceData, walletAddress);
        updateStatus('info', 'æ­¥é©Ÿ 3/4: é©—è­‰ç™»éŒ„');
        const loginData = await verifyAndLogin(walletAddress, signature, nonceData);
        await handleLoginSuccess(loginData);
      } catch (error) {
        handleLoginError(error);
      }
    }

    async function getNonce(walletAddress) {
      const nonceResponse = await fetch(`${CONFIG.apiBaseUrl}/auth/wallet-connect/nonce`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          walletAddress: walletAddress
        })
      });

      if (!nonceResponse.ok) {
        throw new Error('ç²å– nonce å¤±æ•—: ' + nonceResponse.statusText);
      }

      const data = await nonceResponse.json();
      
      if (data.message && (!data.nonce || data.nonce === '')) {
        if (data.message.includes('Nonce:')) {
          const nonceMatch = data.message.match(/Nonce:\s*([^\n]+)/);
          if (nonceMatch && nonceMatch[1]) {
            data.nonce = nonceMatch[1].trim();
          }
        }
      }
      
      if (data.message && !data.timestamp) {
        if (data.message.includes('Timestamp:')) {
          const timestampMatch = data.message.match(/Timestamp:\s*([^\n]+)/);
          if (timestampMatch && timestampMatch[1]) {
            const timestamp = parseInt(timestampMatch[1].trim());
            if (!isNaN(timestamp)) {
              data.timestamp = timestamp;
            }
          }
        }
      }
      
      if (!data.message || data.message === '') {
        throw new Error('ç²å– nonce å¤±æ•—ï¼šç¼ºå°‘ message å­—æ®µ');
      }
      
      if (!data.nonce || data.nonce === '') {
        throw new Error('ç²å– nonce å¤±æ•—ï¼šç¼ºå°‘ nonce å­—æ®µ');
      }
      
      if (!data.timestamp) {
        data.timestamp = Math.floor(Date.now() / 1000);
      }

      sendEventToFlutter('nonce_received', { nonce: data.nonce });
      return data;
    }

    async function signMessage(nonceData, walletAddress) {
      updateStatus('info', 'è«‹åœ¨éŒ¢åŒ…ä¸­ç°½åæ¶ˆæ¯...');

      if (isTronLink && tronWeb) {
        return await signWithTronLink(nonceData);
      } else if (isBrowserExtension && ethereumProvider) {
        return await signWithBrowserExtension(nonceData);
      } else {
        return await signWithWalletConnect(nonceData);
      }
    }

    async function signWithBrowserExtension(nonceData) {
      try {
        const accounts = await ethereumProvider.request({ method: 'eth_accounts' });
        if (!accounts || accounts.length === 0) {
          throw new Error('æœªæ‰¾åˆ°é€£æ¥çš„å¸³æˆ¶');
        }
        
        const account = accounts[0];
        const signPromise = ethereumProvider.request({
          method: 'personal_sign',
          params: [nonceData.message, account]
        });
        
        const timeoutPromise = new Promise((_, reject) => {
          setTimeout(() => {
            reject(new Error('ç°½åè«‹æ±‚è¶…æ™‚ï¼ˆ60ç§’ï¼‰'));
          }, 60000);
        });
        
        const signature = await Promise.race([signPromise, timeoutPromise]);
        return signature;
      } catch (signError) {
        if (signError.code === 4001 || 
            signError.message?.includes('rejected') || 
            signError.message?.includes('denied') || 
            signError.message?.includes('User rejected')) {
          updateStatus('info', 'ç°½åå·²å–æ¶ˆ');
          sendEventToFlutter('error', { error: 'ç”¨æˆ¶å–æ¶ˆç°½å' });
          throw new Error('USER_CANCELLED');
        }
        debugError('âŒ æµè§ˆå™¨æ‰©å±•ç­¾åå¤±è´¥:', signError);
        throw signError;
      }
    }

    // TronLink ç­¾åï¼ˆå‚è€ƒ SunSwap å®ç°æ–¹å¼ï¼‰
    async function signWithTronLink(nonceData) {
      try {
        if (!tronWeb || !tronWeb.ready) {
          if (isPWAMode()) {
            throw new Error('TronLink æœªå°±ç·’ã€‚è«‹ç¢ºä¿ TronLink æ“´å±•å·²æ­£ç¢ºå®‰è£ä¸¦å·²è§£é–ã€‚');
          }
          throw new Error('TronLink æœªå°±ç·’');
        }

        const account = tronWeb.defaultAddress?.base58;
        if (!account) {
          throw new Error('æœªæ‰¾åˆ° TronLink è³¬æˆ¶');
        }

        let signature;
        
        // ä¼˜å…ˆä½¿ç”¨ signMessageV2ï¼ˆå‚è€ƒ SunSwap æ–¹å¼ï¼‰
        if (tronWeb.trx && typeof tronWeb.trx.signMessageV2 === 'function') {
          const timeoutPromise = new Promise((_, reject) => {
            setTimeout(() => {
              reject(new Error('ç°½åè«‹æ±‚è¶…æ™‚ï¼ˆ60ç§’ï¼‰'));
            }, 60000);
          });
          
          const signPromise = tronWeb.trx.signMessageV2(nonceData.message);
          const result = await Promise.race([signPromise, timeoutPromise]);
          
          signature = result.signature || result;
          
          // å¤„ç†ç­¾åç»“æœ
          if (typeof signature === 'object' && signature !== null) {
            signature = signature.signature || signature.result || JSON.stringify(signature);
          }
          
          if (typeof signature !== 'string') {
            signature = String(signature);
          }
          
          // ç¡®ä¿ç­¾åæ ¼å¼æ­£ç¡®ï¼ˆæ·»åŠ  0x å‰ç¼€å¦‚æœéœ€è¦ï¼‰
          if (signature && !signature.startsWith('0x') && /^[0-9a-fA-F]+$/.test(signature)) {
            signature = '0x' + signature;
          }
        } 
        // ä½¿ç”¨ request æ–¹æ³•ï¼ˆå‚è€ƒ SunSwap æ–¹å¼ï¼‰
        else if (tronWeb.request && typeof tronWeb.request === 'function') {
          const result = await tronWeb.request({
            method: 'tron_signMessage',
            params: {
              message: nonceData.message,
              address: account
            }
          });
          
          signature = result.signature || result;
          
          if (typeof signature === 'object' && signature !== null) {
            signature = signature.signature || signature.result || JSON.stringify(signature);
          }
          
          if (typeof signature !== 'string') {
            signature = String(signature);
          }
          
          // ç¡®ä¿ç­¾åæ ¼å¼æ­£ç¡®
          if (signature && !signature.startsWith('0x') && /^[0-9a-fA-F]+$/.test(signature)) {
            signature = '0x' + signature;
          }
        } 
        // å¦‚æœéƒ½ä¸æ”¯æŒï¼ŒæŠ›å‡ºé”™è¯¯
        else {
          throw new Error('TronLink ç°½åæ–¹æ³•ä¸å¯ç”¨ã€‚è«‹ç¢ºä¿ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„ TronLinkã€‚');
        }
        
        if (!signature || signature.length === 0) {
          throw new Error('ç°½åçµæœç‚ºç©º');
        }
        
        return signature;
      } catch (signError) {
        if (signError.code === 4001 || 
            signError.message?.includes('rejected') || 
            signError.message?.includes('denied') || 
            signError.message?.includes('User rejected') ||
            signError.message?.includes('User cancel') ||
            signError.message?.includes('cancelled')) {
          updateStatus('info', 'ç°½åå·²å–æ¶ˆ');
          sendEventToFlutter('error', { error: 'ç”¨æˆ¶å–æ¶ˆç°½å' });
          throw new Error('USER_CANCELLED');
        }
        debugError('âŒ TronLink ç­¾åå¤±è´¥:', signError);
        throw signError;
      }
    }

    async function signWithWalletConnect(nonceData) {
      let chainId = 'eip155:1';
      const availableChains = session.namespaces.eip155.chains || [];
      
      if (availableChains.includes('eip155:1')) {
        chainId = 'eip155:1';
      } else if (availableChains.includes('eip155:56')) {
        chainId = 'eip155:56';
      } else if (availableChains.length > 0) {
        chainId = availableChains[0];
      }
      
      const account = session.namespaces.eip155.accounts[0];
      
      try {
        const signature = await signClient.request({
          topic: session.topic,
          chainId: chainId,
          request: {
            method: 'personal_sign',
            params: [nonceData.message, account]
          }
        });
        return signature;
      } catch (signError) {
        debugError('âŒ WalletConnect ç­¾åå¤±è´¥:', signError);
        throw signError;
      }
    }

    async function verifyAndLogin(walletAddress, signature, nonceData) {
      updateStatus('info', 'ç°½åæˆåŠŸï¼Œæ­£åœ¨é©—è­‰...');
      
      sendEventToFlutter('signature_received', {
        signature: signature,
        walletAddress: walletAddress
      });
      
      const requestBody = {
        walletAddress: walletAddress,
        signature: signature,
        nonce: nonceData.nonce,
        timestamp: nonceData.timestamp
      };
      
      if (isTronLink) {
        requestBody.chain = 'TRC20';
        requestBody.chainType = 'tron';
      }
      
      const loginResponse = await fetch(`${CONFIG.apiBaseUrl}/auth/wallet-connect/login`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestBody)
      });

      if (!loginResponse.ok) {
        const errorData = await loginResponse.json().catch(() => ({ message: loginResponse.statusText }));
        debugError('âŒ ç™»å½•å¤±è´¥:', errorData);
        throw new Error(errorData.message || 'ç™»éŒ„å¤±æ•—: ' + loginResponse.statusText);
      }

      const loginData = await loginResponse.json();
      
      if (!loginData.token || !loginData.refreshToken) {
        debugError('âŒ ç™»å½•å“åº”ä¸­ç¼ºå°‘ token');
        throw new Error(loginData.message || 'ç™»éŒ„éŸ¿æ‡‰ä¸­ç¼ºå°‘ token');
      }

      return loginData;
    }

    async function handleLoginSuccess(loginData) {
      updateStatus('success', 'ç™»å…¥æˆåŠŸï¼');
      
      sendEventToFlutter('verified', {
        token: loginData.token,
        refreshToken: loginData.refreshToken,
        user: loginData.user
      });
    }

    function handleLoginError(error) {
      if (error.message === 'USER_CANCELLED') {
        return;
      }
      
      debugError('âŒ ç™»å½•å¤±è´¥:', error);
      
      const userFriendlyMessages = {
        'timeout': 'æ“ä½œè¶…æ—¶ï¼Œè¯·é‡è¯•',
        'network': 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥',
        'User rejected': 'æ‚¨å·²å–æ¶ˆæ“ä½œ'
      };
      
      const message = userFriendlyMessages[error.message] || error.message || 'å‘ç”ŸæœªçŸ¥é”™è¯¯';
      updateStatus('error', 'ç™»éŒ„å¤±æ•—: ' + message);
      sendEventToFlutter('error', { error: message });
    }

    function sendEventToFlutter(event, data) {
      try {
        const isInIframe = window.self !== window.top;
        
        if (isInIframe && window.parent && window.parent.postMessage) {
          window.parent.postMessage({
            event: event,
            data: data
          }, window.location.origin);
        } else if (window.flutter_inappwebview && window.flutter_inappwebview.callHandler) {
          window.flutter_inappwebview.callHandler('walletConnectEvent', {
            event: event,
            data: data
          });
        } else if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.walletConnectEvent) {
          window.webkit.messageHandlers.walletConnectEvent.postMessage({
            event: event,
            data: data
          });
        }
      } catch (error) {
        debugError('âŒ å‘é€äº‹ä»¶åˆ° Flutter å¤±è´¥:', error);
      }
    }

    // åˆå§‹åŒ–ï¼ˆä¼˜åŒ–ç‰ˆï¼Œæ”¯æŒ PWA è‡ªåŠ¨é‡è¿ï¼‰
    async function init() {
      try {
        updateStatus('info', 'æ­£åœ¨æª¢æ¸¬å¯ç”¨éŒ¢åŒ…...');
        
        // åœ¨ PWA æ¨¡å¼ä¸‹ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„æˆæƒçŠ¶æ€
        if (isPWAMode()) {
          const savedAuth = AuthStorage.load();
          if (savedAuth) {
            debugLog('PWA æ¨¡å¼ä¸‹å‘ç°ä¿å­˜çš„æˆæƒ:', savedAuth);
            // ä¸è‡ªåŠ¨é‡è¿ï¼Œè®©ç”¨æˆ·é€‰æ‹©ï¼Œä½†å¯ä»¥æç¤º
            updateStatus('info', 'æª¢æ¸¬åˆ°å·²ä¿å­˜çš„æˆæ¬Šï¼Œè«‹é¸æ“‡é€£æ¥æ–¹å¼...');
          }
        }
        
        // åˆå§‹åŒ– WalletConnectï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡ï¼‰
        initWalletConnect().catch(() => {
          // é™é»˜å¤„ç†é”™è¯¯
        });
        
        // åˆå§‹åŒ–é’±åŒ…é€‰æ‹©å™¨
        await initWalletSelector();
        
        hideStatus();
      } catch (error) {
        debugError('åˆå§‹åŒ–å¤±è´¥:', error);
        updateStatus('error', 'åˆå§‹åŒ–å¤±è´¥: ' + error.message);
        sendEventToFlutter('error', { error: error.message });
      }
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', async () => {
      await init();
    });

    // é”™è¯¯å¤„ç†
    window.addEventListener('error', (event) => {
      debugError('å…¨å±€é”™è¯¯:', event.error);
      updateStatus('error', 'ç™¼ç”ŸéŒ¯èª¤: ' + (event.error?.message || 'æœªçŸ¥éŒ¯èª¤'));
      sendEventToFlutter('error', { error: event.error?.message || 'æœªçŸ¥éŒ¯èª¤' });
    });

    window.addEventListener('unhandledrejection', (event) => {
      debugError('æœªå¤„ç†çš„ Promise æ‹’ç»:', event.reason);
      updateStatus('error', 'ç™¼ç”ŸéŒ¯èª¤: ' + (event.reason?.message || 'æœªçŸ¥éŒ¯èª¤'));
      sendEventToFlutter('error', { error: event.reason?.message || 'æœªçŸ¥éŒ¯èª¤' });
    });
  </script>
</body>
</html>
