<!DOCTYPE html>
<html>
<head>
    <!-- ?ùÂ? HTML ?á‰ª∂?ÑÁ∑©Â≠òÊéß??- ?≠Ê?Á∑©Â?‰ª•‰æø Service Worker ?ïÁ? -->
    <meta http-equiv="Cache-Control" content="max-age=300, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- ?àÊú¨?ñÁ∑©Â≠òÊ?Ë≠?-->
    <meta name="cache-version" content="1.0.409">
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

    This is a placeholder for base href that will be replaced by the value of
    the `--base-href` argument provided to `flutter build`.
  -->
  <base href="/">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="A new Flutter project.">
  <meta name="version" content="1.0.409+410">

  <script>
    // Early global error diagnostics to capture exact source of prod-only failures
    (function(){
      if (window.__errorHooksInstalled) return; window.__errorHooksInstalled = true;
      window.addEventListener('error', function(event){
        try {
          console.error('[FATAL_ERROR]', {
            message: event.message,
            filename: event.filename,
            lineno: event.lineno,
            colno: event.colno,
            stack: event.error && event.error.stack || null
          });
        } catch(_) {}
      });
      window.addEventListener('unhandledrejection', function(event){
        try {
          console.error('[UNHANDLED_REJECTION]', {
            reason: (event && event.reason) || null
          });
        } catch(_) {}
      });
      console.log('[DIAG] index.html diagnostics installed, version meta:', (document.querySelector('meta[name="version"]')||{}).content);
    })();
  </script>
  
  <button id="dev-reset-btn" aria-hidden="true" tabindex="-1" style="position:absolute; left:-9999px; top:-9999px; width:1px; height:1px; opacity:0; pointer-events:auto; visibility:hidden; overflow:hidden;">reset</button>
  <script>
    // Hidden developer reset button: clears SW, caches, storages then reloads
    (function(){
      const btn = document.getElementById('dev-reset-btn');
      async function doReset(){
        try {
          if ('serviceWorker' in navigator) {
            const regs = await navigator.serviceWorker.getRegistrations();
            await Promise.all(regs.map(r => r.unregister().catch(()=>{})));
          }
          if (window.caches) {
            const keys = await caches.keys();
            await Promise.all(keys.map(k => caches.delete(k).catch(()=>{})));
          }
          try { localStorage.clear(); } catch(_) {}
          try { sessionStorage.clear(); } catch(_) {}
        } finally {
          location.reload();
        }
      }
      if (btn) {
        btn.addEventListener('click', doReset);
      }
      // Also expose for console-based manual trigger
      window.__devReset = doReset;
    })();
  </script>

  <style>
    #update-banner {
      position: fixed;
      left: 16px;
      right: 16px;
      bottom: 16px;
      z-index: 10000;
      display: none;
      padding: 10px 12px;
      border-radius: 8px;
      background: rgba(0,0,0,0.85);
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      box-shadow: 0 6px 18px rgba(0,0,0,0.35);
    }
    #update-banner button {
      margin-left: 12px;
      padding: 6px 10px;
      border: 0;
      border-radius: 6px;
      background: #6A4C93;
      color: #fff;
      cursor: pointer;
    }
  </style>

  <!-- Cross-Origin Isolation Headers for SharedArrayBuffers -->
  

  <!-- Viewport meta tags for proper mobile scaling -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="mobile-web-app-capable" content="yes">

  <!-- Material Icons Font for Web -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- iOS meta tags & icons -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Agora Market">
  
  <!-- iOS icons -->
  <link rel="apple-touch-icon" href="icons/apple-icon-precomposed.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-icon-180x180.png">
  <link rel="apple-touch-icon" sizes="152x152" href="icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="70x70" href="icons/apple-icon-70x70.png">

  <!-- iOS splash screens -->
  <link rel="apple-touch-startup-image" media="screen and (device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3)" href="splash/iPhone_14_Pro_Max_portrait.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3)" href="splash/iPhone_14_Pro_portrait.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3)" href="splash/iPhone_14_Plus_portrait.png">
  <link rel="apple-touch-startup-image" media="screen and (device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3)" href="splash/iPhone_14_portrait.png">

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/icons/favicon.ico">

  <title>Agora Market</title>
  <link rel="manifest" href="manifest.json?v=1.0.409">

  <!-- WASM Ê®°Â?Ë≠¶Â? -->
  <script>
    // Ê™¢Ê∏¨ WASM Ê®°Â?‰∏¶È°ØÁ§∫Ë≠¶??
    if (window.location.search.includes('wasm=true') || 
        window.location.href.includes('wasm') ||
        typeof WebAssembly !== 'undefined' && window.location.pathname.includes('main.dart.wasm')) {
      console.warn('WASM mode: Web Push functionality limited');
      console.warn('Recommend using standard Web mode for full functionality');
      
      // ?®È??¢Ë??•Â?È°ØÁ§∫Ë≠¶Â?
      window.addEventListener('load', function() {
        setTimeout(function() {
          if (window.UnifiedPushManager) {
            console.warn('Web Push requires manual setup in WASM mode');
            console.warn('Please execute in console: window.UnifiedPushManager.completePushSubscription()');
          }
        }, 2000);
      });
    }
  </script>
  
  <!-- Flutter Web ?°È?Á§ôËá™?ïË??ÜËÖ≥??-->
  <script>
    // Auto-accessibility handler for Flutter Web
    (function() {
      'use strict';
      
      console.log('Auto-accessibility handler loading...');
      
      // Ê™¢Ê∏¨?åÈ??äÁÑ°?úÁ??âÈ?
      function autoClickAccessibility() {
        const selectors = [
          'flt-semantics-placeholder[aria-label="Enable accessibility"]', // Most reliable
          'flt-semantics-placeholder[role="button"]',                        // Second option
          '[aria-label="Enable accessibility"]',                            // Broad search
          'button[aria-label="Enable accessibility"]',                     // Standard button
          'button[aria-label*="Enable"]'                                   // Broader button search
        ];
        
        for (const selector of selectors) {
          const element = document.querySelector(selector);
          if (element && isElementVisible(element)) {
            console.log('Auto-clicking accessibility button found via:', selector);
            
            try {
              element.click();
              return true;
            } catch (e) {
              console.warn('Error clicking accessibility button:', e);
              // ?óË©¶ dispatchEvent ‰ΩúÁÇ∫?ôÁî®?πÊ?
              try {
                const event = new Event('click', { bubbles: true, cancelable: true });
                element.dispatchEvent(event);
                return true;
              } catch (e2) {
                console.warn('Alternative click method also failed:', e2);
              }
            }
          }
        }
        return false;
      }
      
      // Ê™¢Êü•?ÉÁ??ØÂê¶?ØË?‰∏îÂèØÈªûÊ?
      function isElementVisible(element) {
        if (!element) return false;
        
        const style = window.getComputedStyle(element);
        
        // ?¥ÂØ¨È¨ÜÁ??ØË??ßÊ™¢??- ?™Ë??ÉÁ?‰∏çÂú® DOM ‰∏≠Èö±?èÂ∞±?Ø‰ª•?óË©¶ÈªûÊ?
        return style.display !== 'none' && 
               style.visibility !== 'hidden' &&
               style.opacity !== '0' &&
               !element.disabled &&
               element.tagName !== 'NOSCRIPT'; // Á¢∫‰?‰∏çÊòØ noscript
            
        // ÁßªÈô§?¥Ê†º?Ñ‰?ÁΩÆÂ?Â∞∫ÂØ∏Ê™¢Êü•ÔºåÂ??∫ÁÑ°?úÁ??âÈ??ØËÉΩ?´Ê??®Ë????
      }
      
      // ?™Â??ïÁ??°È?Á§ôÊ???
      function startAutoHandler() {
        let attempts = 0;
        const maxAttempts = 20; // ?™Â?ÔºöÊ?Â∞ëÂà∞ 20 Ê¨°Â?Ë©?(10 Áß?
        const interval = 500;   // ÊØ?500ms Ê™¢Êü•‰∏ÄÊ¨?
        
        const startTime = Date.now();
        
        function tryClickNow() {
          attempts++;
          console.log('Attempt', attempts, 'to detect accessibility button...');
          
          // Ê™¢Êü•?ØÂê¶?êÂ?ÈªûÊ?
          if (autoClickAccessibility()) {
            const elapsed = Date.now() - startTime;
            console.log('Accessibility auto-click successful on attempt', attempts, '(' + elapsed + 'ms)');
            return;
          }
          
          // Ê™¢Êü•?ØÂê¶?ÅÈù¢Â∑≤Á?ËºâÂÖ•ÔºàÊ??âÁÑ°?úÁ??âÈ?Ôº?
          const hasAccessibilityButton = document.querySelector('flt-semantics-placeholder[aria-label="Enable accessibility"]') ||
                                       document.querySelector('button[aria-label*="Enable"]') ||
                                       document.querySelector('[aria-label="Enable accessibility"]');
          const hasLoginForm = document.querySelector('input[type="text"]') &&
                             document.querySelector('input[type="password"]');
          const hasFlutterContent = document.querySelector('flt-scene-host') || 
                                   document.querySelector('flt-glass-pane') ||
                                   document.querySelector('canvas');
          
          // ?™Â?ÔºöÊõ¥?∫ËÉΩ?ÑÊ??çÁ?Ê≠¢Ê?‰ª?
          if (!hasAccessibilityButton && (hasLoginForm || hasFlutterContent)) {
            const elapsed = Date.now() - startTime;
            console.log('No accessibility button found, page seems loaded (' + elapsed + 'ms)');
            return;
          }
          
          // ?™Â?ÔºöÂ??úÂ?Ë©¶Ë???10 Ê¨°‰?Ê≤íÊ??æÂà∞?âÈ?ÔºåÊ??çÁ?Ê≠?
          if (attempts > 10 && !hasAccessibilityButton) {
            const elapsed = Date.now() - startTime;
            console.log('Early termination: No accessibility button detected after', attempts, 'attempts (' + elapsed + 'ms)');
            return;
          }
          
          // ?πÂà•?™Â?ÔºöÂú®Á¨?20 Ê¨°Â?Ë©¶Â?Â¢ûÂ?Ë™øË©¶‰ø°ÊÅØ
          if (attempts === 20) {
            const element = document.querySelector('flt-semantics-placeholder[aria-label="Enable accessibility"]');
            console.log('Mid-point check - Element exists:', !!element);
            if (element) {
              console.log('Element details:', {
                visible: isElementVisible(element),
                tagName: element.tagName,
                ariaLabel: element.getAttribute('aria-label')
              });
            }
          }
          
          // ÁπºÁ??óË©¶
          if (attempts < maxAttempts) {
            setTimeout(tryClickNow, interval);
          } else {
            const elapsed = Date.now() - startTime;
            console.log('Accessibility auto-click failed after', attempts, 'attempts over', elapsed + 'ms');
            console.log('Manual trigger available: autoClickAccessibility() or window.manualAccessibilityTrigger()');
            
            // Ëº∏Âá∫?ÄÁµÇÁ??ãÁµ±Ë®?
            console.log('Final stats:', {
              attempts: attempts,
              totalTime: elapsed + 'ms',
              documentReady: document.readyState,
              hasAccessibilityButton: hasAccessibilityButton,
              hasLoginForm: hasLoginForm
            });
          }
        }
        
        // ?ãÂ??óË©¶
        console.log('Starting accessibility auto-handler...');
        tryClickNow();
      }
      
      // DOM ËºâÂÖ•ÂÆåÊ?ÂæåÈ?ÂßãË???
      function initAutoHandler() {
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', startAutoHandler);
        } else {
          // DOM Â∑≤Á?ËºâÂÖ•ÂÆåÊ?ÔºåÂª∂?≤Â??ï‰ª•Á≠âÂ? Flutter
          setTimeout(startAutoHandler, 100);
        }
      }
      
      // Á´ãÂç≥?ùÂ???
      initAutoHandler();
      
      console.log('Auto-accessibility handler initialized');
      
      // ?¥Èú≤?ãÂ?Ëß∏Áôº?ΩÊï∏?∞ÂÖ®Â±ÄÔºåÊñπ‰æøË™øË©?
      window.manualAccessibilityTrigger = autoClickAccessibility;
    })();
  </script>
  
  <style>
    /* Loading screen styles */
    #loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1A1A1A 0%, #2D2D2D 100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      pointer-events: none;
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      overflow: hidden;
    }

    /* Animated background */
    #loading-screen::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: 
        radial-gradient(circle at 20% 20%, rgba(170, 149, 220, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(123, 95, 184, 0.2) 0%, transparent 50%),
        radial-gradient(circle at 40% 60%, rgba(106, 76, 147, 0.25) 0%, transparent 50%);
      animation: intensePulse 2s ease-in-out infinite;
    }
    
    #loading-screen::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        linear-gradient(45deg, transparent 30%, rgba(170, 149, 220, 0.1) 50%, transparent 70%),
        linear-gradient(-45deg, transparent 30%, rgba(123, 95, 184, 0.1) 50%, transparent 70%);
      animation: shimmerWave 3s linear infinite;
    }
    
    @keyframes intensePulse {
      0%, 100% { 
        transform: scale(1) rotate(0deg); 
        opacity: 0.6; 
      }
      25% { 
        transform: scale(1.2) rotate(90deg); 
        opacity: 0.8; 
      }
      50% { 
        transform: scale(1.1) rotate(180deg); 
        opacity: 1; 
      }
      75% { 
        transform: scale(1.3) rotate(270deg); 
        opacity: 0.7; 
      }
    }
    
    @keyframes shimmerWave {
      0% { transform: translateX(-100%) translateY(-100%); }
      100% { transform: translateX(100%) translateY(100%); }
    }
    
    .loading-container {
      position: relative;
      z-index: 1;
      text-align: center;
    }
    
    .loading-logo {
      width: 120px;
      height: 120px;
      margin: 0 auto 32px;
      background: 
        linear-gradient(135deg, #AA95DC 0%, #9B7EDE 20%, #8E7CC3 40%, #7B5FB8 60%, #6A4C93 80%, #5A3A7A 100%),
        radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.2) 0%, transparent 50%);
      border-radius: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 
        0 12px 40px rgba(170, 149, 220, 0.4),
        0 6px 20px rgba(123, 95, 184, 0.3),
        0 3px 10px rgba(106, 76, 147, 0.2),
        inset 0 2px 0 rgba(255, 255, 255, 0.2),
        inset 0 -2px 0 rgba(0, 0, 0, 0.1);
      animation: intenseFloat 1.5s ease-in-out infinite;
      position: relative;
      overflow: hidden;
      border: 2px solid rgba(170, 149, 220, 0.3);
    }
    
    .loading-logo::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: 
        conic-gradient(from 0deg, transparent, rgba(255, 255, 255, 0.3), transparent),
        radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
      animation: intenseShimmer 2s linear infinite;
    }
    
    .loading-logo::after {
      content: '';
      position: absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      bottom: 10px;
      background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
      border-radius: 20px;
      animation: innerGlow 2.5s ease-in-out infinite;
    }
    
    @keyframes intenseFloat {
      0%, 100% { 
        transform: translateY(0px) scale(1) rotate(0deg); 
      }
      25% { 
        transform: translateY(-15px) scale(1.05) rotate(1deg); 
      }
      50% { 
        transform: translateY(-20px) scale(1.1) rotate(0deg); 
      }
      75% { 
        transform: translateY(-10px) scale(1.05) rotate(-1deg); 
      }
    }
    
    @keyframes intenseShimmer {
      0% { transform: rotate(0deg) scale(1); opacity: 0.3; }
      50% { transform: rotate(180deg) scale(1.2); opacity: 0.8; }
      100% { transform: rotate(360deg) scale(1); opacity: 0.3; }
    }
    
    @keyframes innerGlow {
      0%, 100% { opacity: 0.1; transform: scale(1); }
      50% { opacity: 0.3; transform: scale(1.1); }
    }
    
    .loading-logo img {
      width: 70px;
      height: 70px;
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
      object-fit: contain;
      filter: 
        drop-shadow(0 6px 12px rgba(170, 149, 220, 0.5)) 
        drop-shadow(0 3px 6px rgba(123, 95, 184, 0.3))
        brightness(1.2) 
        contrast(1.3) 
        saturate(1.4)
        hue-rotate(10deg);
      transition: all 0.3s ease;
      position: relative;
      z-index: 3;
      animation: iconPulse 2s ease-in-out infinite;
    }
    
    .loading-logo:hover img {
      filter: 
        drop-shadow(0 8px 16px rgba(170, 149, 220, 0.7)) 
        drop-shadow(0 4px 8px rgba(123, 95, 184, 0.5))
        brightness(1.4) 
        contrast(1.5) 
        saturate(1.6)
        hue-rotate(20deg);
      transform: scale(1.1);
    }
    
    @keyframes iconPulse {
      0%, 100% { 
        transform: scale(1) rotate(0deg); 
        filter: 
          drop-shadow(0 6px 12px rgba(170, 149, 220, 0.5)) 
          brightness(1.2) 
          contrast(1.3) 
          saturate(1.4);
      }
      50% { 
        transform: scale(1.05) rotate(2deg); 
        filter: 
          drop-shadow(0 8px 16px rgba(170, 149, 220, 0.6)) 
          brightness(1.3) 
          contrast(1.4) 
          saturate(1.5);
      }
    }
    
    .loading-text {
      font-size: 28px;
      font-weight: 700;
      color: white;
      margin-top: 20px;
      text-shadow: 
        0 3px 6px rgba(0, 0, 0, 0.4),
        0 1px 3px rgba(170, 149, 220, 0.3),
        0 0 20px rgba(170, 149, 220, 0.2);
      animation: textGlow 3s ease-in-out infinite;
      letter-spacing: 2px;
      text-transform: uppercase;
      background: linear-gradient(45deg, #ffffff, #f0f0f0, #ffffff);
      background-size: 200% 200%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: textGlow 3s ease-in-out infinite, textShimmer 2s linear infinite;
    }
    
    @keyframes textGlow {
      0%, 100% { 
        text-shadow: 
          0 3px 6px rgba(0, 0, 0, 0.4),
          0 1px 3px rgba(170, 149, 220, 0.3),
          0 0 20px rgba(170, 149, 220, 0.2);
      }
      50% { 
        text-shadow: 
          0 4px 8px rgba(0, 0, 0, 0.5),
          0 2px 4px rgba(170, 149, 220, 0.5),
          0 0 30px rgba(170, 149, 220, 0.4);
      }
    }
    
    @keyframes textShimmer {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    .loading-version {
      font-size: 14px;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.8);
      margin-top: 8px;
      text-shadow: 
        0 2px 4px rgba(0, 0, 0, 0.3),
        0 1px 2px rgba(170, 149, 220, 0.2);
      letter-spacing: 1px;
      opacity: 0.9;
      animation: versionGlow 4s ease-in-out infinite;
    }
    
    @keyframes versionGlow {
      0%, 100% { 
        opacity: 0.7;
        text-shadow: 
          0 2px 4px rgba(0, 0, 0, 0.3),
          0 1px 2px rgba(170, 149, 220, 0.2);
      }
      50% { 
        opacity: 1;
        text-shadow: 
          0 3px 6px rgba(0, 0, 0, 0.4),
          0 2px 4px rgba(170, 149, 220, 0.3),
          0 0 15px rgba(170, 149, 220, 0.2);
      }
    }
    
    /* Hide loading screen when Flutter is ready */
    .flutter-ready #loading-screen {
      opacity: 0;
      visibility: hidden;
      transform: scale(0.95);
      transition: opacity 0.8s ease-out, visibility 0.8s ease-out, transform 0.8s ease-out;
    }
  </style>
</head>
<body>
  <!-- Loading screen -->
  <div id="loading-screen">
    <div class="loading-container">
      <div class="loading-logo">
        <img src="icons/agora-market-icon.svg" alt="Agora Market" />
      </div>
      <div class="loading-text" id="loading-text">Agora Market</div>
      <div class="loading-version" id="version-display">v1.0.408</div>
    </div>
  </div>
  
  <!-- Reverted: remove external scripts that caused production errors -->
  
  <!-- Web Push JavaScript API -->
  <script>
    // Web Push Ê¨äÈ?Ë´ãÊ??áË???API
    (function() {
      'use strict';
      
      console.log('[WEB_PUSH_API] Web Push API initializing...');
      
      // ?®Â? Web Push API Â∞çË±°
      window.WebPushAPI = {
        
        /**
         * Ë´ãÊ??öÁü•Ê¨äÈ?
         * @param {string} vapidKey - VAPID ?¨Èë∞ (‰øùÁ??ÉÊï∏‰ª•‰??ÅÊé•??ÖºÂÆ?
         * @param {string} token - Ë™çË? token (‰øùÁ??ÉÊï∏‰ª•‰??ÅÊé•??ÖºÂÆ?
         * @returns {Promise<Object>} Ê¨äÈ?ÁµêÊ? (Á¥?JSON ?©‰ª∂)
         */
        async requestNotificationPermission(vapidKey, token) {
          console.log('[WEB_PUSH_API] Starting permission request process...');
          console.log('[WEB_PUSH_API] VAPID Key:', vapidKey ? 'provided' : 'not provided');
          console.log('[WEB_PUSH_API] Token:', token ? 'provided' : 'not provided');
          
          try {
            // 1. Ê™¢Êü•?èË¶Ω?®ÊîØ??
            if (!this.checkBrowserSupport()) {
              throw new Error('Browser does not support Web Push');
            }
            
            // 2. Ë´ãÊ??öÁü•Ê¨äÈ?
            const permissionResult = await this.requestPermission();
            console.log('[WEB_PUSH_API] Permission request result:', permissionResult);
            
            if (permissionResult !== 'granted') {
              return {
                success: false,
                status: permissionResult,
                error: 'Permission denied: ' + permissionResult
              };
            }
            
            // 3. ?µÂª∫?üÂØ¶?®ÈÄÅË???
            const subscriptionData = await this.createPushSubscription(vapidKey);
            console.log('[WEB_PUSH_API] Push subscription created successfully');
            
            // ËøîÂ? JSON Â≠óÁ¨¶‰∏≤Ô??øÂ?È°ûÂ?ËΩâÊ??èÈ?
            const result = {
              success: true,
              status: 'permission_granted',
              subscriptionData: subscriptionData
            };
            console.log('[WEB_PUSH_API] Returning result:', result);
            return JSON.stringify(result);
            
          } catch (error) {
            console.error('[WEB_PUSH_API] Permission request failed:', error);
            const errorResult = {
              success: false,
              status: 'permission_error',
              error: error.message
            };
            console.log('[WEB_PUSH_API] Returning error result:', errorResult);
            return JSON.stringify(errorResult);
          }
        },
        
        /**
         * Ê™¢Êü•?èË¶Ω?®ÊîØ??
         * @returns {boolean} ?ØÂê¶?ØÊè¥
         */
        checkBrowserSupport() {
          const hasServiceWorker = 'serviceWorker' in navigator;
          const hasPushManager = 'PushManager' in window;
          const hasNotification = 'Notification' in window;
          
          console.log('[WEB_PUSH_API] Browser support check:');
          console.log('  - Service Worker:', hasServiceWorker);
          console.log('  - Push Manager:', hasPushManager);
          console.log('  - Notification:', hasNotification);
          
          return hasServiceWorker && hasPushManager && hasNotification;
        },
        
        /**
         * Ë´ãÊ??öÁü•Ê¨äÈ?
         * @returns {Promise<string>} Ê¨äÈ??Ä??
         */
        async requestPermission() {
          console.log('[WEB_PUSH_API] Requesting notification permission...');
          
          if (Notification.permission === 'granted') {
            console.log('[WEB_PUSH_API] Permission already granted');
            return 'granted';
          }
          
          if (Notification.permission === 'denied') {
            console.log('[WEB_PUSH_API] Permission already denied');
            return 'denied';
          }
          
          // Ë´ãÊ?Ê¨äÈ?
          const permission = await Notification.requestPermission();
          console.log('[WEB_PUSH_API] Permission request result:', permission);
          
          return permission;
        },
        
        /**
         * ?µÂª∫?®ÈÄÅË???
         * @param {string} vapidKey - VAPID ?¨Èë∞
         * @returns {Promise<Object>} Ë®ÇÈñ±?∏Ê?
         */
        async createPushSubscription(vapidKey) {
          console.log('[WEB_PUSH_API] Starting push subscription creation...');
          
          try {
            // 1. ?ñÂ??æÊ??ÑÔ?FlutterÔºâService Worker Ë®ªÂ?
            const registration = await navigator.serviceWorker.ready;
            console.log('[WEB_PUSH_API] Using existing Service Worker registration');
            
            // 2. ?µÂª∫?®ÈÄÅË???
            const subscription = await registration.pushManager.subscribe({
              userVisibleOnly: true,
              applicationServerKey: this.urlBase64ToUint8Array(vapidKey)
            });
            
            console.log('[WEB_PUSH_API] Push subscription created successfully');
            console.log('[WEB_PUSH_API] Subscription endpoint:', subscription.endpoint);
            
            // 3. ËΩâÊ??∫ÂèØ?≥Ëº∏?ÑÊ†ºÂº?
            const deviceInfo = this.generateDeviceInfo();
            const subscriptionData = {
              endpoint: subscription.endpoint,
              keys: {
                p256dh: this.arrayBufferToBase64(subscription.getKey('p256dh')),
                auth: this.arrayBufferToBase64(subscription.getKey('auth'))
              },
              userAgent: deviceInfo.userAgent,
              deviceType: deviceInfo.deviceType,
              deviceName: deviceInfo.deviceName
            };
            
            return subscriptionData;
            
          } catch (error) {
            console.error('[WEB_PUSH_API] Push subscription creation failed:', error);
            throw new Error('Push subscription creation failed: ' + error.message);
          }
        },
        
        /**
         * ?üÊ?Ë®≠Â?‰ø°ÊÅØ
         * @returns {Object} Ë®≠Â?‰ø°ÊÅØ
         */
        generateDeviceInfo() {
          const userAgent = navigator.userAgent;
          const deviceName = navigator.platform + ' - ' + (navigator.userAgentData?.brands?.[0]?.brand || 'Unknown Browser');
          const deviceId = this.generateDeviceId();
          const browserInfo = {
            name: navigator.userAgentData?.brands?.[0]?.brand || 'Unknown',
            version: navigator.userAgentData?.brands?.[0]?.version || 'Unknown',
            platform: navigator.platform,
            userAgent: userAgent
          };
          const screenInfo = {
            width: screen.width,
            height: screen.height,
            colorDepth: screen.colorDepth,
            pixelDepth: screen.pixelDepth
          };
          
          return {
            userAgent,
            deviceType: 'web',
            deviceName,
            deviceId,
            browserInfo,
            screenInfo
          };
        },
        
        /**
         * ?üÊ?Ë®≠Â? ID
         * @returns {string} Ë®≠Â? ID
         */
        generateDeviceId() {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          ctx.textBaseline = 'top';
          ctx.font = '14px Arial';
          ctx.fillText('Device fingerprint', 2, 2);
          
          const fingerprint = [
            navigator.userAgent,
            navigator.language,
            screen.width + 'x' + screen.height,
            new Date().getTimezoneOffset(),
            canvas.toDataURL()
          ].join('|');
          
          // Á∞°ÂñÆ??hash ?ΩÊï∏
          let hash = 0;
          for (let i = 0; i < fingerprint.length; i++) {
            const char = fingerprint.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // ËΩâÊ???32 ‰ΩçÊï¥??
          }
          
          return Math.abs(hash).toString(36);
        },
        
        /**
         * Â∞?VAPID ?¨Èë∞ËΩâÊ???Uint8Array
         * @param {string} base64String - Base64 Â≠óÁ¨¶‰∏?
         * @returns {Uint8Array} Uint8Array
         */
        urlBase64ToUint8Array(base64String) {
          const padding = '='.repeat((4 - base64String.length % 4) % 4);
          const base64 = (base64String + padding)
            .replace(/-/g, '+')
            .replace(/_/g, '/');
          
          const rawData = window.atob(base64);
          const outputArray = new Uint8Array(rawData.length);
          
          for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
          }
          
          return outputArray;
        },
        
        /**
         * Â∞?ArrayBuffer ËΩâÊ???Base64
         * @param {ArrayBuffer} buffer - ArrayBuffer
         * @returns {string} Base64 Â≠óÁ¨¶‰∏?
         */
        arrayBufferToBase64(buffer) {
          const bytes = new Uint8Array(buffer);
          let binary = '';
          for (let i = 0; i < bytes.byteLength; i++) {
            binary += String.fromCharCode(bytes[i]);
          }
          return window.btoa(binary);
        }
      };
      
      console.log('[WEB_PUSH_API] Web Push API initialization completed');
      
      // ?¥Èú≤?®Â??ΩÊï∏‰æ?Flutter Ë™øÁî®
      window.requestNotificationPermission = window.WebPushAPI.requestNotificationPermission.bind(window.WebPushAPI);
      
    })();
  </script>
  
  <script src="flutter_bootstrap.js?v=1.0.409" async></script>
  
  <!-- Service Worker Ë®ªÂ?Ôºà‰Ωø??Flutter ?ßÂª∫ SWÔºõËá™ÂÆöÁæ© SW Â∑≤Â??®Ô? -->
  <script>
    // Ë®ªÂ?Ê∂àÊÅØ?ïÁ??®‰? Flutter Ë™øÁî®
    window.registerMessageHandler = function(callback) {
      window._messageHandler = callback;
    };

    // ?ïÁ?‰æÜËá™ Service Worker ?ÑÊ???
    window.handleServiceWorkerMessage = function(data) {
      if (window._messageHandler) {
        window._messageHandler(data);
      }
    };
  </script>
  
  <script>
    // Update version display from meta tag
    document.addEventListener('DOMContentLoaded', function() {
      console.log('[DEBUG] index.html DOMContentLoaded event triggered');
      
      const versionMeta = document.querySelector('meta[name="version"]');
      const versionDisplay = document.getElementById('version-display');
      
      if (versionMeta && versionDisplay) {
        const fullVersion = versionMeta.getAttribute('content'); // e.g., "1.0.293+294"
        const displayVersion = fullVersion ? fullVersion.split('+')[0] : '1.0.0'; // e.g., "1.0.293"
        versionDisplay.textContent = 'v' + displayVersion;
        console.log('[SUCCESS] Version number set:', displayVersion);
      }
      
      // Ê™¢Ê∏¨ localStorage ‰∏≠Á? JWT ‰∏¶È°ØÁ§∫Ë®ª?äÊ??üÊ?Á§?
      console.log('[DEBUG] Starting registration success check...');
      checkRegistrationSuccess();
      
      // ??ÅΩË®ªÂ??ÅÈù¢?ÑÊ???
      window.addEventListener('message', function(event) {
        console.log('[MESSAGE] Received message from registration page:', event.data);
        
        if (event.data.type === 'register_page_log') {
        } else if (event.data.type === 'register_success') {
          
          // Ê™¢Êü• JWT ?ØÂê¶?üÁ?‰øùÂ?‰∫?
          const accessToken = localStorage.getItem('access_token');
          const refreshToken = localStorage.getItem('refresh_token');
          const userInfo = localStorage.getItem('user_info');
          
        }
      });
    });
    
    // Ê™¢Ê∏¨Ë®ªÂ??êÂ??Ä??
    function checkRegistrationSuccess() {
      try {
        console.log('[DEBUG] Starting localStorage status check...');
        
        // Ê™¢Êü•?Ä??localStorage ?ÖÁõÆ
        const allKeys = Object.keys(localStorage);
        console.log('[DEBUG] All keys in localStorage:', allKeys);
        
        const accessToken = localStorage.getItem('access_token');
        const refreshToken = localStorage.getItem('refresh_token');
        const userInfo = localStorage.getItem('user_info');
        
        console.log('[DEBUG] Checking localStorage status:');
        console.log('  - access_token:', accessToken ? 'exists (' + accessToken.substring(0, 20) + '...)' : 'not found');
        console.log('  - refresh_token:', refreshToken ? 'exists (' + refreshToken.substring(0, 20) + '...)' : 'not found');
        console.log('  - user_info:', userInfo ? 'exists (' + userInfo.substring(0, 50) + '...)' : 'not found');
        
        // Ê™¢Êü•?ØÂê¶?â‰ªª‰ΩïÂ???'token' ?ÑÈçµ
        const tokenKeys = allKeys.filter(key => key.toLowerCase().includes('token'));
        console.log('[DEBUG] Keys containing "token":', tokenKeys);
        
        if (accessToken || refreshToken || userInfo) {
          console.log('[SUCCESS] Detected successful registration JWT token, showing success message');
          showRegistrationSuccessMessage();
        } 
      } catch (error) {
        console.warn('[ERROR] Error occurred while checking registration status:', error);
      }
    }
    
    // È°ØÁ§∫Ë®ªÂ??êÂ??êÁ§∫
    function showRegistrationSuccessMessage() {
      const loadingText = document.getElementById('loading-text');
      const versionDisplay = document.getElementById('version-display');
      
      if (!loadingText) return;
      
      console.log('[SUCCESS] Showing registration success message');
      
      // Ë™ûË?Ê™¢Ê∏¨
      function detectLang() {
        const url = new URL(window.location.href);
        const qpLang = url.searchParams.get('lang'); // e.g., zh-TW
        if (qpLang) return qpLang;
        if (document.documentElement && document.documentElement.lang) return document.documentElement.lang;
        return navigator.language || navigator.userLanguage || 'en';
      }
      
      const lang = (detectLang() || 'en').toLowerCase();
      
      // Â§öË?Â≠óÂÖ∏
      const i18n = {
        'en': {
          loadingText: 'Registration successful, logging in...',
          versionText: 'Auto-logging in...'
        },
        'zh-tw': {
          loadingText: 'Ë®ªÂ??êÂ?ÔºåÊ≠£?®Áôª?•\u2026',
          versionText: '?™Â??ªÂÖ•‰∏≠\u2026'
        },
        'zh-hant': {
          loadingText: 'Ë®ªÂ??êÂ?ÔºåÊ≠£?®Áôª?•\u2026',
          versionText: '?™Â??ªÂÖ•‰∏≠\u2026'
        },
        'zh': {
          loadingText: '\u6ce8\u518c\u6210\u529f\uff0c\u6b63\u5728\u767b\u5f55\u2026',
          versionText: '\u81ea\u52a8\u767b\u5f55\u4e2d\u2026'
        },
        'zh-cn': {
          loadingText: '\u6ce8\u518c\u6210\u529f\uff0c\u6b63\u5728\u767b\u5f55\u2026',
          versionText: '\u81ea\u52a8\u767b\u5f55\u4e2d\u2026'
        }
      };
      
      function resolveLocale(map, locale) {
        if (map[locale]) return map[locale];
        // ?óË©¶Ë™ûÁ≥ª?çÁ∂¥?πÈ?ÔºàÂ? zh-CN -> zhÔº?
        const base = locale.split('-')[0];
        if (map[base]) return map[base];
        return map['en'];
      }
      
      const t = resolveLocale(i18n, lang);
      
      // È°ØÁ§∫?¨Âú∞?ñÊ?Â≠óÔ??Ö‰∏ªË°åË??ØÔ?‰∏çÊõ¥?∞ÂâØË°åÁ??ãÔ?
      loadingText.textContent = t.loadingText;
      
      console.log('Registration success message displayed');
    }
    
    // Hide loading screen when Flutter is ready
    let loadingScreenHidden = false;
    
    function hideLoadingScreen() {
      if (loadingScreenHidden) return;
      loadingScreenHidden = true;
      document.body.classList.add('flutter-ready');
      console.log('[LOADING] Loading screen hidden');
    }
    
    window.addEventListener('flutter-first-frame', function () {
      console.log('[LOADING] Flutter first frame event received');
      // ?•Â???auto-login Âº∑‰ø°?üÔ?localStorage ??access_tokenÔºâÔ?Âª∂Èï∑?±Ë?Âª∂ÈÅ≤‰ª•Âπ≥ÊªëË∑≥ËΩ?
      const hasAutoLogin = !!(window.localStorage && window.localStorage.getItem('access_token'));
      const delayMs = hasAutoLogin ? 1500 : 800;
      setTimeout(() => {
        hideLoadingScreen();
      }, delayMs);
    });
    
    // Ê™¢Ê∏¨ Flutter ?†Ë??ØË™§
    window.addEventListener('error', function(event) {
      if (event.message && (
        event.message.includes('flutter') || 
        event.message.includes('dart') ||
        event.message.includes('main.dart')
      )) {
        console.error('[LOADING] Flutter loading error detected:', event.message);
        // ?≥‰Ωø?∫ÈåØ‰πüÂ?Ë©¶Èö±?èÂ?ËºâÂ?Âπ?
        setTimeout(() => {
          hideLoadingScreen();
        }, 2000);
      }
    });
    
    // Fallback: hide loading screen if event doesn't fire
    (function(){
      const hasAutoLogin = !!(window.localStorage && window.localStorage.getItem('access_token'));
      const fallbackMs = hasAutoLogin ? 4000 : 3500; // Á®çÂæÆÂª∂Èï∑‰ª•Á?Âæ?Flutter ?üÂ?
      
      setTimeout(() => {
        if (!loadingScreenHidden) {
          console.warn('[LOADING] Fallback: Hiding loading screen after timeout');
          hideLoadingScreen();
        }
      }, fallbackMs);
    })();
  </script>
  
  <script>
    // Update flow optimization: version persistence, reset param, SW update prompt
    (function() {
      'use strict';
      const qs = new URL(location.href).searchParams;
      const versionMeta = (document.querySelector('meta[name="version"]')||{}).content || '';
      const VERSION_KEY = 'app_version_meta';

      // Self-clean routine via ?reset=1
      if (qs.get('reset') === '1') {
        (async () => {
          try {
            console.log('[RESET] \u958b\u59cb\u6e05\u9664\u6240\u6709\u7de8\u78bc\u548c Service Worker...'); // "?ãÂ?Ê∏ÖÈô§?Ä?âÁ∑©Â≠òÂ? Service Worker..."
            if ('serviceWorker' in navigator) {
              const regs = await navigator.serviceWorker.getRegistrations();
              console.log('[RESET] \u627e\u5230', regs.length, '\u500b Service Worker \u8a3b\u518a'); // "?æÂà∞ X ??Service Worker Ë®ªÂ?"
              await Promise.all(regs.map(r => {
                console.log('[RESET] \u53d6\u6d88\u8a3b\u518a Service Worker:', r.scope); // "?ñÊ?Ë®ªÂ? Service Worker:"
                return r.unregister().catch(err => console.warn('[RESET] \u53d6\u6d88\u8a3b\u518a\u5931\u6557:', err)); // "?ñÊ?Ë®ªÂ?Â§±Ê?:"
              }));
            }
            if (window.caches) {
              const keys = await caches.keys();
              console.log('[RESET] \u627e\u5230', keys.length, '\u500b\u7de8\u78bc'); // "?æÂà∞ X ?ãÁ∑©Â≠?
              await Promise.all(keys.map(k => {
                console.log('[RESET] \u522a\u9664\u7de8\u78bc:', k); // "?™Èô§Á∑©Â?:"
                return caches.delete(k).catch(err => console.warn('[RESET] \u522a\u9664\u7de8\u78bc\u5931\u6557:', err)); // "?™Èô§Á∑©Â?Â§±Ê?:"
              }));
            }
            try { 
              localStorage.clear(); 
              console.log('[RESET] localStorage \u5df2\u6e05\u9664'); // "Â∑≤Ê???
            } catch(_) {}
            try { 
              sessionStorage.clear(); 
              console.log('[RESET] sessionStorage \u5df2\u6e05\u9664'); // "Â∑≤Ê???
            } catch(_) {}
            console.log('[RESET] \u6e05\u9664\u5b8c\u6210\uff0c\u6e96\u5099\u91cd\u65b0\u8f09\u5165...'); // "Ê∏ÖÈô§ÂÆåÊ?ÔºåÊ??ôÈ??∞Ë???.."
          } finally {
            const url = new URL(location.href);
            url.searchParams.delete('reset');
            // Ê∑ªÂ??ÇÈ??≥Á¢∫‰øù‰??É‰Ωø?®Á∑©Â≠?
            url.searchParams.set('_t', Date.now().toString());
            location.replace(url.pathname + url.search + url.hash);
          }
        })();
        return; // stop further init on this load
      }
      
      // Á∑©Â?Ê∏ÖÈô§Ê™¢Ê∏¨?çÁΩÆ
      const CACHE_CLEAR_FLAG_KEY = 'browser_cache_cleared_flag';
      const LAST_CACHE_CHECK_KEY = 'last_cache_check_time';
      const SESSION_MARKER_KEY = 'session_marker'; // ?ÉË©±Ê®ôË?
      const VERSION_MARKER_KEY = 'version_marker'; // ?àÊú¨Ê®ôË?
      const DETECTION_THRESHOLD = 2 * 60 * 1000; // 2?ÜÈ??æÂÄºÔ??¥Á≤æÁ¢∫Ô?
      
      // ?ùÂ??ñÊ™¢Ê∏¨Ê?Ë®?
      function initializeDetectionMarkers() {
        try {
          const currentTime = Date.now();
          const versionMeta = (document.querySelector('meta[name="version"]')||{}).content || '';
          
          // Ë®≠ÁΩÆ?ÉË©±Ê®ôË?ÔºàÊ?Ê¨°È??¢Ë??•ÈÉΩ‰∏çÂ?Ôº?
          const sessionMarker = `${currentTime}-${Math.random().toString(36).substr(2, 9)}`;
          sessionStorage.setItem(SESSION_MARKER_KEY, sessionMarker);
          
          // Ê™¢Êü•?àÊú¨Ê®ôË?
          const storedVersion = localStorage.getItem(VERSION_MARKER_KEY);
          if (storedVersion !== versionMeta) {
            // ?àÊú¨ËÆäÂ?ÔºåË®≠ÁΩÆÊ??§Ê?Ë®?
            localStorage.setItem(VERSION_MARKER_KEY, versionMeta);
            if (storedVersion && storedVersion !== '') {
              console.log('[CACHE_SYNC] \u6aa2\u6e2c\u5230\u7248\u672c\u8b8a\u5316:', storedVersion, '\u2192', versionMeta); // "Ê™¢Ê∏¨?∞Á??¨Ë???"
              localStorage.setItem(CACHE_CLEAR_FLAG_KEY, currentTime.toString());
              notifyServiceWorkerToClearCache();
            }
          }
          
          // Ë®≠ÁΩÆÊ™¢Êü•?ÇÈ?
          localStorage.setItem(LAST_CACHE_CHECK_KEY, currentTime.toString());
        } catch (error) {
          console.warn('[CACHE_SYNC] \u521d\u59cb\u5316\u6a19\u8a18\u5931\u6557:', error); // "?ùÂ??ñÊ?Ë®òÂ§±??"
        }
      }
      
      // Âº∑Âà∂Ê∏ÖÈô§?Ä?âÁ∑©Â≠òÂ? Service WorkerÔºàÁî®?ºÊ™¢Ê∏¨Âà∞Á∑©Â?Ê∏ÖÈô§?ÇÔ?
      async function forceClearAllCachesAndReload() {
        console.log('[CACHE_SYNC] \u5f37\u5236\u6e05\u9664\u6240\u6709\u7de8\u78bc\u548c Service Worker'); // "Âº∑Âà∂Ê∏ÖÈô§?Ä?âÁ∑©Â≠òÂ? Service Worker"
        
        try {
          // 1. ?∏Ë??Ä??Service Worker
          if ('serviceWorker' in navigator) {
            const regs = await navigator.serviceWorker.getRegistrations();
            console.log('[CACHE_SYNC] \u627e\u5230', regs.length, '\u500b Service Worker\uff0c\u6b63\u5728\u53d6\u6d88\u8a3b\u518a...'); // "?æÂà∞ X ??Service WorkerÔºåÊ≠£?®Â?Ê∂àË®ª??.."
            await Promise.all(regs.map(r => {
              console.log('[CACHE_SYNC] \u53d6\u6d88\u8a3b\u518a Service Worker:', r.scope); // "?ñÊ?Ë®ªÂ? Service Worker:"
              return r.unregister().catch(err => console.warn('[CACHE_SYNC] \u53d6\u6d88\u8a3b\u518a\u5931\u6557:', err)); // "?ñÊ?Ë®ªÂ?Â§±Ê?:"
            }));
          }
          
          // 2. Ê∏ÖÈô§?Ä?âÁ∑©Â≠?
          if ('caches' in window) {
            const cacheKeys = await caches.keys();
            console.log('[CACHE_SYNC] \u627e\u5230', cacheKeys.length, '\u500b\u7de8\u78bc\uff0c\u6b63\u5728\u522a\u9664...'); // "?æÂà∞ X ?ãÁ∑©Â≠òÔ?Ê≠?ú®?™Èô§..."
            await Promise.all(cacheKeys.map(k => {
              console.log('[CACHE_SYNC] \u522a\u9664\u7de8\u78bc:', k); // "?™Èô§Á∑©Â?:"
              return caches.delete(k).catch(err => console.warn('[CACHE_SYNC] \u522a\u9664\u7de8\u78bc\u5931\u6557:', err)); // "?™Èô§Á∑©Â?Â§±Ê?:"
            }));
          }
          
          // 3. Ê∏ÖÈô§Ê®ôË?
          try {
            localStorage.removeItem(CACHE_CLEAR_FLAG_KEY);
          } catch (e) {}
          
          console.log('[CACHE_SYNC] \u6e05\u9664\u5b8c\u6210\uff0c\u5f37\u5236\u91cd\u65b0\u8f09\u5165...'); // "Ê∏ÖÈô§ÂÆåÊ?ÔºåÂº∑?∂È??∞Ë???.."
          
          // 4. Âº∑Âà∂?çÊñ∞ËºâÂÖ•Ôºà‰Ωø??replace Á¢∫‰?‰∏çÊ??ûÈÄÄÔº?
          const url = new URL(location.href);
          url.searchParams.set('_nocache', Date.now().toString());
          location.replace(url.href);
          
        } catch (error) {
          console.error('[CACHE_SYNC] \u5f37\u5236\u6e05\u9664\u5931\u6557:', error); // "Âº∑Âà∂Ê∏ÖÈô§Â§±Ê?:"
          // ?≥‰ΩøÂ§±Ê?‰πüÂ?Ë©¶È??∞Ë???
          location.reload(true);
        }
      }
      
      // ?™Â??ÑÁ∑©Â≠òÊ??§Ê™¢Ê∏¨Ô?Â§öÈ?Ê™¢Ê∏¨ÈªûÔ?
      function detectBrowserCacheClear(forceReload = false) {
        try {
          const currentTime = Date.now();
          let shouldClear = false;
          let reason = '';
          
          // Ê™¢Ê∏¨Èª?1: Ê™¢Êü•?ÇÈ???
          const lastCheck = localStorage.getItem(LAST_CACHE_CHECK_KEY);
          if (!lastCheck) {
            // ?ÇÈ??≥‰?Â§±Ô??ØËÉΩ?ØÊ??§Á∑©Â≠?
            shouldClear = true;
            reason = '\u6642\u9593\u6233\u4e22\u5931'; // "?ÇÈ??≥‰?Â§?
          } else {
            const timeDiff = currentTime - parseInt(lastCheck, 10);
            if (timeDiff > DETECTION_THRESHOLD) {
              shouldClear = true;
              reason = `\u6642\u9593\u5dee\u7570\u5e38: ${Math.round(timeDiff / 1000)}\u79d2`; // "?ÇÈ?Â∑ÆÁï∞Â∏? XÁß?
            }
          }
          
          // Ê™¢Ê∏¨Èª?2: Ê™¢Êü•?ÉË©±Ê®ôË?ÔºàÊõ¥?ØÈ?Ôº?
          const sessionMarker = sessionStorage.getItem(SESSION_MARKER_KEY);
          if (!sessionMarker) {
            // ?ÉË©±Ê®ôË?‰∏üÂ§±ÔºàsessionStorage Ë¢´Ê??§Ô?
            shouldClear = true;
            reason = reason ? reason + ', \u6703\u8a71\u6a19\u8a18\u4e22\u5931' : '\u6703\u8a71\u6a19\u8a18\u4e22\u5931'; // "?ÉË©±Ê®ôË?‰∏üÂ§±"
          }
          
          // Ê™¢Ê∏¨Èª?3: Ê™¢Êü•?àÊú¨Ê®ôË?
          const versionMeta = (document.querySelector('meta[name="version"]')||{}).content || '';
          const storedVersion = localStorage.getItem(VERSION_MARKER_KEY);
          if (storedVersion && storedVersion !== versionMeta) {
            shouldClear = true;
            reason = reason ? reason + ', \u7248\u672c\u4e0d\u5339\u914d' : '\u7248\u672c\u4e0d\u5339\u914d'; // "?àÊú¨‰∏çÂåπ??
          }
          
          // Ê™¢Ê∏¨Èª?4: Ê™¢Êü•?∂‰??úÈçµ localStorage ?µÔ?Â¶ÇÊ?Â≠òÂú®Ôº?
          const accessToken = localStorage.getItem('access_token');
          const userInfo = localStorage.getItem('user_info');
          // Â¶ÇÊ?‰πãÂ??âÈÄô‰??∏Ê?‰ΩÜÁèæ?®Ê??âÔ?‰∏îÊ??ìÊà≥?∞Â∏∏ÔºåÂèØ?ΩÊòØÊ∏ÖÈô§Á∑©Â?
          if (shouldClear && (!accessToken && !userInfo)) {
            // ?†Âº∑?§Â?ÔºöÂ??ÇÊªøË∂≥Ê??ìÊà≥?∞Â∏∏‰∏îÈ??µÊï∏?ö‰?Â§?
            reason += ' (\u95dc\u9375\u6578\u64da\u4e22\u5931)'; // "?úÈçµ?∏Ê?‰∏üÂ§±"
          }
          
          if (shouldClear) {
            console.log('[CACHE_SYNC] \u6aa2\u6e2c\u5230\u7de8\u78bc\u6e05\u9664:', reason); // "Ê™¢Ê∏¨?∞Á∑©Â≠òÊ???"
            
            // Â¶ÇÊ?Âº∑Âà∂?çÊñ∞ËºâÂÖ•Ê®ôË???trueÔºåÊ?Ê™¢Ê∏¨?∞Ê?È°ØÁ?Ê∏ÖÈô§Á∑©Â?Ë°åÁÇ∫ÔºåÁ??≥Âü∑Ë°åÂº∑?∂Ê???
            if (forceReload || !lastCheck || !sessionMarker) {
              console.log('[CACHE_SYNC] \u767c\u73fe\u660e\u986f\u7684\u7de8\u78bc\u6e05\u9664\u8a8d\u5f97\uff0c\u5f37\u5236\u6e05\u9664\u5e76\u91cd\u65b0\u8f09\u5165'); // "?ºÁèæ?éÈ°Ø?ÑÁ∑©Â≠òÊ??§Ë??∫Ô?Âº∑Âà∂Ê∏ÖÈô§‰∏¶È??∞Ë???
              forceClearAllCachesAndReload();
              return; // Á´ãÂç≥ËøîÂ?Ôºå‰??∑Ë?ÂæåÁ??èËºØ
            }
            
            // Ë®≠ÁΩÆÊ∏ÖÈô§Ê®ôË?
            localStorage.setItem(CACHE_CLEAR_FLAG_KEY, currentTime.toString());
            notifyServiceWorkerToClearCache();
          }
          
          // ?¥Êñ∞Ê™¢Êü•?ÇÈ??åÊ?Ë®?
          localStorage.setItem(LAST_CACHE_CHECK_KEY, currentTime.toString());
          if (!sessionMarker) {
            const newSessionMarker = `${currentTime}-${Math.random().toString(36).substr(2, 9)}`;
            sessionStorage.setItem(SESSION_MARKER_KEY, newSessionMarker);
          }
          
        } catch (error) {
          console.warn('[CACHE_SYNC] \u6aa2\u6e2c\u7de8\u78bc\u6e05\u9664\u5931\u6557:', error); // "Ê™¢Ê∏¨Á∑©Â?Ê∏ÖÈô§Â§±Ê?:"
        }
      }
      
      // ?öÁü• Service Worker Ê∏ÖÈô§Á∑©Â?ÔºàÂÑ™?ñÁ???- ?çË©¶Ê©üÂà∂Ôº?
      let clearCacheRetryCount = 0;
      const MAX_RETRIES = 3;
      
      function notifyServiceWorkerToClearCache(retryDelay = 1000) {
        if (!('serviceWorker' in navigator)) {
          if (clearCacheRetryCount < MAX_RETRIES) {
            clearCacheRetryCount++;
            console.log(`[CACHE_SYNC] Service Worker \u672a\u5c31\u7e6e\uff0c${retryDelay}ms \u5f8c\u91cd\u8a66 (${clearCacheRetryCount}/${MAX_RETRIES})`); // "?™Â∞±Á∑íÔ?Xms ÂæåÈ?Ë©?
            setTimeout(() => notifyServiceWorkerToClearCache(retryDelay * 2), retryDelay);
          } else {
            console.warn('[CACHE_SYNC] Service Worker \u672a\u5c31\u7e6e\uff0c\u5df2\u9054\u5230\u6700\u5927\u91cd\u8a66\u6b21\u6578'); // "?™Â∞±Á∑íÔ?Â∑≤È??∞Ê?Â§ßÈ?Ë©¶Ê¨°??
          }
          return;
        }
        
        if (!navigator.serviceWorker.controller) {
          // Á≠âÂ? Service Worker Â∞±Á?
          navigator.serviceWorker.ready.then(function(registration) {
            if (registration.active) {
              registration.active.postMessage({
                type: 'SYNC_CLEAR_CACHE',
                timestamp: Date.now(),
                reason: 'browser_cache_cleared'
              });
              console.log('[CACHE_SYNC] \u901a\u77e5 Service Worker \u540c\u6b65\u6e05\u9664\u7de8\u78bc\uff08\u901a\u904e ready\uff09'); // "?öÁü• Service Worker ?åÊ≠•Ê∏ÖÈô§Á∑©Â?ÔºàÈÄöÈ? readyÔº?
            }
          }).catch(function(err) {
            console.warn('[CACHE_SYNC] Service Worker ready \u5931\u6557:', err); // "ready Â§±Ê?:"
          });
          return;
        }
        
        // ?çÁΩÆ?çË©¶Ë®àÊï∏
        clearCacheRetryCount = 0;
        
        console.log('[CACHE_SYNC] \u901a\u77e5 Service Worker \u540c\u6b65\u6e05\u9664\u7de8\u78bc'); // "?öÁü• Service Worker ?åÊ≠•Ê∏ÖÈô§Á∑©Â?"
        try {
          navigator.serviceWorker.controller.postMessage({
            type: 'SYNC_CLEAR_CACHE',
            timestamp: Date.now(),
            reason: 'browser_cache_cleared'
          });
        } catch (error) {
          console.error('[CACHE_SYNC] \u767c\u9001\u6d88\u606f\u5931\u6557:', error); // "?ºÈÄÅÊ??ØÂ§±??"
          // Â§±Ê??ÇÈ?Ë©?
          if (clearCacheRetryCount < MAX_RETRIES) {
            clearCacheRetryCount++;
            setTimeout(() => notifyServiceWorkerToClearCache(retryDelay * 2), retryDelay);
          }
        }
      }
      
      // ??ÅΩ‰æÜËá™ Service Worker ?ÑÊ??ØÔ??™Â??àÊú¨Ôº?
      if ('serviceWorker' in navigator) {
        let messageHandlerAttached = false;
        
        function attachMessageListener() {
          if (messageHandlerAttached) return;
          
          navigator.serviceWorker.addEventListener('message', function(event) {
            if (!event.data) return;
            
            switch (event.data.type) {
              case 'CHECK_CACHE_CLEAR_FLAG':
                const clearFlag = localStorage.getItem(CACHE_CLEAR_FLAG_KEY);
                if (clearFlag) {
                  console.log('[CACHE_SYNC] Service Worker \u8a62\u554f\u6e05\u9664\u6a19\u8a18\uff0c\u767c\u73fe\u6a19\u8a18\u5b58\u5728'); // "Ë©¢Â?Ê∏ÖÈô§Ê®ôË?ÔºåÁôº?æÊ?Ë®òÂ???
                  // Ê∏ÖÈô§Ê®ôË?‰∏¶ÈÄöÁü• SW Ê∏ÖÈô§Á∑©Â?
                  localStorage.removeItem(CACHE_CLEAR_FLAG_KEY);
                  notifyServiceWorkerToClearCache();
                }
                break;
                
              case 'CACHES_SYNC_CLEARED':
                console.log('[CACHE_SYNC] Service Worker \u5df2\u540c\u6b65\u6e05\u9664\u7de8\u78bc', // "Â∑≤Â?Ê≠•Ê??§Á∑©Â≠?
                  '\u6e05\u9664\u6642\u9593:', new Date(event.data.timestamp).toLocaleString()); // "Ê∏ÖÈô§?ÇÈ?:"
                // ?ØÈÅ∏ÔºöËá™?ïÈ??∞Ë??•Ô?Â¶ÇÊ?Ë∂ÖÈ?30ÁßíÊú™?∑Êñ∞Ôº?
                const timeSinceLoad = Date.now() - performance.timing.navigationStart;
                if (timeSinceLoad > 30000) {
                  console.log('[CACHE_SYNC] \u5efa\u8b70\u91cd\u65b0\u8f09\u5165\u4ee5\u7372\u53d6\u6700\u65b0\u7248\u672c'); // "Âª∫Ë≠∞?çÊñ∞ËºâÂÖ•‰ª•Áç≤?ñÊ??∞Á???
                  // ?ñÊ?Ë®ªÈ?‰ª•Â??®Ëá™?ïÈ??∞Ë???
                  // setTimeout(() => location.reload(), 2000);
                }
                break;
                
              case 'SW_ACTIVATED':
                console.log('[CACHE_SYNC] Service Worker \u5df2\u6fc0\u6d3b\uff0c\u7248\u672c:', event.data.version); // "Â∑≤Ê?Ê¥ªÔ??àÊú¨:"
                // Service Worker ÊøÄÊ¥ªÂ?ÔºåÈ??∞Ê™¢Ê∏¨‰?Ê¨?
                setTimeout(detectBrowserCacheClear, 1000);
                break;
            }
          });
          
          messageHandlerAttached = true;
        }
        
        // Á´ãÂç≥?óË©¶?ÑÂ?ÔºåÂ???Service Worker ?™Â∞±Á∑íÂ?Âª∂ÈÅ≤
        if (navigator.serviceWorker.controller) {
          attachMessageListener();
        } else {
          navigator.serviceWorker.ready.then(function() {
            attachMessageListener();
          }).catch(function(err) {
            console.warn('[CACHE_SYNC] \u7121\u6cd5\u9644\u52a0\u6d88\u606f\u76e3\u807d\u5668:', err); // "?°Ê??ÑÂ?Ê∂àÊÅØ??ÅΩ??"
          });
        }
      }
      
      // ?®Ë®≠ÁΩÆÊ?Ë®ò‰??çÂ?Ê™¢Ê∏¨ÔºàÈÅø?çÊ?Ë®òË¢´?çÊñ∞Ë®≠ÁΩÆ?åÊé©?ãÂ?È°åÔ?
      // Á´ãÂç≥Ê™¢Ê∏¨ÔºàÂ?Ê≠•Ê™¢Ê∏¨Ô?‰∏çÁ?ÂæÖÊ?Ë®òÂ?ÂßãÂ?Ôº?
      (function immediateDetection() {
        try {
          const hasLastCheck = !!localStorage.getItem(LAST_CACHE_CHECK_KEY);
          const hasSessionMarker = !!sessionStorage.getItem(SESSION_MARKER_KEY);
          
          // Â¶ÇÊ??©ËÄÖÈÉΩ‰∏çÂ??®Ô?Âº∑Á??∑Á??ØÊ??§Á∑©Â≠?
          if (!hasLastCheck && !hasSessionMarker) {
            console.log('[CACHE_SYNC] \u5728\u521d\u59cb\u5316\u524d\u6aa2\u6e2c\u5230\u7de8\u78bc\u6e05\u9664\uff0c\u5f37\u5236\u6e05\u9664\u5e76\u91cd\u65b0\u8f09\u5165'); // "?®Â?ÂßãÂ??çÊ™¢Ê∏¨Âà∞Á∑©Â?Ê∏ÖÈô§ÔºåÂº∑?∂Ê??§‰∏¶?çÊñ∞ËºâÂÖ•"
            forceClearAllCachesAndReload();
            return; // ?ªÊ≠¢ÂæåÁ??ùÂ???
          }
        } catch (error) {
          console.warn('[CACHE_SYNC] \u521d\u59cb\u5316\u524d\u6aa2\u6e2c\u5931\u6557:', error); // "?ùÂ??ñÂ?Ê™¢Ê∏¨Â§±Ê?:"
        }
      })();
      
      // ?ùÂ??ñÊ™¢Ê∏¨Ê?Ë®òÔ??ÅÈù¢ËºâÂÖ•?ÇÔ?
      initializeDetectionMarkers();
      
      // Á´ãÂç≥Ê™¢Ê∏¨Ôºà‰?Âª∂ÈÅ≤ÔºâÔ?Â¶ÇÊ?Ê™¢Ê∏¨?∞Ê?È°ØÁ?Á∑©Â?Ê∏ÖÈô§Ë°åÁÇ∫ÔºåÁ??≥Âº∑?∂Ê???
      // ‰ΩøÁî® requestIdleCallback ??setTimeout Á¢∫‰?‰∏çÈòªÂ°ûÈ??¢Ê∏≤??
      if (window.requestIdleCallback) {
        requestIdleCallback(function() {
          detectBrowserCacheClear(true); // ?≥ÂÖ• true Ë°®Á§∫Âº∑Âà∂?çÊñ∞ËºâÂÖ•Ê®°Â?
        }, { timeout: 100 });
      } else {
        setTimeout(function() {
          detectBrowserCacheClear(true); // ?≥ÂÖ• true Ë°®Á§∫Âº∑Âà∂?çÊñ∞ËºâÂÖ•Ê®°Â?
        }, 100);
      }
      
      // È°çÂ??ÑÊ™¢Ê∏¨Ô?Âª∂ÈÅ≤‰∏ÄÂ∞èÊÆµ?ÇÈ?Ôºå‰??∫Â??®Ê™¢Ê∏¨Ô?
      setTimeout(function() {
        detectBrowserCacheClear(false); // ?ÆÈÄöÊ™¢Ê∏¨Ê®°Âº?
      }, 1000);
      
      // ?™Â??ÑÂ??üÊ™¢Ê∏¨Ô?‰ΩøÁî®?ïÊ??ìÈ?ÔºåÊ?Â∞ë‰?ÂøÖË??ÑÊ™¢?•Ô?
      let lastCheckTime = Date.now();
      let checkInterval = 15000; // ?ùÂ?15Áß?
      
      function scheduleNextCheck() {
        const timeSinceLastCheck = Date.now() - lastCheckTime;
        // Â¶ÇÊ?Ë∑ùÈõ¢‰∏äÊ¨°Ê™¢Êü•Ë∂ÖÈ??æÂÄºÔ?Á´ãÂç≥Ê™¢Êü•ÔºõÂê¶?áÊ??ìÈ?Ê™¢Êü•
        if (timeSinceLastCheck >= DETECTION_THRESHOLD) {
          detectBrowserCacheClear();
          lastCheckTime = Date.now();
          checkInterval = 15000; // ?çÁΩÆ??5Áß?
        } else {
          checkInterval = Math.min(checkInterval * 1.5, 60000); // Êº∏ÈÄ≤Â??†Âà∞?ÄÂ§?0Áß?
        }
        
        setTimeout(scheduleNextCheck, checkInterval);
      }
      
      // ?üÂ??ïÊ?Ê™¢Ê∏¨
      scheduleNextCheck();
      
      // ??ÅΩ?ÅÈù¢?ØË??ßË??ñÔ??áÊ?Ê®ôÁ±§?ÅÊ?Ê™¢Ê∏¨Ôº?
      let visibilityCheckTimeout = null;
      document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
          // ?≤Ê?ÔºöÈÅø?çÈ†ªÁπÅÊ™¢??
          if (visibilityCheckTimeout) clearTimeout(visibilityCheckTimeout);
          visibilityCheckTimeout = setTimeout(function() {
            detectBrowserCacheClear();
            lastCheckTime = Date.now();
          }, 1000); // 1ÁßíÂ?Ê™¢Êü•
        }
      });
      
      // ??ÅΩ focus ‰∫ã‰ª∂ÔºàÁ???ç≤ÂæóÁÑ¶ÈªûÊ?Ê™¢Ê∏¨ÔºåÈò≤?ñË??ÜÔ?
      let focusCheckTimeout = null;
      window.addEventListener('focus', function() {
        if (focusCheckTimeout) clearTimeout(focusCheckTimeout);
        focusCheckTimeout = setTimeout(function() {
          detectBrowserCacheClear();
          lastCheckTime = Date.now();
        }, 500); // 0.5ÁßíÂ?Ê™¢Êü•
      });
      
      // ??ÅΩ beforeunloadÔºàÈ??¢È??âÂ?‰øùÂ??Ä?ãÔ?
      window.addEventListener('beforeunload', function() {
        try {
          localStorage.setItem(LAST_CACHE_CHECK_KEY, Date.now().toString());
        } catch (e) {
          // ÂøΩÁï•?ØË™§
        }
      });
      
      // Âº∑Âà∂?¥Êñ∞ Service WorkerÔºàÊ?Ê¨°È??¢Ë??•ÈÉΩÊ™¢Êü•Ôº?
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(async function(regs) {
          console.log('[SW_UPDATE] \u627e\u5230', regs.length, '\u500b Service Worker \u8a3b\u518a'); // "?æÂà∞ X ??Service Worker Ë®ªÂ?"
          for (const reg of regs) {
            try {
              console.log('[SW_UPDATE] \u66f4\u65b0 Service Worker:', reg.scope); // "?¥Êñ∞ Service Worker:"
              await reg.update();
              
              // Â¶ÇÊ??âÁ?ÂæÖ‰∏≠??Service WorkerÔºåÁ??≥Ê?Ê¥?
              if (reg.waiting) {
                console.log('[SW_UPDATE] \u767c\u73fe\u7b49\u5f85\u4e2d\u7684 Service Worker\uff0c\u767c\u9001 SKIP_WAITING \u6d88\u606f'); // "?ºÁèæÁ≠âÂ?‰∏≠Á? Service WorkerÔºåÁôº??SKIP_WAITING Ê∂àÊÅØ"
                reg.waiting.postMessage({ type: 'SKIP_WAITING' });
              }
              
              // ??ÅΩ?¥Êñ∞‰∫ã‰ª∂
              reg.addEventListener('updatefound', function() {
                const newWorker = reg.installing;
                if (newWorker) {
                  console.log('[SW_UPDATE] \u767c\u73fe\u65b0\u7684 Service Worker\uff0c\u72c0\u614b:', newWorker.state); // "?ºÁèæ?∞Á? Service WorkerÔºåÁ???"
                  newWorker.addEventListener('statechange', function() {
                    console.log('[SW_UPDATE] Service Worker \u72c0\u614b\u8b8a\u66f4:', newWorker.state); // "?Ä?ãË???"
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                      console.log('[SW_UPDATE] \u65b0 Service Worker \u5df2\u5b89\u88dd\uff0c\u6e96\u5099\u6fc0\u6d3b'); // "??Service Worker Â∑≤Â?Ë£ùÔ?Ê∫ñÂ?ÊøÄÊ¥?
                      newWorker.postMessage({ type: 'SKIP_WAITING' });
                      // ?™Â??çÊñ∞ËºâÂÖ•
                      setTimeout(() => {
                        console.log('[SW_UPDATE] \u81ea\u52d5\u91cd\u65b0\u8f09\u5165\u4ee5\u61c9\u7528\u66f4\u65b0'); // "?™Â??çÊñ∞ËºâÂÖ•‰ª•Ê??®Êõ¥??
                        location.reload();
                      }, 1000);
                    }
                  });
                }
              });
            } catch (err) {
              console.warn('[SW_UPDATE] Service Worker \u66f4\u65b0\u5931\u6557:', err); // "?¥Êñ∞Â§±Ê?:"
            }
          }
        }).catch(err => {
          console.error('[SW_UPDATE] \u7372\u53d6 Service Worker \u8a3b\u518a\u5931\u6557:', err); // "?≤Â? Service Worker Ë®ªÂ?Â§±Ê?:"
        });
      }

      // Create update banner lazily
      let bannerEl;
      function showUpdateBanner() {
        if (!bannerEl) {
          bannerEl = document.createElement('div');
          bannerEl.id = 'update-banner';
          
          // ‰ΩøÁî® createElement ??textContent ?øÂ?Â≠óÁ¨¶Á∑®Á¢º?èÈ?
          const span = document.createElement('span');
          span.textContent = '\u6709\u65b0\u7248\u672c\u53ef\u7528'; // "?âÊñ∞?àÊú¨?ØÁî®"
          
          const btn = document.createElement('button');
          btn.id = 'update-reload-btn';
          btn.textContent = '\u7acb\u5373\u5237\u65b0'; // "Á´ãÂç≥?∑Êñ∞"
          btn.addEventListener('click', function() {
            try { navigator.serviceWorker && navigator.serviceWorker.getRegistration().then(r => r && r.update()); } catch(_) {}
            location.reload();
          });
          
          bannerEl.appendChild(span);
          bannerEl.appendChild(btn);
          document.body.appendChild(bannerEl);
        }
        bannerEl.style.display = 'block';
      }

      // Persist version and detect changes across visits
      try {
        const prev = localStorage.getItem(VERSION_KEY);
        if (prev && prev !== versionMeta) {
          // Version changed -> try to refresh SW and prompt user to reload
          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistration().then(function(reg) {
              if (reg) {
                try { reg.update(); } catch(_) {}
                if (reg.waiting) {
                  try { reg.waiting.postMessage({ type: 'SKIP_WAITING' }); } catch(_) {}
                }
                reg.addEventListener('updatefound', function() {
                  const nw = reg.installing;
                  if (nw) {
                    nw.addEventListener('statechange', function() {
                      if (nw.state === 'installed') {
                        showUpdateBanner();
                      }
                    });
                  }
                });
              }
            });
          }
          showUpdateBanner();
        }
        localStorage.setItem(VERSION_KEY, versionMeta);
      } catch(_) {}

      // Auto-reload once updated SW takes control
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.addEventListener('controllerchange', function() {
          location.reload();
        });
      }
    })();
  </script>
</body>
</html>


























































