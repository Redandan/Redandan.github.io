<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Push è¨ºæ–·æ¸¬è©¦ - AgoraMarket</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Web Push è¨ºæ–·æ¸¬è©¦</h1>
        <p>é€™å€‹é é¢ç”¨æ–¼è¨ºæ–· Web Push åŠŸèƒ½çš„å„å€‹çµ„ä»¶æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚</p>
        
        <div class="test-section">
            <h2>1. ç€è¦½å™¨ç’°å¢ƒæª¢æŸ¥</h2>
            <div id="browserCheck"></div>
            <button onclick="checkBrowserSupport()">æª¢æŸ¥ç€è¦½å™¨æ”¯æ´</button>
        </div>
        
        <div class="test-section">
            <h2>2. Service Worker æ¸¬è©¦</h2>
            <div id="serviceWorkerCheck"></div>
            <button onclick="testServiceWorker()">æ¸¬è©¦ Service Worker</button>
        </div>
        
        <div class="test-section">
            <h2>3. é€šçŸ¥æ¬Šé™æ¸¬è©¦</h2>
            <div id="notificationCheck"></div>
            <button onclick="testNotificationPermission()">æ¸¬è©¦é€šçŸ¥æ¬Šé™</button>
        </div>
        
        <div class="test-section">
            <h2>4. VAPID Key æ¸¬è©¦</h2>
            <div id="vapidCheck"></div>
            <input type="text" id="vapidKeyInput" placeholder="è¼¸å…¥ VAPID Key" style="width: 100%; margin: 10px 0;">
            <button onclick="testVapidKey()">æ¸¬è©¦ VAPID Key</button>
        </div>
        
        <div class="test-section">
            <h2>5. å®Œæ•´æµç¨‹æ¸¬è©¦</h2>
            <div id="fullFlowCheck"></div>
            <button onclick="testFullFlow()">æ¸¬è©¦å®Œæ•´æµç¨‹</button>
        </div>
        
        <div class="test-section">
            <h2>6. æ—¥èªŒè¼¸å‡º</h2>
            <pre id="logOutput"></pre>
            <button onclick="clearLogs()">æ¸…é™¤æ—¥èªŒ</button>
        </div>
    </div>

    <script>
        // æ—¥èªŒè¼¸å‡º
        function log(message, type = 'info') {
            const logOutput = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            logOutput.textContent += logEntry;
            logOutput.scrollTop = logOutput.scrollHeight;
            console.log(message);
        }

        function clearLogs() {
            document.getElementById('logOutput').textContent = '';
        }

        // 1. ç€è¦½å™¨ç’°å¢ƒæª¢æŸ¥
        function checkBrowserSupport() {
            const result = document.getElementById('browserCheck');
            result.innerHTML = '';
            
            log('ğŸ” é–‹å§‹ç€è¦½å™¨ç’°å¢ƒæª¢æŸ¥...');
            
            const checks = [
                { name: 'Service Worker', supported: 'serviceWorker' in navigator },
                { name: 'Push Manager', supported: 'PushManager' in window },
                { name: 'Notification', supported: 'Notification' in window },
                { name: 'HTTPS/HTTP', supported: window.location.protocol === 'https:' || window.location.hostname === 'localhost' },
                { name: 'User Agent', supported: true, value: navigator.userAgent }
            ];
            
            checks.forEach(check => {
                const div = document.createElement('div');
                div.className = `test-result ${check.supported ? 'success' : 'error'}`;
                div.innerHTML = `${check.supported ? 'âœ…' : 'âŒ'} ${check.name}: ${check.value || (check.supported ? 'æ”¯æ´' : 'ä¸æ”¯æ´')}`;
                result.appendChild(div);
                
                log(`${check.supported ? 'âœ…' : 'âŒ'} ${check.name}: ${check.value || (check.supported ? 'æ”¯æ´' : 'ä¸æ”¯æ´')}`);
            });
        }

        // 2. Service Worker æ¸¬è©¦
        async function testServiceWorker() {
            const result = document.getElementById('serviceWorkerCheck');
            result.innerHTML = '';
            
            log('ğŸ” é–‹å§‹ Service Worker æ¸¬è©¦...');
            
            try {
                // æª¢æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
                const response = await fetch('/service-worker.js');
                if (response.ok) {
                    const div = document.createElement('div');
                    div.className = 'test-result success';
                    div.innerHTML = 'âœ… Service Worker æ–‡ä»¶å­˜åœ¨ä¸”å¯è¨ªå•';
                    result.appendChild(div);
                    log('âœ… Service Worker æ–‡ä»¶å­˜åœ¨ä¸”å¯è¨ªå•');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                // å˜—è©¦è¨»å†Š
                const registration = await navigator.serviceWorker.register('/service-worker.js');
                const div2 = document.createElement('div');
                div2.className = 'test-result success';
                div2.innerHTML = 'âœ… Service Worker è¨»å†ŠæˆåŠŸ';
                result.appendChild(div2);
                log('âœ… Service Worker è¨»å†ŠæˆåŠŸ');
                
                await navigator.serviceWorker.ready;
                const div3 = document.createElement('div');
                div3.className = 'test-result success';
                div3.innerHTML = 'âœ… Service Worker æº–å‚™å°±ç·’';
                result.appendChild(div3);
                log('âœ… Service Worker æº–å‚™å°±ç·’');
                
            } catch (error) {
                const div = document.createElement('div');
                div.className = 'test-result error';
                div.innerHTML = `âŒ Service Worker æ¸¬è©¦å¤±æ•—: ${error.message}`;
                result.appendChild(div);
                log(`âŒ Service Worker æ¸¬è©¦å¤±æ•—: ${error.message}`);
            }
        }

        // 3. é€šçŸ¥æ¬Šé™æ¸¬è©¦
        async function testNotificationPermission() {
            const result = document.getElementById('notificationCheck');
            result.innerHTML = '';
            
            log('ğŸ” é–‹å§‹é€šçŸ¥æ¬Šé™æ¸¬è©¦...');
            
            try {
                const currentPermission = Notification.permission;
                const div1 = document.createElement('div');
                div1.className = 'test-result info';
                div1.innerHTML = `ğŸ“‹ ç•¶å‰æ¬Šé™ç‹€æ…‹: ${currentPermission}`;
                result.appendChild(div1);
                log(`ğŸ“‹ ç•¶å‰æ¬Šé™ç‹€æ…‹: ${currentPermission}`);
                
                if (currentPermission === 'default') {
                    const permission = await Notification.requestPermission();
                    const div2 = document.createElement('div');
                    div2.className = `test-result ${permission === 'granted' ? 'success' : 'warning'}`;
                    div2.innerHTML = `ğŸ“‹ æ¬Šé™è«‹æ±‚çµæœ: ${permission}`;
                    result.appendChild(div2);
                    log(`ğŸ“‹ æ¬Šé™è«‹æ±‚çµæœ: ${permission}`);
                }
                
            } catch (error) {
                const div = document.createElement('div');
                div.className = 'test-result error';
                div.innerHTML = `âŒ é€šçŸ¥æ¬Šé™æ¸¬è©¦å¤±æ•—: ${error.message}`;
                result.appendChild(div);
                log(`âŒ é€šçŸ¥æ¬Šé™æ¸¬è©¦å¤±æ•—: ${error.message}`);
            }
        }

        // 4. VAPID Key æ¸¬è©¦
        function testVapidKey() {
            const result = document.getElementById('vapidCheck');
            const vapidKey = document.getElementById('vapidKeyInput').value;
            result.innerHTML = '';
            
            log('ğŸ” é–‹å§‹ VAPID Key æ¸¬è©¦...');
            
            if (!vapidKey) {
                const div = document.createElement('div');
                div.className = 'test-result error';
                div.innerHTML = 'âŒ è«‹è¼¸å…¥ VAPID Key';
                result.appendChild(div);
                log('âŒ è«‹è¼¸å…¥ VAPID Key');
                return;
            }
            
            try {
                // æª¢æŸ¥æ ¼å¼
                const base64UrlPattern = /^[A-Za-z0-9_-]+$/;
                if (!base64UrlPattern.test(vapidKey)) {
                    throw new Error('VAPID Key æ ¼å¼ä¸æ­£ç¢ºï¼Œæ‡‰ç‚º Base64 URL Safe æ ¼å¼');
                }
                
                const div1 = document.createElement('div');
                div1.className = 'test-result success';
                div1.innerHTML = `âœ… VAPID Key æ ¼å¼æ­£ç¢ºï¼Œé•·åº¦: ${vapidKey.length}`;
                result.appendChild(div1);
                log(`âœ… VAPID Key æ ¼å¼æ­£ç¢ºï¼Œé•·åº¦: ${vapidKey.length}`);
                
                // å˜—è©¦è½‰æ›
                const uint8Array = urlBase64ToUint8Array(vapidKey);
                const div2 = document.createElement('div');
                div2.className = 'test-result success';
                div2.innerHTML = `âœ… VAPID Key è½‰æ›æˆåŠŸï¼Œå­—ç¯€é•·åº¦: ${uint8Array.length}`;
                result.appendChild(div2);
                log(`âœ… VAPID Key è½‰æ›æˆåŠŸï¼Œå­—ç¯€é•·åº¦: ${uint8Array.length}`);
                
                // æª¢æŸ¥é•·åº¦
                if (uint8Array.length !== 65) {
                    const div3 = document.createElement('div');
                    div3.className = 'test-result warning';
                    div3.innerHTML = `âš ï¸ VAPID Key é•·åº¦ç•°å¸¸ï¼ŒæœŸæœ› 65 å­—ç¯€ï¼Œå¯¦éš›: ${uint8Array.length}`;
                    result.appendChild(div3);
                    log(`âš ï¸ VAPID Key é•·åº¦ç•°å¸¸ï¼ŒæœŸæœ› 65 å­—ç¯€ï¼Œå¯¦éš›: ${uint8Array.length}`);
                }
                
            } catch (error) {
                const div = document.createElement('div');
                div.className = 'test-result error';
                div.innerHTML = `âŒ VAPID Key æ¸¬è©¦å¤±æ•—: ${error.message}`;
                result.appendChild(div);
                log(`âŒ VAPID Key æ¸¬è©¦å¤±æ•—: ${error.message}`);
            }
        }

        // 5. å®Œæ•´æµç¨‹æ¸¬è©¦
        async function testFullFlow() {
            const result = document.getElementById('fullFlowCheck');
            result.innerHTML = '';
            
            log('ğŸ” é–‹å§‹å®Œæ•´æµç¨‹æ¸¬è©¦...');
            
            try {
                // æª¢æŸ¥æ‰€æœ‰å‰ç½®æ¢ä»¶
                if (!('serviceWorker' in navigator) || !('PushManager' in window) || !('Notification' in window)) {
                    throw new Error('ç€è¦½å™¨ä¸æ”¯æ´ Web Push');
                }
                
                const div1 = document.createElement('div');
                div1.className = 'test-result success';
                div1.innerHTML = 'âœ… ç€è¦½å™¨æ”¯æ´æª¢æŸ¥é€šé';
                result.appendChild(div1);
                log('âœ… ç€è¦½å™¨æ”¯æ´æª¢æŸ¥é€šé');
                
                // è¨»å†Š Service Worker
                const registration = await navigator.serviceWorker.register('/service-worker.js');
                await navigator.serviceWorker.ready;
                
                const div2 = document.createElement('div');
                div2.className = 'test-result success';
                div2.innerHTML = 'âœ… Service Worker è¨»å†ŠæˆåŠŸ';
                result.appendChild(div2);
                log('âœ… Service Worker è¨»å†ŠæˆåŠŸ');
                
                // æª¢æŸ¥é€šçŸ¥æ¬Šé™
                if (Notification.permission !== 'granted') {
                    const permission = await Notification.requestPermission();
                    if (permission !== 'granted') {
                        throw new Error('é€šçŸ¥æ¬Šé™è¢«æ‹’çµ•');
                    }
                }
                
                const div3 = document.createElement('div');
                div3.className = 'test-result success';
                div3.innerHTML = 'âœ… é€šçŸ¥æ¬Šé™å·²æˆäºˆ';
                result.appendChild(div3);
                log('âœ… é€šçŸ¥æ¬Šé™å·²æˆäºˆ');
                
                // æ¸¬è©¦æ¨é€è¨‚é–±ï¼ˆéœ€è¦ VAPID Keyï¼‰
                const vapidKey = document.getElementById('vapidKeyInput').value;
                if (vapidKey) {
                    const subscription = await registration.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: urlBase64ToUint8Array(vapidKey)
                    });
                    
                    const div4 = document.createElement('div');
                    div4.className = 'test-result success';
                    div4.innerHTML = 'âœ… æ¨é€è¨‚é–±å‰µå»ºæˆåŠŸ';
                    result.appendChild(div4);
                    log('âœ… æ¨é€è¨‚é–±å‰µå»ºæˆåŠŸ');
                    log(`ğŸ“‹ è¨‚é–±ç«¯é»: ${subscription.endpoint}`);
                    
                    // å–æ¶ˆè¨‚é–±
                    await subscription.unsubscribe();
                    const div5 = document.createElement('div');
                    div5.className = 'test-result success';
                    div5.innerHTML = 'âœ… æ¨é€è¨‚é–±å–æ¶ˆæˆåŠŸ';
                    result.appendChild(div5);
                    log('âœ… æ¨é€è¨‚é–±å–æ¶ˆæˆåŠŸ');
                } else {
                    const div4 = document.createElement('div');
                    div4.className = 'test-result warning';
                    div4.innerHTML = 'âš ï¸ è·³éæ¨é€è¨‚é–±æ¸¬è©¦ï¼ˆéœ€è¦ VAPID Keyï¼‰';
                    result.appendChild(div4);
                    log('âš ï¸ è·³éæ¨é€è¨‚é–±æ¸¬è©¦ï¼ˆéœ€è¦ VAPID Keyï¼‰');
                }
                
                const divFinal = document.createElement('div');
                divFinal.className = 'test-result success';
                divFinal.innerHTML = 'ğŸ‰ å®Œæ•´æµç¨‹æ¸¬è©¦é€šéï¼';
                result.appendChild(divFinal);
                log('ğŸ‰ å®Œæ•´æµç¨‹æ¸¬è©¦é€šéï¼');
                
            } catch (error) {
                const div = document.createElement('div');
                div.className = 'test-result error';
                div.innerHTML = `âŒ å®Œæ•´æµç¨‹æ¸¬è©¦å¤±æ•—: ${error.message}`;
                result.appendChild(div);
                log(`âŒ å®Œæ•´æµç¨‹æ¸¬è©¦å¤±æ•—: ${error.message}`);
            }
        }

        // å·¥å…·å‡½æ•¸ï¼šURL Base64 è½‰ Uint8Array
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/-/g, '+')
                .replace(/_/g, '/');

            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);

            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•åŸ·è¡ŒåŸºæœ¬æª¢æŸ¥
        window.addEventListener('load', () => {
            log('ğŸš€ Web Push è¨ºæ–·æ¸¬è©¦é é¢è¼‰å…¥å®Œæˆ');
            checkBrowserSupport();
        });
    </script>
</body>
</html>
